<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åº“å­˜ç®¡ç†ç³»ç»Ÿ - æ•°æ®åº“ç‰ˆ</title>
    <style>
        :root {
            --primary-color: #ffffff;
            --secondary-color: #f8f9fa;
            --accent-color: #3498db;
            --warning-color: #e74c3c;
            --success-color: #2ecc71;
            --text-color: #2c3e50;
            --border-color: #dee2e6;
            --card-bg: #ffffff;
            --sidebar-bg: #ffffff;
            --sidebar-text: #000000;
            --highlight-color: #fff3cd;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--secondary-color);
            color: var(--text-color);
            min-height: 100vh;
            font-size: 0.9rem;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        /* ç™»å½•é¡µé¢æ ·å¼ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .login-form {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border-color);
        }
        
        .login-form h2 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--accent-color);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--primary-color);
            color: var(--text-color);
        }
        
        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            font-size: 0.9rem;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        /* ä¸»ç•Œé¢æ ·å¼ */
       .header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
    background-color: var(--primary-color);
    padding: 0.8rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    border-bottom: 1px solid var(--border-color);
}
        
       .sidebar {
    width: 160px;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    padding: 1.5rem 0;
    height: calc(100vh - 60px); /* å‡å»headeré«˜åº¦ */
    position: fixed;
    left: 0;
    top: 60px; /* ä»headerä¸‹é¢å¼€å§‹ */
    box-shadow: 3px 0 15px rgba(0, 0, 0, 0.08);
    border-right: 1px solid #e9ecef;
    transform: perspective(1000px) rotateY(-3deg);
    transform-origin: left center;
    transition: all 0.3s ease;
    z-index: 999;
}
        
        .sidebar:hover {
            transform: perspective(1000px) rotateY(0deg);
        }

        .main-content {
            margin-left: 120px;
            padding: 1.2rem;
            flex: 1;
        }
        
        .nav-item {
            padding: 0.7rem 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--sidebar-text);
            font-size: 0.9rem;
            position: relative;
            border-left: 3px solid transparent;
            margin: 2px 5px;
            border-radius: 4px;
        }
        
        .nav-item:hover, .nav-item.active {
            background-color: rgba(52, 152, 219, 0.1);
            border-left: 4px solid var(--accent-color);
            transform: translateX(5px) scale(1.02);
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -3px;
            width: 3px;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(255,255,255,0.2));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .nav-item:hover::before {
            opacity: 1;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 6px;
            padding: 1.2rem;
            margin-bottom: 1.2rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.7rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.2rem;
            margin-bottom: 1.2rem;
        }
        
        .stat-card {
            background-color: var(--card-bg);
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }
        
        .stat-value {
            font-size: 1.6rem;
            font-weight: bold;
            margin: 0.5rem 0;
            color: var(--accent-color);
        }
        
        .warning {
            color: var(--warning-color);
        }
        
        .success {
            color: var(--success-color);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.85rem;
        }
        
        th, td {
            padding: 0.6rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background-color: var(--secondary-color);
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        th.sortable:hover {
            background-color: #e9ecef;
        }
        
        th.sorted-asc::after {
            content: " â–²";
            font-size: 0.7rem;
            color: var(--accent-color);
        }
        
        th.sorted-desc::after {
            content: " â–¼";
            font-size: 0.7rem;
            color: var(--accent-color);
        }
        
        tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .low-stock {
            background-color: rgba(231, 76, 60, 0.05);
        }
        
        .over-stock {
            background-color: rgba(241, 196, 15, 0.05);
        }
        
        .in-transit {
            background-color: rgba(155, 89, 182, 0.05);
        }
        
        .hidden {
            display: none !important;
        }
        
        .user-menu {
            position: relative;
            display: inline-block;
        }
        
        .user-menu-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: var(--card-bg);
            min-width: 140px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        
        .user-menu:hover .user-menu-content {
            display: block;
        }
        
        .user-menu-item {
            padding: 10px 14px;
            display: block;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .user-menu-item:hover {
            background-color: var(--secondary-color);
        }
        
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(52, 152, 219, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000 !important;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 6px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .search-container {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            position: relative;
        }
        
        /* æœç´¢ä¸‹æ‹‰æ¡†æ ·å¼ä¼˜åŒ– */
.search-input-container {
    position: relative;
    width: 100%;
    margin-bottom: 8px; /* å‡å°‘ä¸‹è¾¹è· */
}

        .search-container input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--primary-color);
            color: var(--text-color);
            font-size: 0.9rem;
        }
        
        .search-container select {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--primary-color);
            color: var(--text-color);
            font-size: 0.9rem;
        }
        
#product-search-input {
    width: 100%;
    padding: 6px 10px; /* è°ƒæ•´å†…è¾¹è· */
    font-size: 0.85rem; /* ç¨å¾®ç¼©å°å­—ä½“ */
    border: 1px solid #ddd;
    border-radius: 4px;
}

.dialog-buttons {
    display: flex;
    gap: 8px;
    margin-top: 8px; /* å‡å°‘ä¸Šè¾¹è· */
}

.dialog-buttons .btn-sm {
    padding: 5px 10px; /* è°ƒæ•´æŒ‰é’®å†…è¾¹è· */
    font-size: 0.8rem; /* è°ƒæ•´æŒ‰é’®å­—ä½“å¤§å° */
}

/* å›¾ä¾‹è¯´æ˜åŒºåŸŸä¼˜åŒ– */
.location-control-section:last-child {
    height: 130px; /* é™ä½é«˜åº¦ */
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 6px; /* å‡å°‘é—´è· */
    font-size: 0.75rem; /* ç¼©å°å­—ä½“ */
}

.location-control-section p {
    font-size: 0.7rem; /* ç¼©å°æç¤ºæ–‡å­— */
    margin-top: 5px;
    line-height: 1.2;
}

/* å½“å‰åº“ä½æ˜¾ç¤ºä¼˜åŒ– */
#current-location-display {
    font-size: 0.75rem; /* ç¼©å°å­—ä½“ */
    padding: 3px 6px; /* è°ƒæ•´å†…è¾¹è· */
}

#inventory-search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    z-index: 1000;
    max-height: 200px;
    overflow-y: auto;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border: 1px solid #ddd;
    border-top: none;
    display: none;
    border-radius: 0 0 4px 4px;
}

#inventory-search-results .search-result-item {
    padding: 8px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    font-size: 0.8rem;
    transition: background-color 0.2s;
}

#inventory-search-results .search-result-item:hover {
    background: #e3f2fd;
}

#inventory-search-results .search-result-item.selected {
    background: #bbdefb;
    border-left: 3px solid #2196f3;
}


        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }
        
        .login-error {
            color: red;
            margin-top: 10px;
            display: none;
            text-align: center;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                transform: none;
                width: 100%;
                height: auto;
                position: static;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }
            
            .main-content {
                margin-left: 0;
                margin-top: 60px; /* ç§»åŠ¨ç«¯ä¹Ÿä¿æŒé¡¶éƒ¨è¾¹è· */
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
        }

        /* åº“å­˜é‡‘é¢åˆ—æ ·å¼ */
        .stock-value-column {
            transition: all 0.3s ease;
        }
        
        .stock-value-column.hidden {
            display: none !important;
        }

        /* FIFOé«˜äº®æ ·å¼ */
        .fifo-highlight {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107 !important;
            animation: fifo-pulse 2s infinite;
        }

        .fifo-highlight td {
            font-weight: bold;
            color: #856404 !important;
        }

        @keyframes fifo-pulse {
            0% { 
                background-color: rgba(255, 243, 205, 0.8);
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
            }
            50% { 
                background-color: rgba(255, 243, 205, 1);
                box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
            }
            100% { 
                background-color: rgba(255, 243, 205, 0.8);
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
            }
        }

        /* è´¨ä¿æœŸè­¦å‘Šæ ·å¼ */
        .warranty-expired {
            background-color: rgba(231, 76, 60, 0.2) !important;
            border-left: 4px solid #e74c3c !important;
        }

        .warranty-expired td {
            color: #c0392b !important;
            font-weight: bold !important;
        }

        .warranty-expiring {
            background-color: rgba(241, 196, 15, 0.2) !important;
            border-left: 4px solid #f1c40f !important;
        }

        .warranty-expiring td {
            color: #8e6c0a !important;
            font-weight: bold !important;
        }

        /* æŠ˜å /å±•å¼€åŠ¨ç”» */
        .collapsible-content {
            transition: all 0.3s ease-in-out;
            overflow: hidden;
        }

        .collapsible-content.hidden {
            max-height: 0;
            opacity: 0;
        }

        .collapsible-content:not(.hidden) {
            max-height: 1000px;
            opacity: 1;
        }

        /* åº“ä½ç®¡ç†æ ·å¼ */
        .location-controls-panel {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
    min-height: 140px; /* é™åˆ¶æœ€å°é«˜åº¦ */
    height: auto; /* è‡ªé€‚åº”é«˜åº¦ */
}

        .location-control-section {
    display: flex;
    flex-direction: column;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background: white;
    height: 130px; /* é™ä½é«˜åº¦ */
    justify-content: space-between; /* å‡åŒ€åˆ†å¸ƒå†…éƒ¨å…ƒç´  */
}

/* æœç´¢äº§å“åŒºåŸŸä¼˜åŒ– */
.location-control-section:first-child {
    height: 130px; /* é™ä½é«˜åº¦ */
}

.location-control-section h4 {
    margin-bottom: 8px; /* å‡å°‘æ ‡é¢˜ä¸‹è¾¹è· */
    font-size: 0.95rem; /* ç¨å¾®ç¼©å°æ ‡é¢˜å­—ä½“ */
}

        .shelf-visualization {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            overflow: auto;
            position: relative;
            height: calc(100vh - 300px);
            min-height: 400px;
        }

        .shelves-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .shelf {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            position: relative;
        }

        .shelf-header {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }

        .shelf-levels {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .shelf-level {
            background: #e9e9e9;
            border: 1px solid #ccc;
            border-radius: 4px;
            min-height: 70px !important;
            padding: 6px !important;
        }

        .level-header {
            font-size: 12px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .slots-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 3px !important;
        }

        .slot {
            background: white;
            border: 1px solid #bbb;
            border-radius: 3px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            z-index: 1;
        }

        .slot:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .slot.occupied {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .slot.selected {
            background: #bbdefb;
            border: 2px solid #2196f3;
            z-index: 10;
        }

        .slot.highlight {
            background-color: #fff3cd !important;
            border: 2px solid #ffc107 !important;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
        }

        .product-info {
            font-size: 9px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
            padding: 0 2px;
        }

        .legend-color {
            width: 14px;/* ç¨å¾®ç¼©å°å›¾ä¾‹é¢œè‰²å— */
            height: 14px;
            margin-right: 6px; /* å‡å°‘å³è¾¹è· */
            border: 1px solid #bbb;
            border-radius: 2px;
        }

        /* æœç´¢ä¸‹æ‹‰æ¡†æ ·å¼ */
       .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid #ddd;
            border-top: none;
            display: none;
            border-radius: 0 0 4px 4px;
        }

        .search-result-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s;
        }

       .search-result-item:hover {
            background: #e3f2fd;
        }

        .search-result-item.selected {
            background: #bbdefb;
            border-left: 3px solid #2196f3;
        }

        /* æ‰‹åŠ¨å…³è”æ¨¡æ€æ¡†æ ·å¼ */
        .manual-assignment-modal .product-list-container,
        .manual-assignment-modal .location-list-container {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 5px;
            display: none;
            position: absolute;
            width: 100%;
            background: white;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .manual-assignment-modal .product-item,
        .manual-assignment-modal .location-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }
        
        .manual-assignment-modal .product-item:hover,
        .manual-assignment-modal .location-item:hover {
            background-color: #f0f0f0;
        }
        
        .manual-assignment-modal .product-item.selected,
        .manual-assignment-modal .location-item.selected {
            background-color: #e3f2fd;
            border-left: 3px solid #2196f3;
        }
        
        .manual-assignment-modal .location-item.occupied {
            background-color: #f8f9fa !important;
            color: #6c757d !important;
            cursor: not-allowed !important;
        }

        /* è´§æ¶é…ç½®æ¨¡æ€æ¡†æ ·å¼ */
        .shelf-config-modal .config-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }

        .shelf-config-modal .shelf-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        .shelf-config-modal .level-config {
            margin-left: 20px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
        }

        .shelf-config-modal .level-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
/* æ·»åŠ é¢„è§ˆè´§æ¶é…ç½®æ¨¡æ€æ¡†æ ·å¼ */
.shelf-preview {
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 10px;
    min-height: 150px;
    max-height: 200px;
    overflow-y: auto;
}

.preview-shelf {
    margin-bottom: 15px;
    padding: 10px;
    border: 1px solid #eee;
    border-radius: 4px;
}

.preview-shelf.active {
    border: 2px solid #3498db;
    background: #f8f9fa;
}

.preview-shelf-header {
    font-weight: bold;
    margin-bottom: 5px;
    display: flex;
    justify-content: space-between;
}

.preview-levels {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}

.preview-level {
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 3px;
    padding: 5px;
    font-size: 0.8rem;
    flex: 1;
    min-width: 120px;
}

.preview-slots {
    display: flex;
    flex-wrap: wrap;
    gap: 2px;
    margin-top: 3px;
}

.preview-slot {
    display: inline-block;
    width: 12px;
    height: 12px;
    background: #e0e0e0;
    border: 1px solid #bbb;
    border-radius: 2px;
    margin: 1px;
}

.preview-slot.occupied {
    background: #bbdefb;
    border-color: #2196f3;
}

 /* å¯¼èˆªæ ä¼˜åŒ– */
        .sidebar {
            width: 160px; /* ç¨å¾®åŠ å®½ */
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 1.5rem 0;
            height: calc(100vh - 60px);
            position: fixed;
            left: 0;
            top: 60px;
            box-shadow: 3px 0 15px rgba(0, 0, 0, 0.08);
            border-right: 1px solid #e9ecef;
            transform: perspective(1000px) rotateY(-3deg);
            transform-origin: left center;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .sidebar:hover {
            transform: perspective(1000px) rotateY(0deg);
            box-shadow: 5px 0 20px rgba(0, 0, 0, 0.1);
        }

       /* è°ƒæ•´ä¸»å†…å®¹åŒºåŸŸ */
.main-content {
    margin-left: 160px;
    margin-top: 60px; /* æ·»åŠ é¡¶éƒ¨è¾¹è· */
    padding: 1.5rem;
    flex: 1;
}


        .nav-item {
            padding: 0.85rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--sidebar-text);
            font-size: 0.9rem;
            position: relative;
            border-left: 4px solid transparent;
            margin: 3px 8px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .nav-item:hover, .nav-item.active {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(52, 152, 219, 0.05) 100%);
            border-left: 4px solid var(--accent-color);
            transform: translateX(5px) scale(1.02);
            box-shadow: 2px 2px 12px rgba(0, 0, 0, 0.08);
            color: var(--accent-color);
        }

        /* åº“å­˜é¢„è­¦ç•Œé¢ä¼˜åŒ– */
        .alert-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            align-items: center;
        }

/* ä¿®å¤é¢„è­¦ç®¡ç†æŒ‰é’®æ ·å¼ */
#add-alert-product,
#import-alert-config, 
#export-alert-config {
    background-color: var(--accent-color) !important;
    color: white !important;
    border: 1px solid var(--accent-color) !important;
}

#add-alert-product:hover,
#import-alert-config:hover,
#export-alert-config:hover {
    background-color: #2980b9 !important;
    color: white !important;
}

/* ä¿®å¤çŠ¶æ€ç­›é€‰æŒ‰é’®æ ·å¼ */
.status-filter-btn {
    background-color: #f8f9fa !important;
    color: #2c3e50 !important; /* é»‘è‰²æ–‡å­— */
    border: 1px solid #dee2e6 !important;
}

.status-filter-btn:hover {
    background-color: #e9ecef !important;
    color: #2c3e50 !important;
}

.status-filter-btn.active {
    background-color: var(--accent-color) !important;
    color: white !important;
    border-color: var(--accent-color) !important;
}

/* ä¿®å¤ä½åº“å­˜æŒ‰é’®çš„ç‰¹æ®Šé¢œè‰² */
.status-filter-btn.low-stock.active {
    background-color: var(--warning-color) !important;
    border-color: var(--warning-color) !important;
    color: white !important;
}

/* ä¿®å¤é«˜åº“å­˜æŒ‰é’®çš„ç‰¹æ®Šé¢œè‰² */
.status-filter-btn.high-stock.active {
    background-color: #f39c12 !important;
    border-color: #f39c12 !important;
    color: white !important;
}

/* ä¿®å¤åˆ†é¡µæŒ‰é’®æ ·å¼ */
.pagination-btn {
    background-color: #f8f9fa !important;
    color: #2c3e50 !important; /* é»‘è‰²æ–‡å­— */
    border: 1px solid #dee2e6 !important;
}

.pagination-btn:hover:not(:disabled) {
    background-color: #e9ecef !important;
    color: #2c3e50 !important;
}

.pagination-btn.active {
    background-color: var(--accent-color) !important;
    color: white !important;
    border-color: var(--accent-color) !important;
}

.pagination-btn:disabled {
    background-color: #f8f9fa !important;
    color: #6c757d !important; /* ç°è‰²æ–‡å­—è¡¨ç¤ºç¦ç”¨ */
    border-color: #dee2e6 !important;
    opacity: 0.6 !important;
}

/* ä¿®å¤è§†å›¾åˆ‡æ¢æŒ‰é’®æ ·å¼ */
.view-toggle-btn {
    background-color: #f8f9fa !important;
    color: var(--text-color) !important;
    border: 1px solid #dee2e6 !important;
}

.view-toggle-btn.active {
    background-color: var(--accent-color) !important;
    color: white !important;
    border-color: var(--accent-color) !important;
}

.view-toggle-btn:hover:not(.active) {
    background-color: #e9ecef !important;
    color: var(--text-color) !important;
}

/* ç¡®ä¿æŒ‰é’®åœ¨ç™½è‰²èƒŒæ™¯ä¸‹å¯è§ */
.alert-controls .btn-sm {
    background-color: var(--accent-color);
    color: white;
    border: 1px solid var(--accent-color);
}

.alert-controls .btn-sm:hover {
    background-color: #2980b9;
    color: white;
}
        
        .alert-filters {
            display: flex;
            gap: 10px;
            flex: 1;
        }
        
        .alert-search {
            flex: 1;
            max-width: 300px;
        }
        
        .alert-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .alert-status-filter {
            display: flex;
            gap: 5px;
        }
        
        .status-filter-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .status-filter-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        
        .status-filter-btn.low-stock.active {
            background: var(--warning-color);
            border-color: var(--warning-color);
        }
        
        .status-filter-btn.high-stock.active {
            background: #f39c12;
            border-color: #f39c12;
        }
        
        .alert-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 10px 0;
            border-top: 1px solid #eee;
        }
        
        .pagination-info {
            font-size: 0.85rem;
            color: #666;
        }
        
        .pagination-controls {
            display: flex;
            gap: 5px;
        }
        
        .pagination-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: #f0f0f0;
        }
        
        .pagination-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .alert-card-view {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .alert-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            transition: all 0.3s;
        }
        
        .alert-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .alert-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .alert-product-info h4 {
            margin: 0 0 5px 0;
            font-size: 1rem;
            color: #2c3e50;
        }
        
        .alert-product-info p {
            margin: 0;
            font-size: 0.8rem;
            color: #7f8c8d;
        }
        
        .alert-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .alert-status.normal {
            background: #e8f6ef;
            color: #27ae60;
        }
        
        .alert-status.warning {
            background: #fdedec;
            color: #e74c3c;
        }
        
        .alert-status.monitor {
            background: #ebf5fb;
            color: #3498db;
        }
        
        .alert-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            background: #f8f9fa;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #7f8c8d;
            margin-bottom: 3px;
        }
        
        .stat-value {
            font-size: 1rem;
            font-weight: bold;
        }
        
        .alert-actions {
            display: flex;
            gap: 8px;
        }
        
        .alert-actions .btn-sm {
            flex: 1;
            padding: 6px 10px;
            font-size: 0.75rem;
        }
        
        .view-toggle {
            display: flex;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            margin-left: 10px;
        }
        
        .view-toggle-btn {
            padding: 8px 12px;
            background: white;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .view-toggle-btn.active {
            background: var(--accent-color);
            color: white;
        }
        
        .view-toggle-btn:not(:last-child) {
            border-right: 1px solid #ddd;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 992px) {
            .alert-card-view {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: none;
                width: 100%;
                height: auto;
                position: static;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                display: flex;
                flex-wrap: wrap;
                padding: 0.5rem;
                top: auto;
            }
            
            .nav-item {
                flex: 1;
                min-width: 120px;
                justify-content: center;
                margin: 2px;
                padding: 0.7rem 0.5rem;
            }
            
            .main-content {
                margin-left: 0;
            }
            /* ç™»å½•é¡µé¢ä¸éœ€è¦å›ºå®šæ ‡é¢˜ */
.login-container .header {
    position: static;
}
            .alert-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .alert-filters {
                flex-direction: column;
            }
            
            .alert-search {
                max-width: 100%;
            }
        }

/* æ•°æ®åº“ç®¡ç†é¡µé¢æ ·å¼ */
.database-management-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

@media (max-width: 1024px) {
    .database-management-container {
        grid-template-columns: 1fr;
    }
}

/* æ•°æ®å¯¼å…¥åŒºåŸŸæ ·å¼ */
.data-import-section {
    padding: 15px 0;
}

.file-input-container {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 10px;
}

.file-input-container input[type="file"] {
    flex: 1;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: white;
}

.file-requirements {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 4px;
    margin-top: 10px;
}

.file-requirements p {
    margin: 5px 0;
    font-size: 0.8rem;
    color: #666;
}

.import-status {
    margin: 15px 0;
    padding: 10px;
    border-radius: 4px;
    font-size: 0.9rem;
    display: none;
}

.import-status.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    display: block;
}

.import-status.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    display: block;
}

.import-status.info {
    background: #cce7ff;
    color: #004085;
    border: 1px solid #b3d7ff;
    display: block;
}

/* æ•°æ®ç»Ÿè®¡æ ·å¼ */
.data-stats, .backup-stats {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
}

.data-stats h4, .backup-stats h4 {
    margin-bottom: 15px;
    font-size: 1rem;
    color: var(--text-color);
}

.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 4px;
    border-left: 3px solid var(--accent-color);
}

.stat-label {
    font-size: 0.8rem;
    color: #666;
}

.stat-value {
    font-size: 0.9rem;
    font-weight: bold;
    color: var(--text-color);
}

/* å¤‡ä»½ç®¡ç†åŒºåŸŸæ ·å¼ */
.backup-management-section {
    padding: 15px 0;
}

.backup-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    color: #666;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--success-color);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* å¿«é€Ÿæ“ä½œæ ·å¼ */
.quick-actions {
    margin-bottom: 20px;
}

.quick-actions h4 {
    margin-bottom: 12px;
    font-size: 1rem;
}

.action-buttons {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

.action-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.action-btn.primary {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

.action-btn.secondary {
    background: white;
    color: var(--text-color);
}

.btn-icon {
    font-size: 1.5rem;
    margin-bottom: 5px;
}

.action-btn span:last-child {
    font-size: 0.8rem;
    font-weight: 500;
}

/* é«˜çº§ç®¡ç†æ ·å¼ */
.advanced-management {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
}

.advanced-management h4 {
    margin-bottom: 12px;
    font-size: 1rem;
}

.advanced-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.btn-sm.outline {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-color);
}

.btn-sm.outline:hover {
    background: var(--secondary-color);
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .action-buttons {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .advanced-actions {
        flex-direction: column;
    }
    
    .file-input-container {
        flex-direction: column;
        align-items: stretch;
    }
}

/* ç”¨æˆ·ç®¡ç†æ ·å¼ */
.user-role {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: bold;
}

.user-role.admin {
    background: #e74c3c;
    color: white;
}

.user-role.user {
    background: #3498db;
    color: white;
}

/* æ“ä½œæ—¥å¿—æ ·å¼ */
.log-action-type {
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: bold;
}

.log-action-type.success {
    background: #d4edda;
    color: #155724;
}

.log-action-type.warning {
    background: #fff3cd;
    color: #856404;
}

.log-action-type.error {
    background: #f8d7da;
    color: #721c24;
}

.log-action-type.info {
    background: #cce7ff;
    color: #004085;
}

/* å¥åº·çŠ¶æ€æŒ‡ç¤ºå™¨ */
.health-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
}

.health-indicator.healthy {
    background: #2ecc71;
}

.health-indicator.warning {
    background: #f39c12;
}

.health-indicator.error {
    background: #e74c3c;
}



    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div id="login-page" class="login-container">
        <div class="login-form">
            <h2>æ™ºèƒ½åº“å­˜ç®¡ç†ç³»ç»Ÿ - æ•°æ®åº“ç‰ˆ</h2>
            <div class="form-group">
                <label for="username">ç”¨æˆ·å</label>
                <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" value="admin">
            </div>
            <div class="form-group">
                <label for="password">å¯†ç </label>
                <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç " value="password">
            </div>
            <button id="login-btn" style="width: 100%;">
                <span id="login-text">ç™»å½•</span>
                <span id="login-loading" class="loading hidden"></span>
            </button>
            <div id="login-error" class="login-error">ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯</div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="main-app" class="container hidden">
        <header class="header">
            <h2 style="font-size: 1.2rem;">æ™ºèƒ½åº“å­˜ç®¡ç†ç³»ç»Ÿ - æ•°æ®åº“ç‰ˆ</h2>
            <div class="user-menu">
                <span id="current-user">ç®¡ç†å‘˜</span>
                <div class="user-menu-content">
                    <div class="user-menu-item" id="logout-btn">é€€å‡ºç™»å½•</div>
                </div>
            </div>
        </header>
        
       <!-- ä¼˜åŒ–åçš„å¯¼èˆªæ  -->
        <div class="sidebar">
            <div class="nav-item active" data-page="dashboard">
                <i>ğŸ“Š</i> ä»ªè¡¨ç›˜
            </div>
            <div class="nav-item" data-page="inventory">
                <i>ğŸ“¦</i> åº“å­˜ç®¡ç†
            </div>
            <div class="nav-item" data-page="alerts">
                <i>âš ï¸</i> åº“å­˜é¢„è­¦
            </div>
            <div class="nav-item" data-page="location">
                <i>ğŸ—„ï¸</i> åº“ä½ç®¡ç†
            </div>
            <div class="nav-item" data-page="analysis">
                <i>ğŸ“ˆ</i> æ™ºèƒ½åˆ†æ
            </div>
            <div class="nav-item" data-page="database">
                <i>ğŸ’¾</i> æ•°æ®åº“ç®¡ç†
            </div>
            <div class="nav-item" data-page="settings">
                <i>âš™ï¸</i> ç³»ç»Ÿè®¾ç½®
            </div>
        </div>
        
        <main class="main-content">
            <!-- ä»ªè¡¨ç›˜é¡µé¢ -->
            <div id="dashboard-page" class="page-content">
                <div class="card">
                    <div class="card-header">
                        <h3 style="font-size: 1.1rem;">åº“å­˜æ¦‚è§ˆ</h3>
                        <span id="last-update-time" style="font-size: 0.85rem;">æœ€åæ›´æ–°: 2023-11-01 12:30:45</span>
                    </div>
                    
                    <div class="stats-container">
                        <div class="stat-card">
                            <div>éœ€é¢„è­¦äº§å“</div>
                            <div class="stat-value warning" id="warning-products">0</div>
                            <div>ä½åº“å­˜: <span id="low-stock-count">0</span> | é«˜åº“å­˜: <span id="high-stock-count">0</span></div>
                        </div>
                        <div class="stat-card">
                            <div>å¹³å‡å‘¨è½¬å¤©æ•°</div>
                            <div class="stat-value" id="turnover-days">0</div>
                            <div>è¡Œä¸šå¹³å‡: 45å¤©</div>
                        </div>
                        <div class="stat-card">
                            <div>å‘†æ»åº“å­˜å æ¯”</div>
                            <div class="stat-value warning" id="obsolete-percentage">0%</div>
                            <div>é‡‘é¢: <span id="obsolete-value">Â¥0</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- FIFOç»Ÿè®¡ -->
                <div class="card">
                    <div class="card-header">
                        <h3 style="font-size: 1.1rem;">FIFOåº“å­˜åˆ†æ</h3>
                        <div>
                            <button id="export-fifo-report" class="btn-sm">å¯¼å‡ºFIFOæŠ¥å‘Š</button>
                        </div>
                    </div>
                    
                    <div class="stats-container">
                        <div class="stat-card">
                            <div>å¤šæ‰¹æ¬¡äº§å“æ•°</div>
                            <div class="stat-value" id="multi-batch-count">0</div>
                            <div>éœ€è¦FIFOç®¡ç†çš„äº§å“</div>
                        </div>
                        <div class="stat-card">
                            <div>å³å°†è¿‡æœŸäº§å“</div>
                            <div class="stat-value warning" id="expiring-soon-count">0</div>
                            <div>è´¨ä¿æœŸå‰©ä½™&lt;30å¤©</div>
                        </div>
                        <div class="stat-card">
                            <div>å·²è¿‡æœŸäº§å“</div>
                            <div class="stat-value warning" id="expired-count">0</div>
                            <div>è´¨ä¿æœŸå·²è¿‡æœŸ</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 style="font-size: 1.1rem;">æ€¥éœ€å¤„ç†é¡¹ç›®</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>äº§å“åç§°</th>
                                    <th>å‹å·</th>
                                    <th>å½“å‰åº“å­˜</th>
                                    <th>å®‰å…¨åº“å­˜</th>
                                    <th>å®¢æˆ·</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="urgent-items">
                                <tr><td colspan="7" style="text-align: center;">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- åº“å­˜ç®¡ç†é¡µé¢ -->
            <div id="inventory-page" class="page-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 style="font-size: 1.1rem;">åº“å­˜åˆ—è¡¨</h3>
                    </div>
                    
                    <div class="search-container">
                        <input type="text" id="inventory-search" placeholder="æœç´¢äº§å“å‹å·æˆ–è®¢è´§å·...">
                        <select id="search-type">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="model">å‹å·</option>
                            <option value="orderNumber">è®¢è´§å·</option>
                            <option value="brand">å“ç‰Œ</option>
                            <option value="name">å“å</option>
                        </select>
                        <button id="search-btn" class="btn-sm">æœç´¢</button>
                        <button id="reset-search" class="btn-sm">é‡ç½®</button>
                        <button id="toggle-stock-value" class="btn-sm">æ˜¾ç¤ºé‡‘é¢</button>
                        <button id="toggle-fifo-highlight" class="btn-sm">FIFOé«˜äº®</button>
                        <button id="show-warranty-warning" class="btn-sm">è´¨ä¿æœŸè­¦å‘Š</button>
                    </div>
                    
                    <div style="margin: 1rem 0; display: flex; gap: 1rem;">
                        <select id="inventory-filter">
                            <option value="all">å…¨éƒ¨åº“å­˜</option>
                            <option value="effective">æœ‰æ•ˆåº“å­˜</option>
                            <option value="transit">åœ¨é€”åº“å­˜</option>
                            <option value="over6months">å¤§äº6ä¸ªæœˆçš„åº“å­˜</option>
                            <option value="priority">ä¼˜å…ˆå‡ºåº“åº“å­˜</option>
                        </select>
                        <div style="font-size: 0.85rem; color: #666; display: flex; align-items: center;">
                            å…± <span id="inventory-count">0</span> æ¡è®°å½•
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="brand">å“ç‰Œ</th>
                                    <th class="sortable" data-sort="name">å“å</th>
                                    <th class="sortable" data-sort="model">å‹å·</th>
                                    <th class="sortable" data-sort="orderNumber">è®¢è´§å·</th>
                                    <th class="sortable" data-sort="stockQty">åº“å­˜æ•°é‡</th>
                                    <th class="sortable" data-sort="availableQty">å¯ç”¨æ•°é‡</th>
                                    <th class="sortable" data-sort="clientName">å®¢æˆ·</th>
                                    <th>åº“å­˜ç±»å‹</th>
                                    <th>åº“ä½</th>
                                    <th class="sortable" data-sort="entryDate">å…¥åº“æ—¥æœŸ</th>
                                    <th class="sortable stock-value-column hidden" data-sort="stockValue">åº“å­˜é‡‘é¢</th>
                                    <th class="sortable" data-sort="warehouse">æ‰€åœ¨ä»“åº“</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-list">
                                <tr><td colspan="12" style="text-align: center;">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- åº“å­˜é¢„è­¦é¡µé¢ -->
<div id="alerts-page" class="page-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 style="font-size: 1.1rem;">åº“å­˜é¢„è­¦ç®¡ç†</h3>
                        <div>
                            <button id="add-alert-product" class="btn-sm">æ·»åŠ é¢„è­¦äº§å“</button>
                            <button id="import-alert-config" class="btn-sm">å¯¼å…¥é¢„è­¦é…ç½®</button>
                            <button id="export-alert-config" class="btn-sm">å¯¼å‡ºé¢„è­¦é…ç½®</button>
                            <div class="view-toggle">
                                <button class="view-toggle-btn active" data-view="table">è¡¨æ ¼</button>
                                <button class="view-toggle-btn" data-view="card">å¡ç‰‡</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- é¢„è­¦é…ç½®å¯¼å…¥å¯¼å‡ºçŠ¶æ€ -->
                    <div id="alert-import-status" style="margin: 10px 0; padding: 8px; border-radius: 4px; display: none;"></div>
                    
                    <!-- é¢„è­¦æ§åˆ¶æ  -->
                    <div class="alert-controls">
    <div class="alert-filters">
        <div class="alert-search">
            <input type="text" id="alert-search-input" placeholder="æœç´¢äº§å“...">
        </div>
        <div class="alert-status-filter">
            <button class="status-filter-btn active" data-status="all">å…¨éƒ¨</button>
            <button class="status-filter-btn low-stock" data-status="low">ä½åº“å­˜</button>
            <button class="status-filter-btn high-stock" data-status="high">é«˜åº“å­˜</button>
            <button class="status-filter-btn" data-status="normal">æ­£å¸¸</button>
        </div>
    </div>
    <div class="alert-actions">
        <button id="validate-alert-data" class="btn-sm" style="background: #f39c12;">éªŒè¯æ•°æ®</button>
        <button id="refresh-alerts" class="btn-sm">åˆ·æ–°</button>
    </div>
</div>
                    
                    <!-- å¡ç‰‡è§†å›¾ -->
                    <div class="alert-card-view" id="alert-card-view">
                        <!-- å¡ç‰‡å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    
                    <!-- è¡¨æ ¼è§†å›¾ -->
                    <div class="table-container" id="alert-table-view">
                        <table>
                            <thead>
                                <tr>
                                    <th>å“ç‰Œ</th>
                                    <th>äº§å“åç§°</th>
                                    <th>å‹å·</th>
                                    <th>è®¢è´§å·</th>
                                    <th>å½“å‰åº“å­˜</th>
                                    <th>æœ€ä½åº“å­˜</th>
                                    <th>æœ€é«˜åº“å­˜</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="alert-list">
                                <tr><td colspan="9" style="text-align: center;">æš‚æ— é¢„è­¦æ•°æ®</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- åˆ†é¡µæ§ä»¶ -->
                    <div class="alert-pagination">
                        <div class="pagination-info" id="alert-pagination-info">
                            æ˜¾ç¤º 0-0 æ¡ï¼Œå…± 0 æ¡
                        </div>
                        <div class="pagination-controls">
                            <button class="pagination-btn" id="alert-prev-page" disabled>ä¸Šä¸€é¡µ</button>
                            <div id="alert-page-numbers">
                                <!-- é¡µç å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                            <button class="pagination-btn" id="alert-next-page" disabled>ä¸‹ä¸€é¡µ</button>
                        </div>
                    </div>
                </div>    
    <!-- é‡‡è´­å¤‡è´§å»ºè®®æ¸…å• -->
    <div class="card" style="margin-top: 20px;">
        <div class="card-header">
            <h3 style="font-size: 1.1rem;">é‡‡è´­å¤‡è´§å»ºè®®æ¸…å•</h3>
            <div>
                <button id="refresh-purchase-suggestions" class="btn-sm">åˆ·æ–°å»ºè®®</button>
                <button id="export-purchase-suggestions" class="btn-sm">å¯¼å‡ºé‡‡è´­å»ºè®®</button>
            </div>
        </div>
        
        <div class="search-container" style="margin: 15px 0;">
            <select id="purchase-filter">
                <option value="all">å…¨éƒ¨å»ºè®®</option>
                <option value="urgent">æ€¥éœ€é‡‡è´­</option>
                <option value="normal">å¸¸è§„é‡‡è´­</option>
                <option value="monitor">ç›‘æ§åº“å­˜</option>
            </select>
            <input type="text" id="purchase-search" placeholder="æœç´¢äº§å“...">
            <button id="apply-purchase-filter" class="btn-sm">ç­›é€‰</button>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>äº§å“åç§°</th>
                        <th>å‹å·</th>
                        <th>è®¢è´§å·</th>
                        <th>å½“å‰åº“å­˜</th>
                        <th>å®‰å…¨åº“å­˜</th>
                        <th>å»ºè®®é‡‡è´­é‡</th>
                        <th>ç´§æ€¥ç¨‹åº¦</th>
                        <th>é¢„è®¡åˆ°è´§æ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="purchase-suggestions-list">
                    <tr><td colspan="9" style="text-align: center;">ç‚¹å‡»"åˆ·æ–°å»ºè®®"ç”Ÿæˆé‡‡è´­å»ºè®®</td></tr>
                </tbody>
            </table>
        </div>
        
        <div style="padding: 10px; background: #f8f9fa; border-radius: 4px; margin-top: 10px;">
            <div style="display: flex; gap: 20px; font-size: 0.8rem;">
                <div>
                    <span style="display: inline-block; width: 12px; height: 12px; background: #e74c3c; border-radius: 2px; margin-right: 5px;"></span>
                    æ€¥éœ€é‡‡è´­: åº“å­˜ä½äºå®‰å…¨åº“å­˜
                </div>
                <div>
                    <span style="display: inline-block; width: 12px; height: 12px; background: #f39c12; border-radius: 2px; margin-right: 5px;"></span>
                    å¸¸è§„é‡‡è´­: åº“å­˜æ¥è¿‘å®‰å…¨åº“å­˜
                </div>
                <div>
                    <span style="display: inline-block; width: 12px; height: 12px; background: #3498db; border-radius: 2px; margin-right: 5px;"></span>
                    ç›‘æ§åº“å­˜: åº“å­˜å……è¶³ä½†éœ€å…³æ³¨
                </div>
            </div>
        </div>
    </div>
</div>
     
<!-- å¯¼å…¥é¢„è­¦é…ç½®æ¨¡æ€æ¡† -->
<div id="import-alert-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>å¯¼å…¥é¢„è­¦é…ç½®</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div>
            <div class="form-group">
                <label>é€‰æ‹©å¯¼å…¥æ–‡ä»¶</label>
                <input type="file" id="alert-import-file" accept=".json,.xlsx,.xls">
                <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                    æ”¯æŒæ ¼å¼: JSON, Excel (.xlsx, .xls)
                </div>
            </div>
            
            <div class="form-group">
                <label>å¯¼å…¥é€‰é¡¹</label>
                <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 5px;">
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="radio" name="import-mode" value="replace" checked> æ›¿æ¢ç°æœ‰é…ç½®
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="radio" name="import-mode" value="merge"> åˆå¹¶åˆ°ç°æœ‰é…ç½®
                    </label>
                </div>
            </div>
            
            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
                <button id="confirm-alert-import" class="btn-sm">ç¡®è®¤å¯¼å…¥</button>
                <button class="btn-sm close-modal">å–æ¶ˆ</button>
            </div>
            
            <div id="alert-import-preview" style="margin-top: 15px; max-height: 200px; overflow-y: auto; display: none;">
                <h4 style="font-size: 0.9rem; margin-bottom: 8px;">é¢„è§ˆæ•°æ®</h4>
                <div id="alert-import-preview-content" style="font-size: 0.8rem;"></div>
            </div>
        </div>
    </div>
</div>
       
            <!-- åº“ä½ç®¡ç†é¡µé¢ -->
            <div id="location-page" class="page-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 style="font-size: 1.1rem;">åº“ä½ç®¡ç†ç³»ç»Ÿ</h3>
                        <div>
                            <button id="manual-assign-btn" class="btn-sm">æ‰‹åŠ¨å…³è”</button>
                            <button id="configure-shelves-btn" class="btn-sm">é…ç½®è´§æ¶</button>
                        </div>
                    </div>
                    
                    <!-- åº“ä½æ§åˆ¶é¢æ¿å¸ƒå±€ -->
                    <div class="location-controls-panel">
                        <!-- æœç´¢äº§å“åŒºåŸŸ -->
                        <div class="location-control-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4>æœç´¢äº§å“</h4>
                                <div id="current-location-display" style="font-size: 0.8rem; color: #666; background: #f0f0f0; padding: 4px 8px; border-radius: 4px; border: 1px solid #ddd;">
                                    å½“å‰åº“ä½: æ— 
                                </div>
                            </div>
                            <div class="search-input-container">
                                <input type="text" id="product-search-input" placeholder="è¾“å…¥å‹å·ã€åç§°æˆ–è®¢è´§å·...">
                                <div class="search-results" id="product-search-results">
                                    <!-- æœç´¢ç»“æœå°†åŠ¨æ€å¡«å…… -->
                                </div>
                            </div>
                            <div class="dialog-buttons" style="margin-top: auto;">
                                <button id="view-product-location" class="btn-sm" style="font-size: 0.8rem;">æŸ¥çœ‹ä½ç½®</button>
                                <button id="clear-product-search" class="btn-sm" style="font-size: 0.8rem;">æ¸…ç©º</button>
                            </div>
                        </div>
                        
                        <!-- å›¾ä¾‹è¯´æ˜ -->
                        <div class="location-control-section">
                            <h4>å›¾ä¾‹è¯´æ˜</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 0.75rem;">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #e3f2fd; border-color: #2196f3;"></div>
                                    <span>å·²å ç”¨</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: white; border-color: #bbb;"></div>
                                    <span>ç©ºé—²</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #bbdefb; border: 2px solid #2196f3;"></div>
                                    <span>é€‰ä¸­</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: var(--highlight-color); border: 2px solid #ffc107;"></div>
                                    <span>é«˜äº®</span>
                                </div>
                            </div>
                            <div style="margin-top: auto; font-size: 0.7rem; color: #666;">
                                <p>æç¤º: ç‚¹å‡»è´§ä½å¯è¿›è¡Œäº§å“å…³è”</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è´§æ¶å¯è§†åŒ–åŒºåŸŸ -->
                    <div class="shelf-visualization">
                        <div class="shelves-container" id="shelves-container">
                            <!-- è´§æ¶å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ™ºèƒ½åˆ†æé¡µé¢ -->
            <div id="analysis-page" class="page-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 style="font-size: 1.1rem;">æ™ºèƒ½åˆ†æ</h3>
                    </div>
                    <div style="padding: 1rem;">
                        <h4>åº“å­˜å‘¨è½¬åˆ†æ</h4>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
                            <p>å¹³å‡å‘¨è½¬å¤©æ•°: <strong>42å¤©</strong></p>
                            <p>å‘¨è½¬ç‡: <strong>85%</strong></p>
                            <p>å‘†æ»åº“å­˜å æ¯”: <strong>8%</strong></p>
                        </div>
                        
                        <h4 style="margin-top: 1.5rem;">é‡‡è´­å»ºè®®</h4>
                        <div class="table-container" style="margin-top: 1rem;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>äº§å“åç§°</th>
                                        <th>å‹å·</th>
                                        <th>å½“å‰åº“å­˜</th>
                                        <th>å®‰å…¨åº“å­˜</th>
                                        <th>å»ºè®®é‡‡è´­é‡</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>è½´æ‰¿Aå‹</td>
                                        <td>ZC-001</td>
                                        <td>25</td>
                                        <td>30</td>
                                        <td>15</td>
                                    </tr>
                                    <tr>
                                        <td>ä¼ æ„Ÿå™¨Cå‹</td>
                                        <td>CG-012</td>
                                        <td>8</td>
                                        <td>15</td>
                                        <td>12</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
       <!-- æ•°æ®åº“ç®¡ç†é¡µé¢ -->
<div id="database-page" class="page-content hidden">
    <div class="database-management-container">
        <!-- æ•°æ®å¯¼å…¥å¡ç‰‡ -->
        <div class="card">
            <div class="card-header">
                <h3 style="font-size: 1.1rem;">åº“å­˜æ•°æ®å¯¼å…¥</h3>
                <div class="db-status online" id="db-status">æ•°æ®åº“çŠ¶æ€: å·²è¿æ¥</div>
            </div>
            <div class="data-import-section">
                <div class="form-group">
                    <label>é€‰æ‹©Excelæ–‡ä»¶</label>
                    <div class="file-input-container">
                        <input type="file" id="import-inventory-excel" accept=".xlsx, .xls">
                        <button id="process-inventory-import" class="btn-sm">å¯¼å…¥åº“å­˜æ•°æ®</button>
                    </div>
                    <div class="file-requirements">
                        <p>æ”¯æŒæ ¼å¼: Excel (.xlsx, .xls)</p>
                        <p>å¿…éœ€åˆ—: å‹å·ã€è®¢è´§å·ã€åº“å­˜æ•°é‡</p>
                    </div>
                </div>
                
                <div id="import-status" class="import-status"></div>
                
                <div class="data-stats">
                    <h4>æ•°æ®ç»Ÿè®¡</h4>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">åº“å­˜è®°å½•æ•°</span>
                            <span class="stat-value" id="inventory-record-count">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">æœ€åæ›´æ–°æ—¶é—´</span>
                            <span class="stat-value" id="inventory-last-update">ä»æœªæ›´æ–°</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">é¢„è­¦é…ç½®æ•°</span>
                            <span class="stat-value" id="alert-config-count">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">åº“ä½å…³è”æ•°</span>
                            <span class="stat-value" id="location-relation-count">0</span>
                        </div>
                    <!-- supabaseè¿æ¥çŠ¶æ€ -->
                   <div class="connection-test" style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                      <h4 style="margin-bottom: 8px;">è¿æ¥çŠ¶æ€æµ‹è¯•</h4>
                      <button id="test-connection" class="btn-sm" style="background: #27ae60;">æµ‹è¯• Supabase è¿æ¥</button>
                      <span id="connection-test-result" style="margin-left: 10px; font-size: 0.9rem;"></span>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•°æ®å¤‡ä»½ä¸æ¢å¤å¡ç‰‡ -->
        <div class="card">
            <div class="card-header">
                <h3 style="font-size: 1.1rem;">æ•°æ®å¤‡ä»½ä¸æ¢å¤</h3>
                <div class="backup-status" id="backup-status-info">
                    <span class="status-dot"></span>
                    å¤‡ä»½ç³»ç»Ÿ: è¿è¡Œä¸­
                </div>
            </div>
            
            <div class="backup-management-section">
                <!-- å¿«é€Ÿæ“ä½œ -->
                <div class="quick-actions">
                    <h4>å¿«é€Ÿæ“ä½œ</h4>
                    <div class="action-buttons">
                        <button id="backup-data" class="action-btn primary">
                            <span class="btn-icon">ğŸ’¾</span>
                            <span>ç«‹å³å¤‡ä»½</span>
                        </button>
                        <button id="restore-data" class="action-btn secondary">
                            <span class="btn-icon">ğŸ”„</span>
                            <span>æ¢å¤æ•°æ®</span>
                        </button>
                        <button id="export-location-report" class="action-btn secondary">
                            <span class="btn-icon">ğŸ“‹</span>
                            <span>åº“ä½æŠ¥è¡¨</span>
                        </button>
                    </div>
                </div>

                <!-- å¤‡ä»½ç»Ÿè®¡ -->
                <div class="backup-stats">
                    <h4>å¤‡ä»½ç»Ÿè®¡</h4>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">è‡ªåŠ¨å¤‡ä»½</span>
                            <span class="stat-value" id="auto-backup-count">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">æ‰‹åŠ¨å¤‡ä»½</span>
                            <span class="stat-value" id="manual-backup-count">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">æœ€åå¤‡ä»½</span>
                            <span class="stat-value" id="last-backup-time">æ— </span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">æ€»å¤‡ä»½å¤§å°</span>
                            <span class="stat-value" id="total-backup-size">0 KB</span>
                        </div>
                    </div>
                </div>

                <!-- é«˜çº§ç®¡ç† -->
                <div class="advanced-management">
                    <h4>é«˜çº§ç®¡ç†</h4>
                    <div class="advanced-actions">
                        <button id="manage-backups" class="btn-sm outline">
                            <span class="btn-icon">ğŸ“Š</span>
                            å¤‡ä»½ç®¡ç†
                        </button>
                        <button id="clean-backups" class="btn-sm outline">
                            <span class="btn-icon">ğŸ§¹</span>
                            æ¸…ç†æ—§å¤‡ä»½
                        </button>
                        <button id="export-all-data" class="btn-sm outline">
                            <span class="btn-icon">ğŸ“¤</span>
                            å…¨é‡å¯¼å‡º
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
                   <!-- åœ¨ database-page ä¸­ï¼Œæ·»åŠ åˆ°æ•°æ®åº“ç®¡ç†å®¹å™¨çš„æœ€å -->
<div class="card">
    <div class="card-header">
        <h3 style="font-size: 1.1rem;">ç³»ç»Ÿæ“ä½œæ—¥å¿—</h3>
        <div>
            <button id="refresh-logs-btn" class="btn-sm">åˆ·æ–°</button>
            <button id="export-logs-btn" class="btn-sm">å¯¼å‡ºæ—¥å¿—</button>
            <button id="clear-old-logs-btn" class="btn-sm" style="background: #e74c3c;">æ¸…ç†æ—§æ—¥å¿—</button>
        </div>
    </div>

    <!-- æ—¥å¿—ç­›é€‰æ§åˆ¶ -->
    <div class="alert-controls" style="margin: 15px 0;">
        <div class="alert-filters">
            <div class="alert-search">
                <input type="text" id="log-search-input" placeholder="æœç´¢æ“ä½œå†…å®¹...">
            </div>
            <div class="alert-status-filter">
                <button class="status-filter-btn active" data-log-type="all">å…¨éƒ¨</button>
                <button class="status-filter-btn" data-log-type="INSERT">æ–°å¢</button>
                <button class="status-filter-btn" data-log-type="UPDATE">æ›´æ–°</button>
                <button class="status-filter-btn" data-log-type="DELETE">åˆ é™¤</button>
                <button class="status-filter-btn" data-log-type="IMPORT">å¯¼å…¥</button>
            </div>
        </div>
        <div class="alert-actions">
            <select id="log-time-filter" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="today">ä»Šå¤©</option>
                <option value="week">æœ¬å‘¨</option>
                <option value="month">æœ¬æœˆ</option>
                <option value="all">å…¨éƒ¨æ—¶é—´</option>
            </select>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>æ—¶é—´</th>
                    <th>ç”¨æˆ·</th>
                    <th>æ“ä½œç±»å‹</th>
                    <th>æ•°æ®è¡¨</th>
                    <th>è®°å½•ID</th>
                    <th>IPåœ°å€</th>
                    <th>è¯¦æƒ…</th>
                </tr>
            </thead>
            <tbody id="operation-logs-list">
                <tr><td colspan="7" style="text-align: center;">åŠ è½½ä¸­...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- åˆ†é¡µæ§ä»¶ -->
    <div class="alert-pagination">
        <div class="pagination-info" id="logs-pagination-info">
            æ˜¾ç¤º 0-0 æ¡ï¼Œå…± 0 æ¡
        </div>
        <div class="pagination-controls">
            <button class="pagination-btn" id="logs-prev-page" disabled>ä¸Šä¸€é¡µ</button>
            <div id="logs-page-numbers"></div>
            <button class="pagination-btn" id="logs-next-page" disabled>ä¸‹ä¸€é¡µ</button>
        </div>
    </div>
</div>
</div>
            

            <!-- ç³»ç»Ÿè®¾ç½®é¡µé¢ -->
            <div id="settings-page" class="page-content hidden">
               <div class="card">
    <div class="card-header">
        <h3 style="font-size: 1.1rem;">ç”¨æˆ·ä¸æƒé™ç®¡ç†</h3>
        <button id="refresh-users-btn" class="btn-sm">åˆ·æ–°åˆ—è¡¨</button>
    </div>
    
    <!-- ç”¨æˆ·æ“ä½œç»Ÿè®¡ -->
    <div style="padding: 15px; background: #f8f9fa; border-radius: 4px; margin-bottom: 15px;">
        <h4 style="margin-bottom: 10px;">ç”¨æˆ·ç»Ÿè®¡</h4>
        <div class="stats-grid">
            <div class="stat-item">
                <span class="stat-label">æ€»ç”¨æˆ·æ•°</span>
                <span class="stat-value" id="total-users-count">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">æ´»è·ƒç”¨æˆ·</span>
                <span class="stat-value" id="active-users-count">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">ä»Šæ—¥æ“ä½œ</span>
                <span class="stat-value" id="today-operations-count">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">åœ¨çº¿ç”¨æˆ·</span>
                <span class="stat-value" id="online-users-count">0</span>
            </div>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ç”¨æˆ·å</th>
                    <th>é‚®ç®±</th>
                    <th>è§’è‰²</th>
                    <th>æœ€åç™»å½•</th>
                    <th>æ“ä½œæ¬¡æ•°</th>
                    <th>çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="users-list">
                <tr><td colspan="7" style="text-align: center;">åŠ è½½ä¸­...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- ç”¨æˆ·æ“ä½œæŒ‰é’® -->
    <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
        <button id="invite-user-btn" class="btn-sm" style="background: #2ecc71;">é‚€è¯·ç”¨æˆ·</button>
        <button id="export-users-btn" class="btn-sm">å¯¼å‡ºç”¨æˆ·åˆ—è¡¨</button>
        <button id="user-permissions-btn" class="btn-sm">æƒé™è®¾ç½®</button>
    </div>
</div>
                        
                        <h4 style="margin-top: 1.5rem;">ç³»ç»Ÿé…ç½®</h4>
                        <div style="margin-top: 1rem;">
                            <div style="margin-bottom: 1rem;">
                                <label>è‡ªåŠ¨å¤‡ä»½é—´éš”:</label>
                                <select style="margin-left: 10px;">
                                    <option>æ¯å¤©</option>
                                    <option>æ¯å‘¨</option>
                                    <option>æ¯æœˆ</option>
                                </select>
                            </div>
                            <div>
                                <label>æ•°æ®ä¿ç•™æ—¶é—´:</label>
                                <select style="margin-left: 10px;">
                                    <option>3ä¸ªæœˆ</option>
                                    <option>6ä¸ªæœˆ</option>
                                    <option>1å¹´</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- æ·»åŠ é¢„è­¦äº§å“æ¨¡æ€æ¡† -->
    <div id="add-alert-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ é¢„è­¦äº§å“</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="alert-brand">å“ç‰Œ</label>
                <input type="text" id="alert-brand">
            </div>
            <div class="form-group">
                <label for="alert-name">äº§å“åç§°</label>
                <input type="text" id="alert-name">
            </div>
            <div class="form-group">
                <label for="alert-model">å‹å·</label>
                <input type="text" id="alert-model">
            </div>
            <div class="form-group">
                <label for="alert-order-number">è®¢è´§å·</label>
                <input type="text" id="alert-order-number">
            </div>
            <div class="form-group">
                <label for="alert-min-stock">æœ€ä½åº“å­˜</label>
                <input type="number" id="alert-min-stock" value="5">
            </div>
            <div class="form-group">
                <label for="alert-max-stock">æœ€é«˜åº“å­˜</label>
                <input type="number" id="alert-max-stock" value="100">
            </div>
            <button id="save-alert-product">ä¿å­˜</button>
        </div>
    </div>

    <!-- æ‰‹åŠ¨å…³è”äº§å“ä¸åº“ä½æ¨¡æ€æ¡† -->
    <div id="manual-assignment-modal" class="modal manual-assignment-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>æ‰‹åŠ¨å…³è”äº§å“ä¸åº“ä½</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div>
                <div class="form-group">
                    <label>é€‰æ‹©äº§å“</label>
                    <input type="text" id="manual-product-search" placeholder="æœç´¢äº§å“å‹å·ã€åç§°æˆ–è®¢è´§å·..." style="width: 100%;">
                    <div id="manual-product-results" class="product-list-container">
                        <!-- äº§å“æœç´¢ç»“æœå°†åŠ¨æ€å¡«å…… -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label>é€‰æ‹©åº“ä½</label>
                    <input type="text" id="manual-location-search" placeholder="æœç´¢åº“ä½ä»£ç ..." style="width: 100%;">
                    <div id="manual-location-results" class="location-list-container">
                        <!-- åº“ä½æœç´¢ç»“æœå°†åŠ¨æ€å¡«å…… -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label>å­˜æ”¾æ•°é‡</label>
                    <input type="number" id="manual-assignment-quantity" placeholder="è¾“å…¥æ•°é‡" min="1" style="width: 100%;">
                    <div id="quantity-info" style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                        äº§å“æ€»åº“å­˜: <span id="product-total-quantity">0</span> | 
                        å·²åˆ†é…æ•°é‡: <span id="product-allocated-quantity">0</span> | 
                        æœ€å¤§å¯åˆ†é…: <span id="product-available-quantity">0</span>
                    </div>
                </div>
                
                <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button id="confirm-manual-assignment" class="btn-sm">ç¡®è®¤å…³è”</button>
                    <button id="clear-manual-assignment" class="btn-sm">æ¸…é™¤å…³è”</button>
                    <button class="btn-sm close-modal">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è´§æ¶é…ç½®æ¨¡æ€æ¡† -->
<div id="shelf-config-modal" class="modal shelf-config-modal">
    <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
        <div class="modal-header">
            <h3>è´§æ¶é…ç½®</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- å·¦ä¾§ï¼šé…ç½®åŒºåŸŸ -->
            <div>
                <div class="config-section">
                    <h4>å…¨å±€é…ç½®</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <div class="form-group">
                            <label>è´§æ¶æ•°é‡</label>
                            <input type="number" id="global-shelf-count" min="1" max="26" value="12">
                        </div>
                        <div class="form-group">
                            <label>æ¯è´§æ¶å±‚æ•°</label>
                            <input type="number" id="global-levels-per-shelf" min="1" value="4">
                        </div>
                        <div class="form-group">
                            <label>æ¯å±‚åº“ä½æ•°</label>
                            <input type="number" id="global-slots-per-level" min="1" value="10">
                        </div>
                    </div>
                    <button id="apply-global-config" class="btn-sm">åº”ç”¨å…¨å±€é…ç½®</button>
                </div>
                
                <div class="config-section">
                    <h4>å•ä¸ªè´§æ¶é…ç½®</h4>
                    <div class="form-group">
                        <label>é€‰æ‹©è´§æ¶</label>
                        <select id="select-shelf">
                            <!-- åŠ¨æ€å¡«å……è´§æ¶é€‰é¡¹ -->
                        </select>
                    </div>
                    <div id="shelf-specific-config">
                        <!-- åŠ¨æ€ç”Ÿæˆå•ä¸ªè´§æ¶çš„é…ç½®ç•Œé¢ -->
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šé¢„è§ˆåŒºåŸŸ -->
            <div>
                <div class="config-section">
                    <h4>é…ç½®é¢„è§ˆ</h4>
                    <div id="shelf-preview" class="shelf-preview">
                        <!-- é¢„è§ˆå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        <div style="text-align: center; padding: 20px; color: #666;">
                            é¢„è§ˆå°†åœ¨è¿™é‡Œæ˜¾ç¤º
                        </div>
                    </div>
                </div>
                
                <div class="config-section">
                    <h4>æ“ä½œè¯´æ˜</h4>
                    <div style="font-size: 0.85rem; line-height: 1.4;">
                        <p>1. ä½¿ç”¨å…¨å±€é…ç½®å¿«é€Ÿè®¾ç½®æ‰€æœ‰è´§æ¶</p>
                        <p>2. é€‰æ‹©ç‰¹å®šè´§æ¶è¿›è¡Œç²¾ç»†è°ƒæ•´</p>
                        <p>3. é¢„è§ˆåŒºåŸŸæ˜¾ç¤ºå½“å‰é…ç½®æ•ˆæœ</p>
                        <p>4. è“è‰²æ–¹å—è¡¨ç¤ºå·²å ç”¨çš„åº“ä½</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
            <button id="save-shelf-config" class="btn-sm">ä¿å­˜é…ç½®</button>
            <button class="btn-sm close-modal">å–æ¶ˆ</button>
        </div>
    </div>
</div>
<!-- åœ¨ç°æœ‰çš„ script æ ‡ç­¾ä¹‹å‰æ·»åŠ  -->
<script>
    // æ›´å‡†ç¡®çš„ Supabase åŠ è½½æ£€æŸ¥
    setTimeout(() => {
        if (typeof supabase === 'undefined') {
            console.warn('Supabase JS åº“åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨æœ¬åœ°æ¨¡å¼');
        } else {
            console.log('âœ… Supabase JS åº“åŠ è½½æˆåŠŸ');
        }
    }, 1000); // ç»™åº“æ›´å¤šæ—¶é—´åŠ è½½
</script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
   <!-- æ·»åŠ å¤‡é€‰ CDN -->
<script>
    // å¦‚æœä¸»è¦CDNåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡é€‰CDN
    if (typeof supabase === 'undefined') {
        console.log('ä¸»è¦CDNåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡é€‰CDN...');
        var script = document.createElement('script');
        script.src = 'https://unpkg.com/@supabase/supabase-js@2';
        script.onload = function() {
            console.log('å¤‡é€‰CDNåŠ è½½æˆåŠŸ');
        };
        script.onerror = function() {
            console.error('æ‰€æœ‰CDNå‡åŠ è½½å¤±è´¥ï¼ŒSupabaseåŠŸèƒ½ä¸å¯ç”¨');
        };
        document.head.appendChild(script);
    }
</script>
<script>
        // ==================== æ™ºèƒ½åº“å­˜ç®¡ç†ç³»ç»Ÿ - å®Œæ•´åŠŸèƒ½ç‰ˆæœ¬ ====================
        // ==================== æ™ºèƒ½åº“å­˜ç®¡ç†ç³»ç»Ÿ - å¤šäººååŒç‰ˆæœ¬ ====================
// Supabase é…ç½® - ä½ éœ€è¦åœ¨Supabaseåå°è·å–è¿™äº›å€¼
// åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡
const SUPABASE_CONFIG = {
    url: window.env?.SUPABASE_URL || 'https://eiquzodpivfftdppchbv.supabase.co',
    anonKey: window.env?.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpcXV6b2RwaXZmZnRkcHBjaGJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MDk1OTAsImV4cCI6MjA3ODQ4NTU5MH0.QsT0S0yXAU9hN0ma7Naff1VKv7QlQTHMf5AT_L8w7nk'
};

  class InventoryManager {
    // é™æ€å®ä¾‹å˜é‡ï¼Œç”¨äºå•ä¾‹æ¨¡å¼
    static instance = null;

    constructor() {
        // å•ä¾‹æ¨¡å¼ï¼Œé˜²æ­¢é‡å¤åˆå§‹åŒ–
        if (InventoryManager.instance) {
            console.log('InventoryManager å®ä¾‹å·²å­˜åœ¨ï¼Œè¿”å›ç°æœ‰å®ä¾‹');
            return InventoryManager.instance;
        }
        InventoryManager.instance = this;
        
        // åŸºç¡€å±æ€§åˆå§‹åŒ–
        this.storagePrefix = 'inventory_';
        this.currentUser = null;
        
        // æ•°æ®æ•°ç»„åˆå§‹åŒ–
        this.inventoryData = [];
        this.alertConfig = [];
        this.locationData = [];
        
        // çŠ¶æ€å¯¹è±¡åˆå§‹åŒ–
        this.currentState = {
            searchTerm: '',
            searchType: 'all',
            sortColumn: 'entryDate',
            sortDirection: 'asc',
            showStockValue: false,
            showFIFOHighlight: false,
            showWarrantyWarning: false
        };
        
        this.backupStats = {
            autoBackupCount: 0,
            manualBackupCount: 0,
            lastBackupTime: null,
            totalBackupSize: 0
        };

        // åˆå§‹åŒ–æ ‡å¿—
        this.initialized = false;
        this.initializing = false;
        
        // äº‹ä»¶ç»‘å®šæ ‡å¿— - ç¡®ä¿æ˜¯å¯¹è±¡ç»“æ„
        this.eventsBound = {
            main: false,
            alertsPage: false,
            databasePage: false,
            inventoryPage: false,
            locationPage: false,
            analysisPage: false,
            settingsPage: false
        };

        // å¯¼å…¥çŠ¶æ€æ ‡å¿—
        this.importInProgress = false;
        
        // å½“å‰é¡µé¢è·Ÿè¸ª
        this.currentPage = null;

        // åˆå§‹åŒ– Supabase
        this.initSupabase();
        // é…ç½®åˆå§‹åŒ–
        this.shelfConfig = this.loadShelfConfig();
        
        // å¤‡ä»½é…ç½®
        this.backupConfig = {
            autoBackupInterval: 30 * 60 * 1000,
            maxBackupVersions: 10,
            backupPrefix: 'inventory_backup_'
        };
        
        // UI çŠ¶æ€
        this.highlightedSlots = [];
        this.selectedManualProduct = null;
        this.selectedManualLocation = null;

        // é¢„è­¦é¡µé¢çŠ¶æ€
        this.alertsPageState = {
            currentPage: 1,
            itemsPerPage: 10,
            currentView: 'table',
            searchTerm: '',
            statusFilter: 'all'
        };
        
        // åŠŸèƒ½æ ‡å¿—
        this.excelSupported = false;
        
        console.log('InventoryManager æ„é€ å‡½æ•°å®Œæˆ');
        
        // ç°åœ¨å¯ä»¥å®‰å…¨åˆå§‹åŒ–
        this.init();
    }




// åˆå§‹åŒ– Supabase
    initSupabase() {
        try {
            console.log('åˆå§‹åŒ– Supabase...');
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–
            if (this.supabase) {
                console.log('Supabase å·²ç»åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
                return;
            }
            
            // æ£€æŸ¥ Supabase åº“æ˜¯å¦åŠ è½½
           if (typeof supabase === 'undefined') {
            console.error('Supabase JS åº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–CDNé“¾æ¥');
            this.supabase = null;
            return;
          }

            // æ£€æŸ¥ Supabase é…ç½®
            if (!SUPABASE_CONFIG.url || !SUPABASE_CONFIG.anonKey) {
                console.warn('Supabase é…ç½®ä¸å®Œæ•´ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼');
                this.supabase = null;
                return;
            }

            console.log('Supabase é…ç½®:', {
            url: SUPABASE_CONFIG.url,
            anonKey: SUPABASE_CONFIG.anonKey ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'
            });

            // åˆ›å»º Supabase å®¢æˆ·ç«¯
            this.supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
            
            if (!this.supabase) {
                console.warn('Supabase å®¢æˆ·ç«¯åˆ›å»ºå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼');
                return;
            }    

            console.log('Supabase åˆå§‹åŒ–æˆåŠŸï¼Œè®¾ç½®è®¤è¯ç›‘å¬...');
            
            // è®¾ç½®è®¤è¯çŠ¶æ€ç›‘å¬ - æ·»åŠ é˜²é‡å¤å¤„ç†
            let authHandlerSet = false;
            
            this.supabase.auth.onAuthStateChange((event, session) => {
                // é˜²æ­¢é‡å¤å¤„ç†
                if (authHandlerSet) {
                    console.log('è®¤è¯çŠ¶æ€å˜åŒ–ï¼ˆå·²å¤„ç†è¿‡ï¼‰:', event);
                    return;
                }
                
                console.log('Supabase è®¤è¯çŠ¶æ€å˜åŒ–:', event, session);
                
                if (event === 'SIGNED_IN' && session) {
                    this.currentUser = {
                        id: session.user.id,
                        email: session.user.email,
                        username: session.user.user_metadata?.username || session.user.email.split('@')[0]
                    };
                    console.log('ç”¨æˆ·å·²ç™»å½•:', this.currentUser);
                    this.showMainApp();
                    
                    // æ ‡è®°å·²å¤„ç†ï¼Œé˜²æ­¢é‡å¤
                    authHandlerSet = true;
                } else if (event === 'SIGNED_OUT') {
                    this.currentUser = null;
                    console.log('ç”¨æˆ·å·²é€€å‡º');
                    this.showLoginPage();
                }
            });
            
            // è·å–å½“å‰ä¼šè¯
            this.supabase.auth.getSession().then(({ data: { session } }) => {
                console.log('å½“å‰ä¼šè¯:', session);
                if (session && session.user) {
                    this.currentUser = {
                        id: session.user.id,
                        email: session.user.email,
                        username: session.user.user_metadata?.username || session.user.email.split('@')[0]
                    };
                    console.log('æ‰¾åˆ°ç°æœ‰ä¼šè¯ï¼Œç”¨æˆ·:', this.currentUser);
                    this.showMainApp();
                    
                    // æ ‡è®°å·²å¤„ç†ï¼Œé˜²æ­¢é‡å¤
                    authHandlerSet = true;
                }
            });
        // æµ‹è¯•è¿æ¥
        this.testSupabaseConnection();            

        } catch (error) {
            console.error('Supabase åˆå§‹åŒ–å¤±è´¥:', error);
            this.supabase = null;
        }
    }
            
    // ä¿®æ”¹åˆå§‹åŒ–æ–¹æ³•
    async init() {
        // é˜²æ­¢é‡å¤åˆå§‹åŒ–
        if (this.initialized || this.initializing) {
            console.log('ç³»ç»Ÿå·²ç»åˆå§‹åŒ–æˆ–æ­£åœ¨åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
            return;
        }
        
        this.initializing = true;
        console.log('å¼€å§‹ç³»ç»Ÿåˆå§‹åŒ–...');
        
        this.checkExcelSupport();
        await this.loadFromStorage();
        this.setupEventListeners();
        await this.checkLoginStatus();
        
        this.initialized = true;
        this.initializing = false;
        console.log('åº“å­˜ç®¡ç†ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
    }

     // æ·»åŠ è¿æ¥æµ‹è¯•æ–¹æ³•
   // ä¿®æ”¹æµ‹è¯•è¿æ¥æ–¹æ³•ï¼Œæ·»åŠ ç»“æœæ˜¾ç¤º
async testSupabaseConnection() {
    const resultElement = document.getElementById('connection-test-result');
    
    if (!this.supabase) {
        if (resultElement) {
            resultElement.textContent = 'âŒ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–';
            resultElement.style.color = '#e74c3c';
        }
        return;
    }
    
    try {
        if (resultElement) {
            resultElement.textContent = 'æµ‹è¯•ä¸­...';
            resultElement.style.color = '#f39c12';
        }
        
        console.log('å¼€å§‹ Supabase è¿æ¥æµ‹è¯•...');
        
        // æµ‹è¯•1: æ£€æŸ¥è®¤è¯çŠ¶æ€
        const { data: authData, error: authError } = await this.supabase.auth.getSession();
        console.log('è®¤è¯æµ‹è¯•:', authError ? `å¤±è´¥: ${authError.message}` : 'æˆåŠŸ', authData);
        
        // æµ‹è¯•2: æµ‹è¯•æ•°æ®åº“è¿æ¥
        const { data: testData, error: testError } = await this.supabase
            .from('inventory_data')
            .select('count')
            .limit(1);
            
        console.log('æ•°æ®åº“è¿æ¥æµ‹è¯•:', testError ? `å¤±è´¥: ${testError.message}` : 'æˆåŠŸ');
        
        let message = '';
        let color = '#27ae60';
        
        if (!authError && !testError) {
            message = 'âœ… è¿æ¥æµ‹è¯•å…¨éƒ¨é€šè¿‡';
        } else if (authError && testError) {
            message = 'âŒ è®¤è¯å’Œæ•°æ®åº“è¿æ¥å‡å¤±è´¥';
            color = '#e74c3c';
        } else if (authError) {
            message = 'âš ï¸ è®¤è¯å¤±è´¥ä½†æ•°æ®åº“å¯è¿æ¥';
            color = '#f39c12';
        } else {
            message = 'âš ï¸ è®¤è¯æˆåŠŸä½†æ•°æ®åº“è¿æ¥å¤±è´¥';
            color = '#f39c12';
        }
        
        if (resultElement) {
            resultElement.textContent = message;
            resultElement.style.color = color;
        }
        
        // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
        this.updateConnectionStatus();
        
    } catch (error) {
        console.error('Supabase è¿æ¥æµ‹è¯•å¼‚å¸¸:', error);
        if (resultElement) {
            resultElement.textContent = 'âŒ è¿æ¥æµ‹è¯•å¼‚å¸¸: ' + error.message;
            resultElement.style.color = '#e74c3c';
        }
    }
}

// === æ–°å¢å¤‡ä»½ç³»ç»Ÿæ–¹æ³• ===
setupBackupSystem() {
    // è‡ªåŠ¨å¤‡ä»½å®šæ—¶å™¨
    this.autoBackupTimer = setInterval(() => {
        this.createAutoBackup();
    }, this.backupConfig.autoBackupInterval);

    // ç›‘å¬é¡µé¢å…³é—­äº‹ä»¶
    window.addEventListener('beforeunload', () => {
        this.createBackup('before_unload');
    });

    // ç›‘å¬å…³é”®æ“ä½œï¼Œå®æ—¶å¤‡ä»½
    this.setupCriticalOperationBackups();
}

setupCriticalOperationBackups() {
    // åœ¨å…³é”®æ“ä½œå‰åˆ›å»ºå¤‡ä»½
    const criticalOperations = [
        'process-inventory-import',
        'manual-assign-btn',
        'configure-shelves-btn',
        'save-shelf-config'
    ];
    
    criticalOperations.forEach(opId => {
        const element = document.getElementById(opId);
        if (element) {
            element.addEventListener('click', () => {
                this.createBackup(`pre_${opId}`);
            });
        }
    });
}

setupLocationBackupSystem() {
    // åº“ä½å˜æ›´ç›‘å¬
    const originalSaveToStorage = this.saveToStorage.bind(this);
    this.saveToStorage = () => {
        originalSaveToStorage();
        this.backupLocationRelationships();
    };
}

// åˆ›å»ºè‡ªåŠ¨å¤‡ä»½
createAutoBackup() {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const backupKey = `${this.backupConfig.backupPrefix}auto_${timestamp}`;
    
    const backupData = this.generateCompleteBackup();
    this.saveBackupToStorage(backupKey, backupData);
    
    this.cleanupOldBackups();
    console.log(`è‡ªåŠ¨å¤‡ä»½å®Œæˆ: ${timestamp}`);
}

// åˆ›å»ºæ‰‹åŠ¨å¤‡ä»½
createBackup(type = 'manual') {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const backupKey = `${this.backupConfig.backupPrefix}${type}_${timestamp}`;
    
    const backupData = this.generateCompleteBackup();
    this.saveBackupToStorage(backupKey, backupData);
    
    this.cleanupOldBackups();
    return backupKey;
}

// ç”Ÿæˆå®Œæ•´å¤‡ä»½æ•°æ®
generateCompleteBackup() {
    return {
        metadata: {
            version: '2.0',
            backupTime: new Date().toISOString(),
            dataSize: this.calculateDataSize(),
            user: this.currentUser?.username || 'unknown'
        },
        // æ ¸å¿ƒæ•°æ®
        inventoryData: this.inventoryData,
        alertConfig: this.alertConfig,
        locationData: this.locationData,
        shelfConfig: this.shelfConfig,
        
        // åº“ä½å…³ç³»ä¸“é¡¹å¤‡ä»½
        locationRelationships: this.generateLocationRelationships(),
        
        // ç»Ÿè®¡ä¿¡æ¯ï¼ˆç”¨äºéªŒè¯ï¼‰
        stats: {
            totalProducts: this.inventoryData.length,
            totalLocations: this.locationData.length,
            occupiedSlots: this.calculateOccupiedSlots(),
            alertConfigs: this.alertConfig.length
        }
    };
}

// ç”Ÿæˆåº“ä½å…³ç³»ä¸“é¡¹æ•°æ®
generateLocationRelationships() {
    const relationships = {};
    
    this.locationData.forEach(location => {
        const product = this.inventoryData.find(p => p.model === location.productModel);
        if (product) {
            relationships[location.locationCode] = {
                locationCode: location.locationCode,
                productModel: location.productModel,
                productName: product.name,
                productBrand: product.brand,
                productOrderNumber: product.orderNumber,
                quantity: location.quantity,
                lastUpdated: location.lastUpdated,
                totalStock: this.calculateProductQuantity(product.model).total
            };
        }
    });
    
    return relationships;
}

// åº“ä½å…³ç³»ä¸“é¡¹å¤‡ä»½
backupLocationRelationships() {
    const locationBackup = {
        backupTime: new Date().toISOString(),
        locationData: this.locationData,
        relationships: this.generateLocationRelationships(),
        shelfConfig: this.shelfConfig
    };
    
    const backupKey = `${this.backupConfig.backupPrefix}location_${Date.now()}`;
    this.saveBackupToStorage(backupKey, locationBackup);
}

// ä¿å­˜å¤‡ä»½åˆ°å­˜å‚¨
saveBackupToStorage(key, data) {
    try {
        localStorage.setItem(key, JSON.stringify(data));
        return true;
    } catch (e) {
        console.error('å¤‡ä»½ä¿å­˜å¤±è´¥:', e);
        this.triggerLocalDownload(key, data);
        return false;
    }
}

// æœ¬åœ°ä¸‹è½½å¤‡ä»½ï¼ˆå½“localStorageæ»¡æ—¶ï¼‰
triggerLocalDownload(filename, data) {
    const dataStr = JSON.stringify(data, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${filename}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// æ¸…ç†æ—§å¤‡ä»½
cleanupOldBackups() {
    const backups = this.getBackupList();
    if (backups.length <= this.backupConfig.maxBackupVersions) {
        return 0;
    }
    
    const toDelete = backups.slice(this.backupConfig.maxBackupVersions);
    toDelete.forEach(backup => {
        localStorage.removeItem(backup.key);
    });
    
    console.log(`æ¸…ç†äº† ${toDelete.length} ä¸ªæ—§å¤‡ä»½`);
    return toDelete.length;
}

// è·å–å¤‡ä»½åˆ—è¡¨
getBackupList() {
    const backups = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith(this.backupConfig.backupPrefix)) {
            try {
                const data = JSON.parse(localStorage.getItem(key));
                backups.push({
                    key: key,
                    time: data.metadata?.backupTime,
                    size: data.metadata?.dataSize,
                    type: key.includes('manual') ? 'manual' : 'auto'
                });
            } catch (e) {
                // æ— æ•ˆå¤‡ä»½ï¼Œè·³è¿‡
            }
        }
    }
    return backups.sort((a, b) => new Date(b.time) - new Date(a.time));
}

// è®¡ç®—æ•°æ®å¤§å°
calculateDataSize() {
    const data = {
        inventoryData: this.inventoryData,
        alertConfig: this.alertConfig,
        locationData: this.locationData,
        shelfConfig: this.shelfConfig
    };
    return JSON.stringify(data).length;
}

// è®¡ç®—å·²å ç”¨åº“ä½æ•°é‡
calculateOccupiedSlots() {
    return this.locationData.length;
}

// æ˜¾ç¤ºæ¢å¤æ¨¡æ€æ¡†
showRestoreModal() {
    const backups = this.getBackupList();
    
    // åˆ›å»ºæ¢å¤ç•Œé¢
    const modalHtml = `
        <div class="modal" id="restore-modal" style="display: flex;">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h3>æ•°æ®æ¢å¤ç®¡ç†</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div>
                    <h4>å¯ç”¨å¤‡ä»½</h4>
                    <div style="max-height: 300px; overflow-y: auto; margin: 15px 0;">
                        ${backups.map(backup => `
                            <div class="backup-item" style="padding: 10px; border: 1px solid #ddd; margin: 5px 0; border-radius: 4px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <div>
                                        <strong>${new Date(backup.time).toLocaleString()}</strong>
                                        <span style="margin-left: 10px; color: #666;">${backup.type === 'manual' ? 'æ‰‹åŠ¨' : 'è‡ªåŠ¨'}å¤‡ä»½</span>
                                    </div>
                                    <div>
                                        <button class="btn-sm" onclick="inventoryManager.restoreFromBackup('${backup.key}')">
                                            æ¢å¤æ•°æ®
                                        </button>
                                        <button class="btn-sm" onclick="inventoryManager.restoreLocationOnly('${backup.key}')" 
                                                style="background: #3498db;">
                                            ä»…æ¢å¤åº“ä½
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                        ${backups.length === 0 ? '<div style="text-align: center; padding: 20px;">æš‚æ— å¤‡ä»½æ•°æ®</div>' : ''}
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
                        <h4>æ¢å¤é€‰é¡¹</h4>
                        <div>
                            <button class="btn-sm" onclick="inventoryManager.exportLocationRelationshipsReport()">
                                å¯¼å‡ºåº“ä½å…³ç³»æŠ¥è¡¨
                            </button>
                            <button class="btn-sm" onclick="inventoryManager.importLocationBackup()" style="background: #2ecc71;">
                                å¯¼å…¥åº“ä½å¤‡ä»½
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// ä»å¤‡ä»½æ¢å¤
restoreFromBackup(backupKey) {
    try {
        const backupData = JSON.parse(localStorage.getItem(backupKey));
        
        if (!backupData || !backupData.inventoryData) {
            alert('å¤‡ä»½æ•°æ®æ— æ•ˆ');
            return;
        }
        
        if (confirm(`ç¡®å®šè¦ä» ${new Date(backupData.metadata.backupTime).toLocaleString()} çš„å¤‡ä»½æ¢å¤æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ã€‚`)) {
            this.inventoryData = backupData.inventoryData;
            this.alertConfig = backupData.alertConfig;
            this.locationData = backupData.locationData;
            this.shelfConfig = backupData.shelfConfig;
            
            this.saveToStorage();
            this.onInventoryDataChanged();
            
            alert('æ•°æ®æ¢å¤æˆåŠŸï¼');
            const modal = document.getElementById('restore-modal');
            if (modal) modal.style.display = 'none';
        }
    } catch (error) {
        alert('æ¢å¤å¤±è´¥: ' + error.message);
    }
}

// ä»…æ¢å¤åº“ä½æ•°æ®
restoreLocationOnly(backupKey) {
    try {
        const backupData = JSON.parse(localStorage.getItem(backupKey));
        
        if (!backupData || !backupData.locationData) {
            alert('å¤‡ä»½æ•°æ®æ— æ•ˆæˆ–æ²¡æœ‰åº“ä½æ•°æ®');
            return;
        }
        
        if (confirm(`ç¡®å®šè¦æ¢å¤ ${new Date(backupData.metadata.backupTime).toLocaleString()} çš„åº“ä½æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰çš„åº“ä½åˆ†é…ã€‚`)) {
            this.locationData = backupData.locationData;
            this.shelfConfig = backupData.shelfConfig;
            
            this.saveToStorage();
            this.renderShelves();
            this.updateCurrentLocationDisplay();
            
            alert('åº“ä½æ•°æ®æ¢å¤æˆåŠŸï¼');
            const modal = document.getElementById('restore-modal');
            if (modal) modal.style.display = 'none';
        }
    } catch (error) {
        alert('åº“ä½æ¢å¤å¤±è´¥: ' + error.message);
    }
}

// å¯¼å…¥åº“ä½å¤‡ä»½æ–‡ä»¶
importLocationBackup() {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';
    
    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = (e) => {
            try {
                const backupData = JSON.parse(e.target.result);
                
                if (!backupData.locationData) {
                    alert('æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„åº“ä½å¤‡ä»½');
                    return;
                }
                
                if (confirm('ç¡®å®šè¦å¯¼å…¥åº“ä½å¤‡ä»½å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰çš„åº“ä½åˆ†é…ã€‚')) {
                    this.locationData = backupData.locationData;
                    if (backupData.shelfConfig) {
                        this.shelfConfig = backupData.shelfConfig;
                    }
                    
                    this.saveToStorage();
                    this.renderShelves();
                    this.updateCurrentLocationDisplay();
                    
                    alert('åº“ä½å¤‡ä»½å¯¼å…¥æˆåŠŸï¼');
                    const modal = document.getElementById('restore-modal');
                    if (modal) modal.style.display = 'none';
                }
            } catch (error) {
                alert('å¯¼å…¥å¤±è´¥: ' + error.message);
            }
        };
        
        reader.readAsText(file);
    };
    
    fileInput.click();
}
 
// å¯¼å‡ºåº“ä½å…³ç³»æŠ¥è¡¨
exportLocationRelationshipsReport() {
    const relationships = this.generateLocationRelationships();
    const reportData = Object.values(relationships).map(rel => ({
        'åº“ä½ç¼–ç ': rel.locationCode,
        'äº§å“å‹å·': rel.productModel,
        'äº§å“åç§°': rel.productName,
        'äº§å“å“ç‰Œ': rel.productBrand,
        'è®¢è´§å·': rel.productOrderNumber,
        'åº“ä½æ•°é‡': rel.quantity,
        'äº§å“æ€»åº“å­˜': rel.totalStock,
        'æœ€åæ›´æ–°': rel.lastUpdated
    }));

    if (reportData.length === 0) {
        alert('æ²¡æœ‰åº“ä½å…³ç³»æ•°æ®å¯å¯¼å‡º');
        return;
    }

    // åˆ›å»ºExcelå·¥ä½œè¡¨
    const worksheet = XLSX.utils.json_to_sheet(reportData);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, 'åº“ä½å…³ç³»æŠ¥è¡¨');
    
    // å¯¼å‡ºæ–‡ä»¶
    XLSX.writeFile(workbook, `åº“ä½å…³ç³»æŠ¥è¡¨_${new Date().toISOString().split('T')[0]}.xlsx`);
    
    alert(`åº“ä½å…³ç³»æŠ¥è¡¨å¯¼å‡ºæˆåŠŸï¼Œå…± ${reportData.length} æ¡è®°å½•`);
}      


            // æ£€æŸ¥Excelæ”¯æŒ
    checkExcelSupport() {
        this.excelSupported = typeof XLSX !== 'undefined';
        if (!this.excelSupported) {
            console.warn('ExcelåŠŸèƒ½ä¸å¯ç”¨ï¼šXLSXåº“æœªåŠ è½½');
        }
    }
            
            // å­˜å‚¨ç®¡ç†
    setStorage(key, value) {
        localStorage.setItem(this.storagePrefix + key, JSON.stringify(value));
    }
            
            getStorage(key) {
        const item = localStorage.getItem(this.storagePrefix + key);
        return item ? JSON.parse(item) : null;
    }
            
          // ä¿®æ”¹æ•°æ®åŠ è½½æ–¹æ³•
    async loadFromStorage() {
        try {
            // é¦–å…ˆå°è¯•ä» Supabase åŠ è½½
            if (this.supabase && this.currentUser) {
                await this.loadFromSupabase();
            } else {
                // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
                this.loadFromLocalStorage();
            }
        } catch (error) {
            console.error('æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨:', error);
            this.loadFromLocalStorage();
        }
        
        // ç¡®ä¿ currentState å­˜åœ¨åå†è®¾ç½®å±æ€§
        if (!this.currentState) {
            this.currentState = {
                searchTerm: '',
                searchType: 'all',
                sortColumn: 'entryDate',
                sortDirection: 'asc',
                showStockValue: false,
                showFIFOHighlight: false,
                showWarrantyWarning: false
            };
        }
        
        // å®‰å…¨åœ°è®¾ç½®å±æ€§
        const savedShowStockValue = this.getStorage('showStockValue');
        const savedShowFIFOHighlight = this.getStorage('showFIFOHighlight');
        const savedShowWarrantyWarning = this.getStorage('showWarrantyWarning');
        
        if (this.currentState) {
            this.currentState.showStockValue = savedShowStockValue !== null ? savedShowStockValue : false;
            this.currentState.showFIFOHighlight = savedShowFIFOHighlight !== null ? savedShowFIFOHighlight : false;
            this.currentState.showWarrantyWarning = savedShowWarrantyWarning !== null ? savedShowWarrantyWarning : false;
        }
    }

// ä» Supabase åŠ è½½æ•°æ®
    // ä» Supabase åŠ è½½æ•°æ®
    async loadFromSupabase() {
        console.log('ä» Supabase åŠ è½½æ•°æ®...');
        
        try {
            // åŠ è½½åº“å­˜æ•°æ® - å°†è›‡å½¢å‘½åæ³•è½¬å›é©¼å³°å‘½åæ³•
            const { data: inventoryData, error: inventoryError } = await this.supabase
                .from('inventory_data')
                .select('*')
                .order('created_at', { ascending: false });
                
            if (!inventoryError && inventoryData) {
                this.inventoryData = inventoryData.map(item => ({
                    brand: item.brand,
                    series: item.series,
                    name: item.name,
                    model: item.model,
                    orderNumber: item.order_number,
                    clientCode: item.client_code,
                    clientName: item.client_name,
                    unit: item.unit,
                    availableQty: item.available_qty,
                    stockQty: item.stock_qty,
                    purchasePrice: item.purchase_price,
                    stockValue: item.stock_value,
                    warehouse: item.warehouse,
                    stockType: item.stock_type,
                    shelf: item.shelf,
                    stockNote: item.stock_note,
                    actualPrice: item.actual_price,
                    actualValue: item.actual_value,
                    purchaseOrder: item.purchase_order,
                    supplierOrder: item.supplier_order,
                    salesOrder: item.sales_order,
                    taxRate: item.tax_rate,
                    supplierCode: item.supplier_code,
                    supplierName: item.supplier_name,
                    unitName: item.unit_name,
                    salesman: item.salesman,
                    purchaser: item.purchaser,
                    salesDept: item.sales_dept,
                    entryDate: item.entry_date
                }));
            }
            
            // åŠ è½½é¢„è­¦é…ç½®
            const { data: alertConfig, error: alertError } = await this.supabase
                .from('alert_config')
                .select('*');
                
            if (!alertError && alertConfig) {
                this.alertConfig = alertConfig.map(config => ({
                    brand: config.brand,
                    name: config.name,
                    model: config.model,
                    orderNumber: config.order_number,
                    minStock: config.min_stock,
                    maxStock: config.max_stock
                }));
            }
            
            // åŠ è½½åº“ä½æ•°æ®
            const { data: locationData, error: locationError } = await this.supabase
                .from('location_data')
                .select('*');
                
            if (!locationError && locationData) {
                this.locationData = locationData.map(location => ({
                    locationCode: location.location_code,
                    productModel: location.product_model,
                    orderNumber: location.order_number,
                    quantity: location.quantity,
                    lastUpdated: location.last_updated
                }));
            }
            
            console.log('Supabase æ•°æ®åŠ è½½å®Œæˆ:', {
                inventory: this.inventoryData.length,
                alerts: this.alertConfig.length,
                locations: this.locationData.length
            });
            
        } catch (error) {
            console.error('Supabase æ•°æ®åŠ è½½é”™è¯¯:', error);
            throw error;
        }
    }
         
// ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
    loadFromLocalStorage() {
        console.log('ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®...');
        this.inventoryData = this.getStorage('inventoryData') || [];
        this.alertConfig = this.getStorage('alertConfig') || [];
        this.locationData = this.getStorage('locationData') || [];
    }
   
    // ä¿®æ”¹æ•°æ®ä¿å­˜æ–¹æ³•
    async saveToStorage() {
        try {
            // é¦–å…ˆå°è¯•ä¿å­˜åˆ° Supabase
            if (this.supabase && this.currentUser) {
                await this.saveToSupabase();
            }
            
            // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ä½œä¸ºå¤‡ä»½
            this.saveToLocalStorage();
            
        } catch (error) {
            console.error('Supabase ä¿å­˜å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨:', error);
            this.saveToLocalStorage();
        }
    }

// ä¿å­˜æ•°æ®åˆ° Supabase
    // ä¿®æ”¹ saveToSupabase æ–¹æ³•ï¼Œä½¿ç”¨å‹å·ä½œä¸ºä¸»è¦æ ‡è¯†
// ä¿®æ”¹ saveToSupabase æ–¹æ³•
async saveToSupabase() {
    console.log('ä¿å­˜æ•°æ®åˆ° Supabase...');
    
    try {
        // åˆ†æ‰¹ä¿å­˜åº“å­˜æ•°æ®ï¼Œé¿å…ä¸€æ¬¡æ€§æäº¤å¤ªå¤šæ•°æ®
        if (this.inventoryData.length > 0) {
            const batchSize = 50; // æ¯æ‰¹50æ¡è®°å½•
            const batches = [];
            
            for (let i = 0; i < this.inventoryData.length; i += batchSize) {
                batches.push(this.inventoryData.slice(i, i + batchSize));
            }
            
            let successCount = 0;
            let errorCount = 0;
            
            for (const batch of batches) {
                const batchData = batch.map(item => ({
                    brand: item.brand,
                    name: item.name,
                    model: item.model,
                    order_number: item.orderNumber,
                    client_name: item.clientName,
                    available_qty: parseInt(item.availableQty) || 0,
                    stock_qty: parseInt(item.stockQty) || 0,
                    purchase_price: parseFloat(item.purchasePrice) || 0,
                    stock_value: parseFloat(item.stockValue) || 0,
                    warehouse: item.warehouse,
                    stock_type: item.stockType,
                    shelf: item.shelf,
                    entry_date: item.entryDate,
                    user_id: this.currentUser?.id || 'local-user'
                }));
                
                try {
                    const { error } = await this.supabase
                        .from('inventory_data')
                        .upsert(batchData, { 
                            onConflict: 'model,user_id',
                            ignoreDuplicates: false
                        });
                    
                    if (error) {
                        console.error('æ‰¹æ¬¡ä¿å­˜å¤±è´¥:', error);
                        errorCount += batch.length;
                        
                        // å¦‚æœupsertå¤±è´¥ï¼Œå°è¯•é€æ¡æ’å…¥
                        for (const item of batchData) {
                            try {
                                const { error: singleError } = await this.supabase
                                    .from('inventory_data')
                                    .insert(item);
                                
                                if (singleError) {
                                    console.error('å•æ¡è®°å½•æ’å…¥å¤±è´¥:', singleError);
                                } else {
                                    successCount++;
                                }
                            } catch (singleError) {
                                console.error('å•æ¡è®°å½•æ’å…¥å¼‚å¸¸:', singleError);
                            }
                        }
                    } else {
                        successCount += batch.length;
                    }
                } catch (batchError) {
                    console.error('æ‰¹æ¬¡å¤„ç†å¼‚å¸¸:', batchError);
                    errorCount += batch.length;
                }
            }
            
            console.log(`åº“å­˜æ•°æ®ä¿å­˜å®Œæˆ: æˆåŠŸ ${successCount} æ¡, å¤±è´¥ ${errorCount} æ¡`);
        }
        
        // ç±»ä¼¼çš„é€»è¾‘å¤„ç†åº“ä½æ•°æ®...
        
    } catch (error) {
        console.error('Supabase ä¿å­˜é”™è¯¯:', error);
        this.saveToLocalStorage();
    }
}


// ä¿®æ”¹é¢„è­¦é…ç½®ä¿å­˜ï¼ŒåŒæ ·ä½¿ç”¨å‹å·ä½œä¸ºæ ‡è¯†
async saveAlertConfig() {
    if (this.alertConfig.length > 0) {
        const alertConfigToSave = this.alertConfig.map(config => ({
            brand: config.brand,
            name: config.name,
            model: config.model,  // ä¸»è¦æ ‡è¯†
            order_number: config.orderNumber,  // å¯é€‰å­—æ®µ
            min_stock: parseInt(config.minStock) || 5,
            max_stock: parseInt(config.maxStock) || 100,
            user_id: this.currentUser?.id || 'local-user'
        }));

        const { error: alertError } = await this.supabase
            .from('alert_config')
            .upsert(alertConfigToSave);
            
        if (alertError) {
            console.error('é¢„è­¦é…ç½®ä¿å­˜å¤±è´¥:', alertError);
        }
    }
}


// ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
    saveToLocalStorage() {
        this.setStorage('inventoryData', this.inventoryData);
        this.setStorage('alertConfig', this.alertConfig);
        this.setStorage('locationData', this.locationData);
        this.setStorage('shelfConfig', this.shelfConfig);
        this.setStorage('showStockValue', this.currentState.showStockValue);
        this.setStorage('showFIFOHighlight', this.currentState.showFIFOHighlight);
        this.setStorage('showWarrantyWarning', this.currentState.showWarrantyWarning);
    }
// è®¾ç½®å®æ—¶æ•°æ®åŒæ­¥
    // å¢å¼ºçš„å®æ—¶åŒæ­¥åŠŸèƒ½
setupRealtimeSync() {
    if (!this.supabase) {
        console.warn('Supabase æœªåˆå§‹åŒ–ï¼Œæ— æ³•å¯åŠ¨å®æ—¶åŒæ­¥');
        return;
    }

    try {
        console.log('å¯åŠ¨å®æ—¶æ•°æ®åŒæ­¥...');
        
        // åº“å­˜æ•°æ®å®æ—¶åŒæ­¥
        this.supabase
            .channel('inventory-sync')
            .on('postgres_changes', 
                { 
                    event: '*', 
                    schema: 'public', 
                    table: 'inventory_data',
                    filter: `user_id=eq.${this.currentUser?.id}`
                },
                (payload) => {
                    console.log('åº“å­˜æ•°æ®å˜åŒ–:', payload);
                    this.handleInventoryUpdate(payload);
                }
            )
            .subscribe((status) => {
                console.log('åº“å­˜æ•°æ®è®¢é˜…çŠ¶æ€:', status);
            });

        // é¢„è­¦é…ç½®å®æ—¶åŒæ­¥
        this.supabase
            .channel('alert-sync')
            .on('postgres_changes',
                { 
                    event: '*', 
                    schema: 'public', 
                    table: 'alert_config',
                    filter: `user_id=eq.${this.currentUser?.id}`
                },
                (payload) => {
                    console.log('é¢„è­¦é…ç½®å˜åŒ–:', payload);
                    this.handleAlertUpdate(payload);
                }
            )
            .subscribe((status) => {
                console.log('é¢„è­¦é…ç½®è®¢é˜…çŠ¶æ€:', status);
            });

        // åº“ä½æ•°æ®å®æ—¶åŒæ­¥
        this.supabase
            .channel('location-sync')
            .on('postgres_changes',
                { 
                    event: '*', 
                    schema: 'public', 
                    table: 'location_data',
                    filter: `user_id=eq.${this.currentUser?.id}`
                },
                (payload) => {
                    console.log('åº“ä½æ•°æ®å˜åŒ–:', payload);
                    this.handleLocationUpdate(payload);
                }
            )
            .subscribe((status) => {
                console.log('åº“ä½æ•°æ®è®¢é˜…çŠ¶æ€:', status);
            });

    } catch (error) {
        console.error('å®æ—¶åŒæ­¥è®¾ç½®å¤±è´¥:', error);
    }
}
            
           // è´§æ¶é…ç½®ç®¡ç†
    loadShelfConfig() {
        const savedConfig = this.getStorage('shelfConfig');
        return savedConfig || {
            shelfCount: 12,
            levelsPerShelf: 4,
            slotsPerLevel: 10,
            individualConfig: {}
        };
    }
            
     saveShelfConfig() {
        this.setStorage('shelfConfig', this.shelfConfig);
    }

            
          // äº‹ä»¶ç›‘å¬è®¾ç½®
    setupEventListeners() {
        // ç¡®ä¿ eventsBound ç»“æ„æ­£ç¡®
        this.ensureEventsBoundStructure();
        
        // ä½¿ç”¨æ ‡å¿—ä½é˜²æ­¢é‡å¤ç»‘å®š
        if (this.eventsBound.main) {
            console.log('ä¸»äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®šï¼Œè·³è¿‡é‡å¤ç»‘å®š');
            return;
        }
        
        console.log('å¼€å§‹ç»‘å®šä¸»äº‹ä»¶ç›‘å¬å™¨...');
        
        // ç™»å½•ç›¸å…³
        this.addEventListener('login-btn', 'click', () => this.handleLogin());
        this.addEventListener('logout-btn', 'click', () => this.handleLogout());
        
        // æ•°æ®åº“ç®¡ç† - åªç»‘å®šä¸€æ¬¡
        this.addEventListener('process-inventory-import', 'click', () => this.importInventoryData());
        
        // å¯¼èˆª
        this.addEventListener('.sidebar', 'click', (e) => {
            const navItem = e.target.closest('.nav-item');
            if (navItem) {
                this.handleNavigation(navItem);
            }
        });
        
        // åº“å­˜ç®¡ç†
        this.addEventListener('search-btn', 'click', () => this.handleSearch());
        this.addEventListener('reset-search', 'click', () => this.resetSearch());
        this.addEventListener('toggle-stock-value', 'click', () => this.toggleStockValue());
        this.addEventListener('toggle-fifo-highlight', 'click', () => this.toggleFIFOHighlight());
        this.addEventListener('show-warranty-warning', 'click', () => this.toggleWarrantyWarning());
        this.addEventListener('inventory-filter', 'change', () => this.renderInventoryList());
        this.addEventListener('process-inventory-import', 'click', () => this.importInventoryData());
        // è¡¨å¤´æ’åº
        this.delegateEventListener('.page-content', 'click', 'th.sortable', (e) => {
            this.handleSort(e.target);
        });
        
        // æ•°æ®åº“ç®¡ç†
        this.addEventListener('backup-data', 'click', () => this.createBackup());
        this.addEventListener('restore-data', 'click', () => this.showRestoreModal());
        this.addEventListener('export-location-report', 'click', () => this.exportLocationRelationshipsReport());
        
        // é¢„è­¦ç®¡ç†
        this.addEventListener('add-alert-product', 'click', () => this.showAddAlertModal());
        this.addEventListener('save-alert-product', 'click', () => this.saveAlertProduct());
        
        // FIFOæŠ¥å‘Š
        this.addEventListener('export-fifo-report', 'click', () => this.exportFIFOReport());
        
        // åº“ä½ç®¡ç†
        this.addEventListener('manual-assign-btn', 'click', () => this.openManualAssignmentModal());
        this.addEventListener('configure-shelves-btn', 'click', () => this.openShelfConfigModal());
        this.addEventListener('view-product-location', 'click', () => this.viewProductLocation());
        this.addEventListener('clear-product-search', 'click', () => this.clearProductSearch());
        
        // æ‰‹åŠ¨å…³è”æ¨¡æ€æ¡†
        this.addEventListener('confirm-manual-assignment', 'click', () => this.confirmManualAssignment());
        this.addEventListener('clear-manual-assignment', 'click', () => this.clearManualAssignment());
        
        // è´§æ¶é…ç½®æ¨¡æ€æ¡†
        this.addEventListener('apply-global-config', 'click', () => this.applyGlobalConfig());
        this.addEventListener('save-shelf-config', 'click', () => this.saveShelfConfiguration());
        
        // æ¨¡æ€æ¡†å…³é—­
        this.delegateEventListener('body', 'click', '.close-modal', (e) => {
            e.target.closest('.modal').style.display = 'none';
        });
        
        // æ¨¡æ€æ¡†å¤–éƒ¨ç‚¹å‡»å…³é—­
        this.delegateEventListener('body', 'click', '.modal', (e) => {
            if (e.target === e.currentTarget) {
                e.target.style.display = 'none';
            }
        });
        
    // ä¿®å¤ï¼šæ·»åŠ  this. å‰ç¼€
    this.delegateEventListener('#settings-page', 'click', '.edit-user-btn', (e) => {
        const userId = e.target.getAttribute('data-user-id');
        this.editUser(userId);
    });

    this.delegateEventListener('#settings-page', 'click', '.delete-user-btn', (e) => {
        const userId = e.target.getAttribute('data-user-id');
        this.deleteUser(userId);
    });      
        // äº§å“æœç´¢
        this.addEventListener('product-search-input', 'input', (e) => this.searchProducts(e.target.value));
        this.addEventListener('manual-product-search', 'input', (e) => this.searchProductsForManual(e.target.value, 'manual-product-results'));
        this.addEventListener('manual-location-search', 'input', (e) => this.searchLocationsForManual(e.target.value, 'manual-location-results'));
        
        // æ ‡è®°ä¸ºå·²ç»‘å®š
        this.eventsBound.main = true;
        console.log('ä¸»äº‹ä»¶ç›‘å¬å™¨ç»‘å®šå®Œæˆ');
        
        // åˆå§‹åŒ–æ—¶æ›´æ–°ExcelåŠŸèƒ½çŠ¶æ€
        setTimeout(() => this.updateExcelFunctionStatus(), 1000);
    }


           // æ›´æ–°ExcelåŠŸèƒ½çŠ¶æ€
    updateExcelFunctionStatus() {
        if (!this.excelSupported) {
            const importBtn = document.getElementById('process-inventory-import');
            const exportBtn = document.getElementById('export-fifo-report');
            
            if (importBtn) {
                importBtn.disabled = true;
                importBtn.title = 'Excelå¯¼å…¥åŠŸèƒ½ä¸å¯ç”¨ï¼šè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                importBtn.style.opacity = '0.6';
            }
            
            if (exportBtn) {
                exportBtn.disabled = true;
                exportBtn.title = 'Excelå¯¼å‡ºåŠŸèƒ½ä¸å¯ç”¨ï¼šè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                exportBtn.style.opacity = '0.6';
            }
        }
    }
            // å·¥å…·å‡½æ•°ï¼šæ·»åŠ äº‹ä»¶ç›‘å¬
    addEventListener(selector, event, handler) {
        let element;
        if (selector.startsWith('.')) {
            element = document.querySelector(selector);
        } else {
            element = document.getElementById(selector);
        }
        
        if (element) {
            // ç§»é™¤ç°æœ‰çš„äº‹ä»¶ç›‘å¬å™¨
            element.removeEventListener(event, handler);
            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            element.addEventListener(event, handler);
        } else {
            console.warn('å…ƒç´ æœªæ‰¾åˆ°:', selector);
        }
    }
            
 // å·¥å…·å‡½æ•°ï¼šäº‹ä»¶å§”æ‰˜
// ç¡®ä¿ delegateEventListener æ–¹æ³•åœ¨ç±»ä¸­æ­£ç¡®å®šä¹‰
delegateEventListener(parent, event, childSelector, handler) {
    const parentElement = typeof parent === 'string' ? document.querySelector(parent) : parent;
    if (parentElement) {
        parentElement.addEventListener(event, function(e) {
            if (e.target.matches(childSelector)) {
                handler(e);
            }
        });
    }
}
            
            // ä¿®æ”¹ç™»å½•æ–¹æ³•
    async handleLogin() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    document.getElementById('login-text').classList.add('hidden');
    document.getElementById('login-loading').classList.remove('hidden');
    
    try {
        console.log('å¼€å§‹ç™»å½•å¤„ç†...');
        
        if (!this.supabase) {
            console.log('Supabase ä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°è®¤è¯');
            this.useLocalAuth(username, password);
            return;
        }
        
        // ä½¿ç”¨æœ‰æ•ˆçš„é‚®ç®±æ ¼å¼
        let userEmail;
        if (username.includes('@')) {
            userEmail = username;
        } else {
            userEmail = `${username}@inventory.local`;
        }
        
        console.log('å°è¯• Supabase è®¤è¯:', userEmail);
        
        // å…ˆå°è¯•ç™»å½•
        const { data, error } = await this.supabase.auth.signInWithPassword({
            email: userEmail,
            password: password
        });
        
        if (error) {
            console.log('ç™»å½•å¤±è´¥ï¼Œå°è¯•æ³¨å†Œ:', error.message);
            
            // å°è¯•æ³¨å†Œ
            const { data: signUpData, error: signUpError } = await this.supabase.auth.signUp({
                email: userEmail,
                password: password,
                options: {
                    data: {
                        username: username
                    }
                }
            });
            
            if (signUpError) {
                console.error('æ³¨å†Œå¤±è´¥:', signUpError);
                // æ³¨å†Œå¤±è´¥æ—¶ä½¿ç”¨æœ¬åœ°è®¤è¯
                this.useLocalAuth(username, password);
            } else {
                console.log('æ³¨å†ŒæˆåŠŸ:', signUpData);
                if (signUpData.user) {
                    this.currentUser = {
                        id: signUpData.user.id,
                        email: signUpData.user.email,
                        username: username
                    };
                    alert('æ³¨å†ŒæˆåŠŸï¼æ‚¨ç°åœ¨å¯ä»¥ç™»å½•ç³»ç»Ÿäº†ã€‚');
                    this.showMainApp();
                }
            }
        } else {
            console.log('ç™»å½•æˆåŠŸ:', data);
            if (data.user) {
                this.currentUser = {
                    id: data.user.id,
                    email: data.user.email,
                    username: data.user.user_metadata?.username || data.user.email.split('@')[0]
                };
                this.showMainApp();
            }
        }
    } catch (error) {
        console.error('è®¤è¯é”™è¯¯:', error);
        // å‘ç”Ÿé”™è¯¯æ—¶ä½¿ç”¨æœ¬åœ°è®¤è¯
        this.useLocalAuth(username, password);
    } finally {
        document.getElementById('login-text').classList.remove('hidden');
        document.getElementById('login-loading').classList.add('hidden');
    }
}

    // ä¿®æ”¹é€€å‡ºç™»å½•æ–¹æ³•
    async handleLogout() {
        try {
            if (this.supabase) {
                await this.supabase.auth.signOut();
            }
        } catch (error) {
            console.error('é€€å‡ºç™»å½•é”™è¯¯:', error);
        } finally {
            this.currentUser = null;
            localStorage.removeItem(this.storagePrefix + 'currentUser');
            this.showLoginPage();
        }
    }

    // ä¿®æ”¹æ£€æŸ¥ç™»å½•çŠ¶æ€æ–¹æ³•
    async checkLoginStatus() {
        try {
            if (this.supabase) {
                const { data, error } = await this.supabase.auth.getSession();
                if (data.session) {
                    this.currentUser = data.session.user;
                    this.showMainApp();
                    this.setupRealtimeSync(); // ç¡®ä¿ç™»å½•åå¯åŠ¨å®æ—¶åŒæ­¥
                    return;
                }
            }
            
            // é™çº§åˆ°æœ¬åœ°å­˜å‚¨æ£€æŸ¥
            const savedUser = this.getStorage('currentUser');
            if (savedUser && savedUser.username) {
                this.currentUser = savedUser;
                this.showMainApp();
            }
        } catch (error) {
            console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€é”™è¯¯:', error);
        }
    }
           
                        


// æœ¬åœ°è®¤è¯é™çº§æ–¹æ¡ˆ
useLocalAuth(username, password) {
    console.log('ä½¿ç”¨æœ¬åœ°è®¤è¯æ¨¡å¼');
    
    // ç®€å•çš„æœ¬åœ°è®¤è¯é€»è¾‘
    const validUsers = [
        { username: 'admin', password: 'password', role: 'admin' },
        { username: 'user', password: 'user123', role: 'user' }
    ];
    
    const user = validUsers.find(u => u.username === username && u.password === password);
    
    if (user) {
        this.currentUser = {
            id: 'local-' + username,
            username: username,
            email: username + '@local.com',
            role: user.role
        };
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        this.setStorage('currentUser', this.currentUser);
        this.showMainApp();
        return true;
    } else {
        document.getElementById('login-error').textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
        document.getElementById('login-error').style.display = 'block';
        return false;
    }
}

// ç”¨æˆ·ç®¡ç†åŠŸèƒ½
// ç”¨æˆ·ç®¡ç†åŠŸèƒ½
setupUserManagement() {
    // ç»‘å®šäº‹ä»¶
    this.addEventListener('refresh-users-btn', 'click', () => this.loadUsersList());
    this.addEventListener('invite-user-btn', 'click', () => this.showInviteUserModal());
    this.addEventListener('export-users-btn', 'click', () => this.exportUsersList());
    this.addEventListener('user-permissions-btn', 'click', () => this.showPermissionsModal());
    
    // ç»‘å®šç”¨æˆ·æ“ä½œäº‹ä»¶
    this.delegateEventListener('#settings-page', 'click', '.btn-sm[onclick*="editUser"]', (e) => {
        const userId = e.target.getAttribute('onclick').match(/'([^']+)'/)[1];
        this.editUser(userId);
    });
    
    this.delegateEventListener('#settings-page', 'click', '.btn-sm[onclick*="deleteUser"]', (e) => {
        const userId = e.target.getAttribute('onclick').match(/'([^']+)'/)[1];
        this.deleteUser(userId);
    });

    // åˆå§‹åŒ–åŠ è½½ç”¨æˆ·åˆ—è¡¨
    this.loadUsersList();
    this.updateUserStats();
}

// åŠ è½½ç”¨æˆ·åˆ—è¡¨
async loadUsersList() {
    if (!this.supabase) {
        console.warn('Supabase æœªè¿æ¥ï¼Œæ— æ³•åŠ è½½ç”¨æˆ·åˆ—è¡¨');
        return;
    }
    
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        document.getElementById('users-list').innerHTML = 
            '<tr><td colspan="7" style="text-align: center;">åŠ è½½ä¸­...</td></tr>';
        
        // ä» profiles è¡¨è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆè€Œä¸æ˜¯ä½¿ç”¨ç®¡ç†å‘˜APIï¼‰
        const { data: users, error } = await this.supabase
            .from('profiles')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (error) {
            console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
            document.getElementById('users-list').innerHTML = 
                '<tr><td colspan="7" style="text-align: center;">åŠ è½½å¤±è´¥: ' + error.message + '</td></tr>';
            return;
        }
        
        if (!users || users.length === 0) {
            document.getElementById('users-list').innerHTML = 
                '<tr><td colspan="7" style="text-align: center;">æš‚æ— ç”¨æˆ·æ•°æ®</td></tr>';
            return;
        }
        
        // è·å–æ“ä½œç»Ÿè®¡
        const operationStats = await this.getUserOperationStats();
        
        this.renderUsersList(users, operationStats);
        this.updateUserStats(users, operationStats);
        
    } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¼‚å¸¸:', error);
        document.getElementById('users-list').innerHTML = 
            '<tr><td colspan="7" style="text-align: center;">åŠ è½½å¼‚å¸¸: ' + error.message + '</td></tr>';
    }
}

// è·å–ç”¨æˆ·æ“ä½œç»Ÿè®¡
async getUserOperationStats() {
    if (!this.supabase) return {};
    
    try {
        const { data, error } = await this.supabase
            .from('operation_logs')
            .select('user_id, action_type')
            .gte('created_at', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString()); // æœ€è¿‘30å¤©
        
        if (error) return {};
        
        const stats = {};
        data.forEach(log => {
            if (!stats[log.user_id]) {
                stats[log.user_id] = { total: 0, byType: {} };
            }
            stats[log.user_id].total++;
            stats[log.user_id].byType[log.action_type] = (stats[log.user_id].byType[log.action_type] || 0) + 1;
        });
        
        return stats;
    } catch (error) {
        console.error('è·å–ç”¨æˆ·æ“ä½œç»Ÿè®¡å¤±è´¥:', error);
        return {};
    }
}

// æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
// ä¿®æ”¹ renderUsersList æ–¹æ³•ä¸­çš„æŒ‰é’®éƒ¨åˆ†
renderUsersList(users, operationStats = {}) {
    const tbody = document.getElementById('users-list');
    
    tbody.innerHTML = users.map(user => {
        const userStats = operationStats[user.id] || { total: 0, byType: {} };
        const lastSignIn = user.last_sign_in_at ? new Date(user.last_sign_in_at) : null;
        const isOnline = lastSignIn && (Date.now() - lastSignIn.getTime() < 15 * 60 * 1000);
        
        return `
            <tr>
                <td>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 8px; height: 8px; border-radius: 50%; background: ${isOnline ? '#2ecc71' : '#95a5a6'};"></div>
                        ${user.username || user.email?.split('@')[0] || 'ç”¨æˆ·'}
                    </div>
                </td>
                <td>${user.email || 'æœªè®¾ç½®'}</td>
                <td>
                    <span class="user-role ${user.role || 'user'}">
                        ${user.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}
                    </span>
                </td>
                <td>${user.last_sign_in_at ? new Date(user.last_sign_in_at).toLocaleString() : 'ä»æœªç™»å½•'}</td>
                <td>${userStats.total}</td>
                <td>
                    <span class="${user.email_confirmed_at ? 'success' : 'warning'}">
                        ${user.email_confirmed_at ? 'å·²æ¿€æ´»' : 'æœªæ¿€æ´»'}
                    </span>
                </td>
                <td>
                    <button class="btn-sm edit-user-btn" data-user-id="${user.id}" 
                            ${user.id === this.currentUser?.id ? 'disabled' : ''}>ç¼–è¾‘</button>
                    <button class="btn-sm delete-user-btn" data-user-id="${user.id}" style="background: #e74c3c;"
                            ${user.id === this.currentUser?.id ? 'disabled' : ''}>åˆ é™¤</button>
                </td>
            </tr>
        `;
    }).join('');
}

// æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
updateUserStats(users = [], operationStats = {}) {
    const totalUsers = users.length;
    const activeUsers = users.filter(user => 
        user.last_sign_in_at && (Date.now() - new Date(user.last_sign_in_at).getTime() < 7 * 24 * 60 * 60 * 1000)
    ).length;
    
    const today = new Date().toISOString().split('T')[0];
    const todayOperations = Object.values(operationStats).reduce((sum, stat) => sum + stat.total, 0);
    
    document.getElementById('total-users-count').textContent = totalUsers;
    document.getElementById('active-users-count').textContent = activeUsers;
    document.getElementById('today-operations-count').textContent = todayOperations;
    document.getElementById('online-users-count').textContent = users.filter(user => 
        user.last_sign_in_at && (Date.now() - new Date(user.last_sign_in_at).getTime() < 15 * 60 * 1000)
    ).length;
}

// å¯¼å‡ºç”¨æˆ·åˆ—è¡¨
async exportUsersList() {
    try {
        if (!this.supabase) {
            alert('æ•°æ®åº“æœªè¿æ¥ï¼Œæ— æ³•å¯¼å‡ºç”¨æˆ·åˆ—è¡¨');
            return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const exportBtn = document.getElementById('export-users-btn');
        const originalText = exportBtn.textContent;
        exportBtn.textContent = 'å¯¼å‡ºä¸­...';
        exportBtn.disabled = true;

        // ä» profiles è¡¨è·å–ç”¨æˆ·æ•°æ®
        const { data: users, error } = await this.supabase
            .from('profiles')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            throw error;
        }

        if (!users || users.length === 0) {
            alert('æ²¡æœ‰ç”¨æˆ·æ•°æ®å¯å¯¼å‡º');
            return;
        }

        // å‡†å¤‡å¯¼å‡ºæ•°æ®
        const exportData = users.map(user => ({
            'ç”¨æˆ·å': user.username || user.email?.split('@')[0] || 'ç”¨æˆ·',
            'é‚®ç®±': user.email || 'æœªè®¾ç½®',
            'è§’è‰²': user.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·',
            'æœ€åç™»å½•': user.last_sign_in_at ? new Date(user.last_sign_in_at).toLocaleString() : 'ä»æœªç™»å½•',
            'è´¦å·çŠ¶æ€': user.email_confirmed_at ? 'å·²æ¿€æ´»' : 'æœªæ¿€æ´»',
            'æ³¨å†Œæ—¶é—´': user.created_at ? new Date(user.created_at).toLocaleString() : '',
            'ç”¨æˆ·ID': user.id
        }));

        // åˆ›å»ºExcelå·¥ä½œè¡¨
        const worksheet = XLSX.utils.json_to_sheet(exportData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ç”¨æˆ·åˆ—è¡¨');

        // å¯¼å‡ºæ–‡ä»¶
        XLSX.writeFile(workbook, `ç³»ç»Ÿç”¨æˆ·åˆ—è¡¨_${new Date().toISOString().split('T')[0]}.xlsx`);

        alert(`ç”¨æˆ·åˆ—è¡¨å¯¼å‡ºæˆåŠŸï¼Œå…± ${users.length} æ¡è®°å½•`);

    } catch (error) {
        console.error('å¯¼å‡ºç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
        alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const exportBtn = document.getElementById('export-users-btn');
        if (exportBtn) {
            exportBtn.textContent = 'å¯¼å‡ºç”¨æˆ·åˆ—è¡¨';
            exportBtn.disabled = false;
        }
    }
}

// é‚€è¯·ç”¨æˆ·ï¼ˆç¤ºä¾‹åŠŸèƒ½ï¼‰
showInviteUserModal() {
    const email = prompt('è¯·è¾“å…¥è¦é‚€è¯·çš„ç”¨æˆ·é‚®ç®±:');
    if (email && this.validateEmail(email)) {
        alert(`é‚€è¯·å·²å‘é€è‡³: ${email}\n\næ³¨æ„ï¼šå®é™…é‚€è¯·åŠŸèƒ½éœ€è¦åç«¯æ”¯æŒ`);
        // è¿™é‡Œå¯ä»¥é›†æˆå®é™…çš„ç”¨æˆ·é‚€è¯·é€»è¾‘
    } else if (email) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
    }
}

// é‚®ç®±éªŒè¯
validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}

// æƒé™è®¾ç½®ï¼ˆç¤ºä¾‹åŠŸèƒ½ï¼‰
showPermissionsModal() {
    alert('ç”¨æˆ·æƒé™ç®¡ç†åŠŸèƒ½\n\néœ€è¦ç®¡ç†å‘˜æƒé™å’ŒæœåŠ¡å™¨ç«¯æ”¯æŒæ‰èƒ½å®Œæ•´å®ç°');
}

// ç¼–è¾‘ç”¨æˆ·ï¼ˆç¤ºä¾‹åŠŸèƒ½ï¼‰
editUser(userId) {
    alert(`ç¼–è¾‘ç”¨æˆ· ${userId}\n\nç”¨æˆ·ç¼–è¾‘åŠŸèƒ½éœ€è¦å®Œæ•´çš„æƒé™ç®¡ç†ç³»ç»Ÿ`);
}

// åˆ é™¤ç”¨æˆ·ï¼ˆç¤ºä¾‹åŠŸèƒ½ï¼‰
deleteUser(userId) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        alert(`ç”¨æˆ· ${userId} åˆ é™¤è¯·æ±‚å·²æäº¤\n\næ³¨æ„ï¼šå®é™…åˆ é™¤åŠŸèƒ½éœ€è¦ç®¡ç†å‘˜æƒé™`);
        // è¿™é‡Œå¯ä»¥é›†æˆå®é™…çš„ç”¨æˆ·åˆ é™¤é€»è¾‘
    }
}



// æ“ä½œæ—¥å¿—åŠŸèƒ½
setupOperationLogs() {
    // ç»‘å®šäº‹ä»¶
    this.addEventListener('refresh-logs-btn', 'click', () => this.loadOperationLogs());
    this.addEventListener('export-logs-btn', 'click', () => this.exportOperationLogs());
    this.addEventListener('clear-old-logs-btn', 'click', () => this.clearOldLogs());
    this.addEventListener('log-search-input', 'input', (e) => this.filterLogs(e.target.value));
    this.addEventListener('log-time-filter', 'change', () => this.loadOperationLogs());
    
    // ç»‘å®šæ—¥å¿—ç±»å‹ç­›é€‰ - ä¿®å¤ç‰ˆæœ¬
    this.delegateEventListener('#database-page', 'click', '.status-filter-btn[data-log-type]', (e) => {
        this.filterLogsByType(e.target.getAttribute('data-log-type'), e);
    });
    
    // ç»‘å®šåˆ†é¡µ
    this.addEventListener('logs-prev-page', 'click', () => this.changeLogsPage(-1));
    this.addEventListener('logs-next-page', 'click', () => this.changeLogsPage(1));
    
    // åˆå§‹åŒ–
    this.logsPageState = {
        currentPage: 1,
        itemsPerPage: 10,
        searchTerm: '',
        logType: 'all',
        timeFilter: 'today'
    };
    
    this.loadOperationLogs();
}
// åŠ è½½æ“ä½œæ—¥å¿—
async loadOperationLogs() {
    if (!this.supabase || !this.currentUser) {
        console.warn('æœªç™»å½•æˆ–Supabaseæœªè¿æ¥');
        return;
    }
    
    try {
        // æ„å»ºæŸ¥è¯¢
        let query = this.supabase
            .from('operation_logs')
            .select('*', { count: 'exact' })
            .order('created_at', { ascending: false });
        
        // åº”ç”¨æ—¶é—´ç­›é€‰
        const timeFilter = document.getElementById('log-time-filter').value;
        const timeRange = this.getTimeRange(timeFilter);
        if (timeRange.start) {
            query = query.gte('created_at', timeRange.start);
        }
        if (timeRange.end) {
            query = query.lte('created_at', timeRange.end);
        }
        
        // åº”ç”¨ç±»å‹ç­›é€‰
        if (this.logsPageState.logType !== 'all') {
            query = query.eq('action_type', this.logsPageState.logType);
        }
        
        // åº”ç”¨æœç´¢
        if (this.logsPageState.searchTerm) {
            query = query.or(`action_type.ilike.%${this.logsPageState.searchTerm}%,table_name.ilike.%${this.logsPageState.searchTerm}%`);
        }
        
        const { data: logs, error, count } = await query.range(
            (this.logsPageState.currentPage - 1) * this.logsPageState.itemsPerPage,
            this.logsPageState.currentPage * this.logsPageState.itemsPerPage - 1
        );
        
        if (error) {
            throw error;
        }
        
        this.renderOperationLogs(logs || [], count || 0);
        
    } catch (error) {
        console.error('åŠ è½½æ“ä½œæ—¥å¿—å¤±è´¥:', error);
        document.getElementById('operation-logs-list').innerHTML = 
            '<tr><td colspan="7" style="text-align: center;">åŠ è½½å¤±è´¥: ' + error.message + '</td></tr>';
    }
}

// è·å–æ—¶é—´èŒƒå›´
getTimeRange(filter) {
    const now = new Date();
    const result = { start: null, end: null };
    
    switch (filter) {
        case 'today':
            result.start = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
            break;
        case 'week':
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay());
            result.start = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate()).toISOString();
            break;
        case 'month':
            result.start = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
            break;
        case 'all':
        default:
            // æ— æ—¶é—´é™åˆ¶
            break;
    }
    
    return result;
}

// æ¸²æŸ“æ“ä½œæ—¥å¿—
renderOperationLogs(logs, totalCount) {
    const tbody = document.getElementById('operation-logs-list');
    
    if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">æš‚æ— æ“ä½œæ—¥å¿—</td></tr>';
        return;
    }
    
    // æ›´æ–°åˆ†é¡µä¿¡æ¯
    const totalPages = Math.ceil(totalCount / this.logsPageState.itemsPerPage);
    const startIndex = (this.logsPageState.currentPage - 1) * this.logsPageState.itemsPerPage + 1;
    const endIndex = Math.min(startIndex + logs.length - 1, totalCount);
    
    document.getElementById('logs-pagination-info').textContent = 
        `æ˜¾ç¤º ${startIndex}-${endIndex} æ¡ï¼Œå…± ${totalCount} æ¡`;
    
    // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
    document.getElementById('logs-prev-page').disabled = this.logsPageState.currentPage <= 1;
    document.getElementById('logs-next-page').disabled = this.logsPageState.currentPage >= totalPages;
    
    // æ¸²æŸ“é¡µç 
    this.renderLogsPageNumbers(totalPages);
    
    // æ¸²æŸ“æ—¥å¿—åˆ—è¡¨
    tbody.innerHTML = logs.map(log => {
        const actionTypeClass = this.getActionTypeClass(log.action_type);
        
        return `
            <tr>
                <td>${new Date(log.created_at).toLocaleString()}</td>
                <td>${log.user_id ? log.user_id.substring(0, 8) + '...' : 'ç³»ç»Ÿ'}</td>
                <td>
                    <span class="log-action-type ${actionTypeClass}">
                        ${this.getActionTypeText(log.action_type)}
                    </span>
                </td>
                <td>${log.table_name || 'æœªçŸ¥è¡¨'}</td>
                <td>${log.record_id || 'N/A'}</td>
                <td>${log.ip_address || 'æœªçŸ¥'}</td>
                <td>
                    <button class="btn-sm" onclick="inventoryManager.showLogDetails('${log.id}')">
                        è¯¦æƒ…
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// è·å–æ“ä½œç±»å‹æ ·å¼ç±»
getActionTypeClass(actionType) {
    const classMap = {
        'INSERT': 'success',
        'UPDATE': 'warning',
        'DELETE': 'error',
        'IMPORT': 'info'
    };
    return classMap[actionType] || 'default';
}

// è·å–æ“ä½œç±»å‹æ–‡æœ¬
getActionTypeText(actionType) {
    const textMap = {
        'INSERT': 'æ–°å¢',
        'UPDATE': 'æ›´æ–°', 
        'DELETE': 'åˆ é™¤',
        'IMPORT': 'å¯¼å…¥'
    };
    return textMap[actionType] || actionType;
}

// æ¸²æŸ“æ—¥å¿—é¡µç 
renderLogsPageNumbers(totalPages) {
    const container = document.getElementById('logs-page-numbers');
    container.innerHTML = '';
    
    const startPage = Math.max(1, this.logsPageState.currentPage - 2);
    const endPage = Math.min(totalPages, startPage + 4);
    
    for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `pagination-btn ${i === this.logsPageState.currentPage ? 'active' : ''}`;
        pageBtn.textContent = i;
        pageBtn.addEventListener('click', () => {
            this.logsPageState.currentPage = i;
            this.loadOperationLogs();
        });
        container.appendChild(pageBtn);
    }
}

// ç­›é€‰æ—¥å¿—
filterLogs(searchTerm) {
    this.logsPageState.searchTerm = searchTerm;
    this.logsPageState.currentPage = 1;
    this.loadOperationLogs();
}

// æŒ‰ç±»å‹ç­›é€‰æ—¥å¿—
filterLogsByType(logType) {
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.status-filter-btn[data-log-type]').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    this.logsPageState.logType = logType;
    this.logsPageState.currentPage = 1;
    this.loadOperationLogs();
}

// æ”¹å˜æ—¥å¿—é¡µé¢
changeLogsPage(direction) {
    const totalPages = Math.ceil(
        (document.getElementById('logs-pagination-info').textContent.match(/å…± (\d+) æ¡/)?.[1] || 0) / 
        this.logsPageState.itemsPerPage
    );
    
    if (direction === -1 && this.logsPageState.currentPage > 1) {
        this.logsPageState.currentPage--;
    } else if (direction === 1 && this.logsPageState.currentPage < totalPages) {
        this.logsPageState.currentPage++;
    }
    
    this.loadOperationLogs();
}

// å¯¼å‡ºæ“ä½œæ—¥å¿—
async exportOperationLogs() {
    try {
        if (!this.supabase) {
            alert('æ•°æ®åº“æœªè¿æ¥');
            return;
        }
        
        const { data: logs, error } = await this.supabase
            .from('operation_logs')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(1000); // é™åˆ¶å¯¼å‡ºæ•°é‡
        
        if (error) throw error;
        
        if (!logs || logs.length === 0) {
            alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ“ä½œæ—¥å¿—');
            return;
        }
        
        const exportData = logs.map(log => ({
            'æ—¶é—´': new Date(log.created_at).toLocaleString(),
            'ç”¨æˆ·ID': log.user_id || 'ç³»ç»Ÿ',
            'æ“ä½œç±»å‹': this.getActionTypeText(log.action_type),
            'æ•°æ®è¡¨': log.table_name || 'æœªçŸ¥',
            'è®°å½•ID': log.record_id || 'N/A',
            'IPåœ°å€': log.ip_address || 'æœªçŸ¥',
            'ç”¨æˆ·ä»£ç†': log.user_agent || 'æœªçŸ¥'
        }));
        
        // åˆ›å»ºExcelæ–‡ä»¶
        const worksheet = XLSX.utils.json_to_sheet(exportData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'æ“ä½œæ—¥å¿—');
        
        // å¯¼å‡º
        XLSX.writeFile(workbook, `ç³»ç»Ÿæ“ä½œæ—¥å¿—_${new Date().toISOString().split('T')[0]}.xlsx`);
        alert(`æ“ä½œæ—¥å¿—å¯¼å‡ºæˆåŠŸï¼Œå…± ${logs.length} æ¡è®°å½•`);
        
    } catch (error) {
        console.error('å¯¼å‡ºæ“ä½œæ—¥å¿—å¤±è´¥:', error);
        alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
    }
}

// æ¸…ç†æ—§æ—¥å¿—
async clearOldLogs() {
    if (!confirm('ç¡®å®šè¦æ¸…ç†30å¤©å‰çš„æ“ä½œæ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        return;
    }
    
    try {
        const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();
        
        const { error } = await this.supabase
            .from('operation_logs')
            .delete()
            .lt('created_at', thirtyDaysAgo);
        
        if (error) throw error;
        
        alert('æ—§æ—¥å¿—æ¸…ç†å®Œæˆ');
        this.loadOperationLogs(); // é‡æ–°åŠ è½½
        
    } catch (error) {
        console.error('æ¸…ç†æ—§æ—¥å¿—å¤±è´¥:', error);
        alert('æ¸…ç†å¤±è´¥: ' + error.message);
    }
}



// é¡µé¢æ˜¾ç¤ºæ§åˆ¶
showLoginPage() {
    document.getElementById('login-page').classList.remove('hidden');
    document.getElementById('main-app').classList.add('hidden');
}

            // ä¿®æ”¹æ˜¾ç¤ºä¸»åº”ç”¨æ–¹æ³•
  showMainApp() {
    document.getElementById('login-page').classList.add('hidden');
    document.getElementById('main-app').classList.remove('hidden');
    
    if (this.currentUser) {
        const displayName = this.currentUser.email || this.currentUser.username || 'ç”¨æˆ·';
        document.getElementById('current-user').textContent = displayName;
    }
    
    this.initDashboard();
    this.setupRealtimeSync();
}
            
            // å¯¼èˆªå¤„ç†
handleNavigation(navItem) {
    if (!navItem) return;
    
    // æ›´æ–°æ´»è·ƒçŠ¶æ€
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    navItem.classList.add('active');
    
    // æ˜¾ç¤ºå¯¹åº”é¡µé¢
    const pageId = navItem.getAttribute('data-page') + '-page';
    document.querySelectorAll('.page-content').forEach(page => {
        page.classList.add('hidden');
    });
    
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.classList.remove('hidden');
        this.loadPageContent(pageId);
    }
}
            
          loadPageContent(pageId) {
    console.log('åŠ è½½é¡µé¢å†…å®¹:', pageId);
    
    // ç¡®ä¿ eventsBound ç»“æ„æ­£ç¡®
    this.ensureEventsBoundStructure();
    
    switch(pageId) {
        case 'dashboard-page':
            this.initDashboard();
            break;
        case 'inventory-page':
            this.setupInventoryPage();
            break;
        case 'alerts-page':
            this.setupAlertsPage();
            break;
        case 'location-page':
            this.setupLocationPage();
            break;
        case 'analysis-page':
            this.setupAnalysisPage();
            break;
        case 'database-page':
            this.setupDatabasePage();
            break;
        case 'settings-page':
            this.setupSettingsPage();
            break;
    }
}
            
            // ä»ªè¡¨ç›˜
            initDashboard() {
                this.updateDashboardStats();
                this.renderUrgentItems();
            }
            
            updateDashboardStats() {
                // è®¡ç®—ç»Ÿè®¡æ•°æ®
                const totalProducts = this.inventoryData.length;
                const lowStockCount = this.inventoryData.filter(item => {
                    const stockQty = parseInt(item.stockQty) || 0;
                    const availableQty = parseInt(item.availableQty) || 0;
                    return availableQty < 5; // å‡è®¾å®‰å…¨åº“å­˜ä¸º5
                }).length;
                
                const highStockCount = this.inventoryData.filter(item => {
                    const stockQty = parseInt(item.stockQty) || 0;
                    return stockQty > 100; // å‡è®¾é«˜åº“å­˜ä¸º100
                }).length;
                
                document.getElementById('warning-products').textContent = lowStockCount + highStockCount;
                document.getElementById('low-stock-count').textContent = lowStockCount;
                document.getElementById('high-stock-count').textContent = highStockCount;
                document.getElementById('turnover-days').textContent = '42';
                document.getElementById('obsolete-percentage').textContent = '8%';
                document.getElementById('obsolete-value').textContent = 'Â¥12,500';
                
                // FIFOç»Ÿè®¡
                document.getElementById('multi-batch-count').textContent = '15';
                document.getElementById('expiring-soon-count').textContent = '3';
                document.getElementById('expired-count').textContent = '1';
                
                document.getElementById('last-update-time').textContent = 
                    `æœ€åæ›´æ–°: ${new Date().toLocaleString()}`;
            }
            
            renderUrgentItems() {
                const urgentItems = this.inventoryData.filter(item => {
                    const stockQty = parseInt(item.stockQty) || 0;
                    const availableQty = parseInt(item.availableQty) || 0;
                    return availableQty < 5; // å®‰å…¨åº“å­˜ä¸º5
                }).slice(0, 5); // åªæ˜¾ç¤ºå‰5ä¸ª
                
                const tbody = document.getElementById('urgent-items');
                
                if (urgentItems.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">æš‚æ— æ€¥éœ€å¤„ç†çš„é¡¹ç›®</td></tr>';
                    return;
                }
                
                tbody.innerHTML = urgentItems.map(item => `
                    <tr class="low-stock">
                        <td>${item.name || item.model || 'æœªçŸ¥äº§å“'}</td>
                        <td>${item.model || 'æ— '}</td>
                        <td>${item.stockQty || 0}</td>
                        <td>5</td>
                        <td>${item.clientName || 'æœªçŸ¥å®¢æˆ·'}</td>
                        <td><span class="warning">ä½åº“å­˜</span></td>
                        <td><button class="btn-sm">é‡‡è´­å»ºè®®</button></td>
                    </tr>
                `).join('');
            }
            
// åœ¨ InventoryManager ç±»ä¸­æ·»åŠ åº“å­˜å˜åŒ–ç›‘å¬æ–¹æ³•
setupInventoryChangeListeners() {
    // ç›‘å¬åº“å­˜æ•°æ®å˜åŒ–ï¼Œå®æ—¶æ›´æ–°é¢„è­¦å’Œåº“ä½
    const originalSaveToStorage = this.saveToStorage.bind(this);
    this.saveToStorage = () => {
        originalSaveToStorage();
        // åº“å­˜æ•°æ®ä¿å­˜åï¼Œè‡ªåŠ¨åŒæ­¥ç›¸å…³æ•°æ®
        this.onInventoryDataChanged();
    };
}

// åº“å­˜æ•°æ®å˜åŒ–æ—¶çš„å¤„ç†
onInventoryDataChanged() {
    console.log('åº“å­˜æ•°æ®å·²æ›´æ–°ï¼ŒåŒæ­¥ç›¸å…³æ•°æ®...');
    
    // å¼ºåˆ¶åŒæ­¥åº“ä½æ•°æ®
    this.syncLocationWithInventory();
    
    // æ›´æ–°é¢„è­¦åˆ—è¡¨ï¼ˆæ— è®ºé¡µé¢æ˜¯å¦æ˜¾ç¤ºï¼‰
    this.renderAlertList();
    this.renderPurchaseSuggestions();
    // æ›´æ–°é‡‡è´­å»ºè®®
    this.renderPurchaseSuggestions();
    // å¦‚æœé¢„è­¦é¡µé¢æ­£åœ¨æ˜¾ç¤ºï¼Œæ›´æ–°æ˜¾ç¤º
    if (!document.getElementById('alerts-page').classList.contains('hidden')) {
        this.updateAlertDisplay();
    }
    
    // å¦‚æœåº“ä½é¡µé¢æ­£åœ¨æ˜¾ç¤ºï¼Œé‡æ–°æ¸²æŸ“
    if (!document.getElementById('location-page').classList.contains('hidden')) {
        this.renderShelves();
        this.updateCurrentLocationDisplay();
    }
    
    // æ›´æ–°ä»ªè¡¨ç›˜
    if (!document.getElementById('dashboard-page').classList.contains('hidden')) {
        this.updateDashboardStats();
        this.renderUrgentItems();
    }
     console.log('é‡‡è´­å»ºè®®å·²éšåº“å­˜æ›´æ–°');
}

// æ·»åŠ æ‰‹åŠ¨æ›´æ–°é¢„è­¦æ˜¾ç¤ºçš„æ–¹æ³•
updateAlertDisplay() {
    console.log('æ›´æ–°é¢„è­¦æ˜¾ç¤º...');
    this.renderAlertList();
    this.renderPurchaseSuggestions();
}

// åŒæ­¥åº“ä½æ•°æ®ä¸åº“å­˜æ•°æ®
syncLocationWithInventory() {
    console.log('å¼€å§‹åŒæ­¥åº“ä½æ•°æ®ä¸åº“å­˜æ•°æ®...');
    
    const updatedLocationData = [];
    let removedCount = 0;
    let updatedCount = 0;
    
    // éå†æ‰€æœ‰åº“ä½è®°å½•
    this.locationData.forEach(location => {
        // æŸ¥æ‰¾å¯¹åº”çš„åº“å­˜äº§å“
        const inventoryItems = this.inventoryData.filter(item => 
            item.model === location.productModel
        );
        
        const totalStock = inventoryItems.reduce((sum, item) => 
            sum + (parseInt(item.stockQty) || 0), 0
        );
        
        // å¦‚æœåº“å­˜ä¸º0ï¼Œç§»é™¤åº“ä½å…³è”
        if (totalStock <= 0) {
            console.log(`ç§»é™¤åº“ä½ ${location.locationCode}ï¼Œäº§å“ ${location.productModel} åº“å­˜ä¸º0`);
            removedCount++;
            return; // ä¸æ·»åŠ åˆ°æ–°æ•°ç»„ï¼Œç›¸å½“äºåˆ é™¤
        }
        
        // å¦‚æœåº“å­˜å‡å°‘ï¼Œè°ƒæ•´åº“ä½æ•°é‡
        const currentLocationQuantity = parseInt(location.quantity) || 0;
        if (currentLocationQuantity > totalStock) {
            console.log(`è°ƒæ•´åº“ä½ ${location.locationCode} æ•°é‡: ${currentLocationQuantity} -> ${totalStock}`);
            location.quantity = totalStock;
            updatedCount++;
        }
        
        updatedLocationData.push(location);
    });
    
    this.locationData = updatedLocationData;
    
    console.log(`åº“ä½åŒæ­¥å®Œæˆ: ç§»é™¤ ${removedCount} ä¸ªåº“ä½, æ›´æ–° ${updatedCount} ä¸ªåº“ä½æ•°é‡`);
    
    // ä¿å­˜æ›´æ–°åçš„åº“ä½æ•°æ®
    this.setStorage('locationData', this.locationData);
}

// ä¿®æ­£çš„åº“å­˜è·å–æ–¹æ³• - ä½¿ç”¨å‹å·åŒ¹é…
getAlertCurrentStock(alertConfig) {
    if (!alertConfig.model) {
        console.warn('é¢„è­¦é…ç½®ç¼ºå°‘å‹å·:', alertConfig);
        return 0;
    }
    
    // ä½¿ç”¨å‹å·è¿›è¡ŒåŒ¹é…
    const inventoryItems = this.inventoryData.filter(item => {
        const itemModel = (item.model || '').toString().trim();
        const alertModel = (alertConfig.model || '').toString().trim();
        return itemModel === alertModel;
    });
    
    // ä½¿ç”¨ availableQtyï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ stockQty
    const currentStock = inventoryItems.reduce((sum, item) => {
        const quantity = parseInt(item.availableQty) || parseInt(item.stockQty) || 0;
        return sum + quantity;
    }, 0);
    
    // è°ƒè¯•ä¿¡æ¯
    console.log(`åº“å­˜æŸ¥è¯¢ - å‹å·: "${alertConfig.model}"`, {
        åŒ¹é…è®°å½•æ•°: inventoryItems.length,
        æ€»åº“å­˜: currentStock,
        åŒ¹é…è®°å½•: inventoryItems.map(item => ({
            å‹å·: item.model,
            åº“å­˜æ•°é‡: item.stockQty,
            å¯ç”¨æ•°é‡: item.availableQty
        }))
    });
    
    return currentStock;
}
      // åº“å­˜ç®¡ç†é¡µé¢
           setupInventoryPage() {
                  this.renderInventoryList();
                  this.updateButtonStates();
                  this.setupInventorySearch();
    
           // ä¿®å¤æœç´¢æŒ‰é’®äº‹ä»¶ç»‘å®š
                  this.addEventListener('search-btn', 'click', () => this.handleSearch());
                  this.addEventListener('reset-search', 'click', () => this.resetSearch());
    
                  console.log('åº“å­˜ç®¡ç†é¡µé¢å·²åŠ è½½', {
        totalItems: this.inventoryData.length,
        searchState: this.currentState
    });
}
            
           // æ·»åŠ æ–°çš„æ–¹æ³•ï¼šè®¾ç½®åº“å­˜ç®¡ç†é¡µé¢æœç´¢
             setupInventorySearch() {
    const searchInput = document.getElementById('inventory-search');
    const searchType = document.getElementById('search-type');

    if (!searchInput) return;

    // åˆ›å»ºæœç´¢ç»“æœå®¹å™¨
    this.createInventorySearchResults();

    // ç»‘å®šè¾“å…¥äº‹ä»¶ - å®æ—¶æœç´¢æç¤º
    searchInput.addEventListener('input', (e) => {
        this.searchInventoryProducts(e.target.value);
    });

    // ç»‘å®šå›è½¦é”®æœç´¢
    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            this.handleSearch();
            // éšè—ä¸‹æ‹‰æ¡†
            const results = document.getElementById('inventory-search-results');
            if (results) results.style.display = 'none';
        }
    });

    // ç»‘å®šæœç´¢ç±»å‹å˜åŒ–äº‹ä»¶
    if (searchType) {
        searchType.addEventListener('change', () => {
            // å¦‚æœæœç´¢æ¡†æœ‰å†…å®¹ï¼Œç«‹å³æœç´¢
            if (searchInput.value.trim()) {
                this.handleSearch();
            }
        });
    }

    // ç»‘å®šå¤–éƒ¨ç‚¹å‡»å…³é—­
    document.addEventListener('click', (e) => {
        const results = document.getElementById('inventory-search-results');
        if (results && !searchInput.contains(e.target) && !results.contains(e.target)) {
            results.style.display = 'none';
        }
    });

    // ç¡®ä¿æœç´¢å®¹å™¨æœ‰ç›¸å¯¹å®šä½
    searchInput.parentNode.style.position = 'relative';
}

// åˆ›å»ºæœç´¢ç»“æœå®¹å™¨
createInventorySearchResults() {
    let resultsContainer = document.getElementById('inventory-search-results');
    if (!resultsContainer) {
        resultsContainer = document.createElement('div');
        resultsContainer.id = 'inventory-search-results';
        resultsContainer.className = 'search-results';
        
        const searchContainer = document.getElementById('inventory-search').parentNode;
        searchContainer.style.position = 'relative';
        searchContainer.appendChild(resultsContainer);
    }
}

// åº“å­˜ç®¡ç†é¡µé¢äº§å“æœç´¢
searchInventoryProducts(searchTerm) {
    const resultsContainer = document.getElementById('inventory-search-results');
    if (!resultsContainer) {
        console.error('æœç´¢ç»“æœå®¹å™¨æœªæ‰¾åˆ°');
        return;
    }
    
    resultsContainer.innerHTML = '';
    resultsContainer.style.display = 'none';
    
    if (!searchTerm || searchTerm.length < 1) {
        return;
    }
    
    // æŒ‰å‹å·åˆ†ç»„å»é‡ï¼Œæ˜¾ç¤ºæ›´å¤šäº§å“ä¿¡æ¯
    const productMap = new Map();
    
    this.inventoryData.forEach(product => {
        if (!product.model) return;
        
        // æ„å»ºæœç´¢æ–‡æœ¬ï¼ŒåŒ…å«æ‰€æœ‰å¯èƒ½å­—æ®µ
        const searchText = `${product.brand || ''} ${product.name || ''} ${product.model || ''} ${product.orderNumber || ''}`.toLowerCase();
        const searchTermLower = searchTerm.toLowerCase();
        
        // ä½¿ç”¨æ›´å®½æ¾çš„åŒ¹é…æ¡ä»¶
        if (searchText.includes(searchTermLower) || 
            (product.model && product.model.toLowerCase().includes(searchTermLower)) ||
            (product.orderNumber && product.orderNumber.toLowerCase().includes(searchTermLower))) {
            
            if (!productMap.has(product.model)) {
                // è®¡ç®—è¯¥å‹å·çš„æ€»åº“å­˜
                const totalStock = this.inventoryData
                    .filter(p => p.model === product.model)
                    .reduce((sum, p) => sum + (parseInt(p.stockQty) || 0), 0);
                
                productMap.set(product.model, {
                    model: product.model,
                    brand: product.brand,
                    name: product.name,
                    orderNumber: product.orderNumber,
                    totalStock: totalStock,
                    displayText: `${product.brand || ''} ${product.name || ''} ${product.model || ''}`.trim()
                });
            }
        }
    });
    
    const filteredProducts = Array.from(productMap.values());
    
    if (filteredProducts.length === 0) {
        resultsContainer.innerHTML = '<div class="search-result-item">æœªæ‰¾åˆ°åŒ¹é…çš„äº§å“</div>';
        resultsContainer.style.display = 'block';
        return;
    }
    
    filteredProducts.forEach(product => {
        const resultItem = document.createElement('div');
        resultItem.className = 'search-result-item';
        resultItem.dataset.model = product.model;
        
        const orderNumberText = product.orderNumber ? `(${product.orderNumber})` : '';
        const stockInfo = `åº“å­˜: ${product.totalStock}`;
        
        resultItem.innerHTML = `
            <div style="font-size: 0.8rem; font-weight: 500;">
                ${product.displayText} ${orderNumberText}
            </div>
            <div style="font-size: 0.7rem; color: #666; margin-top: 2px;">
                ${stockInfo}
            </div>
        `;
        
        resultItem.addEventListener('click', () => {
            // è®¾ç½®æœç´¢æ¡†çš„å€¼ - ä½¿ç”¨æ›´å‹å¥½çš„æ˜¾ç¤ºæ–‡æœ¬
            document.getElementById('inventory-search').value = product.displayText;
            
            // æ›´æ–°æœç´¢çŠ¶æ€ - ä½¿ç”¨äº§å“å‹å·ä½œä¸ºæœç´¢è¯
            this.currentState.searchTerm = product.model; // ä¸ç§»é™¤toLowerCaseä»¥ä¿æŒç²¾ç¡®åŒ¹é…
            this.currentState.searchType = 'model';
            
            // æ›´æ–°æœç´¢ç±»å‹ä¸‹æ‹‰æ¡†
            document.getElementById('search-type').value = 'model';
            
            // ç«‹å³æ‰§è¡Œæœç´¢
            this.handleSearch();
            
            // éšè—ä¸‹æ‹‰æ¡†
            resultsContainer.style.display = 'none';
        });
        
        resultsContainer.appendChild(resultItem);
    });
    
    resultsContainer.style.display = 'block';
}

// ä¿®å¤æœç´¢å¤„ç†é€»è¾‘
handleSearch() {
    const searchInput = document.getElementById('inventory-search');
    const searchType = document.getElementById('search-type');
    
    if (!searchInput || !searchType) {
        console.error('æœç´¢å…ƒç´ æœªæ‰¾åˆ°');
        return;
    }
    
    // å¦‚æœæœç´¢æ¡†æœ‰å€¼ä½†æœç´¢çŠ¶æ€ä¸ºç©ºï¼Œä½¿ç”¨æœç´¢æ¡†çš„å€¼
    const inputValue = searchInput.value.trim();
    if (inputValue && !this.currentState.searchTerm) {
        this.currentState.searchTerm = inputValue.toLowerCase();
    }
    
    // ç¡®ä¿æœç´¢ç±»å‹æ­£ç¡®
    if (searchType.value !== this.currentState.searchType) {
        this.currentState.searchType = searchType.value;
    }
    
    console.log('æ‰§è¡Œæœç´¢:', {
        term: this.currentState.searchTerm,
        type: this.currentState.searchType,
        inputValue: inputValue
    });
    
    this.renderInventoryList();
}

            // æ·»åŠ ä¸€ä¸ªä¸“é—¨çš„å‹å·æœç´¢æ–¹æ³•
searchByModel(model) {
    this.currentState.searchTerm = model.toLowerCase();
    this.currentState.searchType = 'model';
    
    const searchInput = document.getElementById('inventory-search');
    if (searchInput) {
        searchInput.value = model;
    }
    
    this.renderInventoryList();
}
         // ä¿®å¤é‡ç½®æœç´¢åŠŸèƒ½
resetSearch() {
    const searchInput = document.getElementById('inventory-search');
    const searchType = document.getElementById('search-type');
    const resultsContainer = document.getElementById('inventory-search-results');
    
    if (searchInput) searchInput.value = '';
    if (searchType) searchType.value = 'all';
    if (resultsContainer) resultsContainer.style.display = 'none';
    
    // é‡ç½®æœç´¢çŠ¶æ€
    this.currentState.searchTerm = '';
    this.currentState.searchType = 'all';
    
    // é‡æ–°æ¸²æŸ“åˆ—è¡¨
    this.renderInventoryList();
    
    console.log('æœç´¢å·²é‡ç½®');
}
            
            toggleStockValue() {
                this.currentState.showStockValue = !this.currentState.showStockValue;
                this.updateButtonStates();
                this.renderInventoryList();
                this.saveToStorage();
            }
            
            toggleFIFOHighlight() {
                this.currentState.showFIFOHighlight = !this.currentState.showFIFOHighlight;
                this.updateButtonStates();
                this.renderInventoryList();
                this.saveToStorage();
            }
            
            toggleWarrantyWarning() {
                this.currentState.showWarrantyWarning = !this.currentState.showWarrantyWarning;
                this.updateButtonStates();
                this.renderInventoryList();
                this.saveToStorage();
            }
            
            updateButtonStates() {
                document.getElementById('toggle-stock-value').textContent = 
                    this.currentState.showStockValue ? 'éšè—é‡‘é¢' : 'æ˜¾ç¤ºé‡‘é¢';
                document.getElementById('toggle-fifo-highlight').textContent = 
                    this.currentState.showFIFOHighlight ? 'å–æ¶ˆFIFOé«˜äº®' : 'FIFOé«˜äº®';
                document.getElementById('show-warranty-warning').textContent = 
                    this.currentState.showWarrantyWarning ? 'éšè—è´¨ä¿æœŸè­¦å‘Š' : 'è´¨ä¿æœŸè­¦å‘Š';
            }
            
            handleSort(header) {
                const sortColumn = header.getAttribute('data-sort');
                
                // æ¸…é™¤å…¶ä»–æ’åºçŠ¶æ€
                document.querySelectorAll('th.sortable').forEach(h => {
                    h.classList.remove('sorted-asc', 'sorted-desc');
                });
                
                // è®¾ç½®æ’åºçŠ¶æ€
                if (this.currentState.sortColumn === sortColumn) {
                    this.currentState.sortDirection = this.currentState.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    this.currentState.sortColumn = sortColumn;
                    this.currentState.sortDirection = 'asc';
                }
                
                header.classList.add(this.currentState.sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
                this.renderInventoryList();
            }
            
           renderInventoryList() {
    const tbody = document.getElementById('inventory-list');
    const filter = document.getElementById('inventory-filter').value;

    if (this.inventoryData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" style="text-align: center;">æ²¡æœ‰åº“å­˜æ•°æ®ï¼Œè¯·å¯¼å…¥Excelæ–‡ä»¶</td></tr>';
        document.getElementById('inventory-count').textContent = '0';
        return;
    }

    // åº”ç”¨ç­›é€‰
    let filteredData = this.inventoryData.filter(item => {
        if (filter === 'effective') {
            return item.clientName === 'å¤‡è´§å®¢æˆ·' || item.clientName === 'BXS';
        } else if (filter === 'transit') {
            return item.clientName !== 'å¤‡è´§å®¢æˆ·' && item.clientName !== 'BXS';
        } else if (filter === 'over6months') {
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            const entryDate = this.parseDate(item.entryDate);
            return entryDate && entryDate <= sixMonthsAgo;
        } else if (filter === 'priority') {
            // ä¼˜å…ˆå‡ºåº“é€»è¾‘ï¼šåº“å­˜æ—¶é—´æœ€é•¿çš„æ‰¹æ¬¡
            return this.isPriorityStock(item);
        }
        return true;
    });

  // åº”ç”¨æœç´¢
if (this.currentState.searchTerm) {
    const searchTermLower = this.currentState.searchTerm.toLowerCase();
    
    filteredData = filteredData.filter(item => {
        // æ ¹æ®æœç´¢ç±»å‹å†³å®šæœç´¢å“ªäº›å­—æ®µ
        switch (this.currentState.searchType) {
            case 'brand':
                return item.brand && item.brand.toLowerCase().includes(searchTermLower);
            case 'model':
                return item.model && item.model.toLowerCase().includes(searchTermLower);
            case 'orderNumber':
                return item.orderNumber && item.orderNumber.toLowerCase().includes(searchTermLower);
            case 'name':
                return item.name && item.name.toLowerCase().includes(searchTermLower);
            case 'all':
            default:
                // åœ¨æ‰€æœ‰å­—æ®µä¸­æœç´¢
                const searchFields = [
                    item.brand, item.name, item.model, item.orderNumber,
                    item.clientName, item.warehouse
                ];
                return searchFields.some(field => 
                    field && field.toString().toLowerCase().includes(searchTermLower)
                );
        }
    });
}

    // åº”ç”¨æ’åº
    filteredData.sort((a, b) => {
        const aVal = a[this.currentState.sortColumn] || '';
        const bVal = b[this.currentState.sortColumn] || '';

        if (this.currentState.sortDirection === 'asc') {
            return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
        } else {
            return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
        }
    });

    // æ¸²æŸ“è¡¨æ ¼
    tbody.innerHTML = filteredData.map(item => {
                    const isEffective = item.clientName === 'å¤‡è´§å®¢æˆ·' || item.clientName === 'BXS';
                    const locations = this.getProductLocations(item.model, item.orderNumber);
                    const locationDisplay = locations.length > 0 ? 
                        `<span class="location-info">${locations.join(', ')}</span>` : 
                        'æ— ';
                    
                    let rowClass = isEffective ? '' : 'in-transit';
                    
                    // FIFOé«˜äº®
                    if (this.currentState.showFIFOHighlight && this.isEarliestBatch(item)) {
                        rowClass += ' fifo-highlight';
                    }
                    
                    // è´¨ä¿æœŸè­¦å‘Š
                    if (this.currentState.showWarrantyWarning) {
                        const warrantyStatus = this.calculateWarrantyStatus(item.entryDate);
                        if (warrantyStatus.status === 'expired') {
                            rowClass += ' warranty-expired';
                        } else if (warrantyStatus.status === 'warning') {
                            rowClass += ' warranty-expiring';
                        }
                    }
                    
                    return `
                        <tr class="${rowClass}">
                            <td>${item.brand || 'æ— '}</td>
                            <td>${item.name || 'æ— '}</td>
                            <td>${item.model || 'æ— '}</td>
                            <td>${item.orderNumber || 'æ— '}</td>
                            <td>${parseInt(item.stockQty) || 0}</td>
                            <td>${parseInt(item.availableQty) || 0}</td>
                            <td>${item.clientName || 'æœªçŸ¥å®¢æˆ·'}</td>
                            <td>${isEffective ? 'æœ‰æ•ˆåº“å­˜' : 'åœ¨é€”åº“å­˜'}</td>
                            <td>${locationDisplay}</td>
                            <td>${this.formatDate(item.entryDate)}</td>
                            <td class="stock-value-column ${this.currentState.showStockValue ? '' : 'hidden'}">
                                Â¥${parseFloat(item.stockValue || 0).toLocaleString()}
                            </td>
                            <td>${item.warehouse || 'æœªçŸ¥ä»“åº“'}</td>
                            <td><button class="btn-sm" onclick="inventoryManager.showProductDetail('${item.orderNumber}')">è¯¦æƒ…</button></td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('inventory-count').textContent = filteredData.length;
            }
            
            // å·¥å…·å‡½æ•°
            parseDate(dateString) {
                if (!dateString) return null;
                try {
                    return new Date(dateString);
                } catch (e) {
                    return null;
                }
            }
            
            formatDate(dateString) {
                if (!dateString) return 'æœªçŸ¥';
                const date = this.parseDate(dateString);
                if (!date) return 'æœªçŸ¥';
                return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}å·`;
            }
            
            isPriorityStock(item) {
                // ç®€åŒ–çš„ä¼˜å…ˆå‡ºåº“é€»è¾‘ï¼šå…¥åº“æ—¶é—´è¶…è¿‡3ä¸ªæœˆ
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                const entryDate = this.parseDate(item.entryDate);
                return entryDate && entryDate <= threeMonthsAgo;
            }
            
            isEarliestBatch(item) {
                // ç®€åŒ–çš„FIFOé€»è¾‘ï¼šæŸ¥æ‰¾åŒå‹å·çš„æœ€æ—©æ‰¹æ¬¡
                const sameModelItems = this.inventoryData.filter(i => i.model === item.model);
                if (sameModelItems.length <= 1) return false;
                
                let earliestDate = null;
                let earliestItem = null;
                
                sameModelItems.forEach(i => {
                    const entryDate = this.parseDate(i.entryDate);
                    if (entryDate && (!earliestDate || entryDate < earliestDate)) {
                        earliestDate = entryDate;
                        earliestItem = i;
                    }
                });
                
                return earliestItem && earliestItem.orderNumber === item.orderNumber;
            }
            
            calculateWarrantyStatus(entryDate) {
                if (!entryDate) return { status: 'unknown', daysRemaining: 0 };
                
                const entry = this.parseDate(entryDate);
                if (!entry) return { status: 'unknown', daysRemaining: 0 };
                
                const today = new Date();
                const warrantyEnd = new Date(entry);
                warrantyEnd.setFullYear(warrantyEnd.getFullYear() + 1); // è´¨ä¿æœŸ1å¹´
                
                const daysRemaining = Math.ceil((warrantyEnd - today) / (1000 * 60 * 60 * 24));
                
                if (daysRemaining < 0) {
                    return { status: 'expired', daysRemaining };
                } else if (daysRemaining <= 30) {
                    return { status: 'warning', daysRemaining };
                } else {
                    return { status: 'normal', daysRemaining };
                }
            }
            
            // é¢„è­¦ç®¡ç†
           setupAlertsPage() {
                this.renderAlertList();
                this.renderPurchaseSuggestions();
                
                // åªåœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ—¶ç»‘å®šäº‹ä»¶
                if (!this.eventsBound.alertsPage) {
                    // ç»‘å®šæ–°çš„äº‹ä»¶
                    this.addEventListener('import-alert-config', 'click', () => this.openImportAlertModal());
                    this.addEventListener('export-alert-config', 'click', () => this.exportAlertConfig());
                    this.addEventListener('refresh-purchase-suggestions', 'click', () => this.refreshPurchaseSuggestions());
                    this.addEventListener('export-purchase-suggestions', 'click', () => this.exportPurchaseSuggestions());
                    this.addEventListener('apply-purchase-filter', 'click', () => this.applyPurchaseFilter());
                    this.addEventListener('confirm-alert-import', 'click', () => this.confirmAlertImport());
                    this.addEventListener('validate-alert-data', 'click', () => this.validateAlertData());                    

                    // é¢„è­¦é¡µé¢æ–°å¢äº‹ä»¶
                    this.addEventListener('refresh-alerts', 'click', () => this.refreshAlerts());
                    this.addEventListener('alert-search-input', 'input', (e) => this.filterAlerts(e.target.value));
                    this.delegateEventListener('#alerts-page', 'click', '.status-filter-btn', (e) => {
                        this.filterAlertsByStatus(e.target.getAttribute('data-status'));
                    });
                    this.delegateEventListener('#alerts-page', 'click', '.view-toggle-btn', (e) => {
                        this.switchAlertView(e.target.getAttribute('data-view'));
                    });
                    this.addEventListener('alert-prev-page', 'click', () => this.changeAlertPage(-1));
                    this.addEventListener('alert-next-page', 'click', () => this.changeAlertPage(1));
                    this.addEventListener('refresh-purchase-suggestions', 'click', () => this.forceRefreshPurchaseSuggestions());
                    // æ–‡ä»¶é€‰æ‹©å˜åŒ–äº‹ä»¶
                    this.addEventListener('alert-import-file', 'change', (e) => this.previewAlertImport(e.target.files[0]));
                    
                    // æ ‡è®°ä¸ºå·²ç»‘å®š
                    this.eventsBound.alertsPage = true;
                }
                

                // åˆå§‹åŒ–è§†å›¾
                this.switchAlertView('table');
                
                console.log('é¢„è­¦ç®¡ç†é¡µé¢å·²åŠ è½½');
            }
            
// åˆ·æ–°é¢„è­¦åˆ—è¡¨
            refreshAlerts() {
           // å¼ºåˆ¶é‡æ–°è®¡ç®—é¢„è­¦æ•°æ®
           this.onInventoryDataChanged();
           alert('é¢„è­¦åˆ—è¡¨å·²åˆ·æ–°ï¼Œä½¿ç”¨æœ€æ–°åº“å­˜æ•°æ®');
            }

 // æœç´¢é¢„è­¦äº§å“
            filterAlerts(searchTerm) {
                this.alertsPageState.searchTerm = searchTerm;
                this.alertsPageState.currentPage = 1;
                this.renderAlertList();
            }
            
            // æŒ‰çŠ¶æ€ç­›é€‰é¢„è­¦äº§å“
            filterAlertsByStatus(status) {
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.status-filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                this.alertsPageState.statusFilter = status;
                this.alertsPageState.currentPage = 1;
                this.renderAlertList();
            }

// åˆ‡æ¢è§†å›¾æ¨¡å¼
            switchAlertView(view) {
                this.alertsPageState.currentView = view;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`.view-toggle-btn[data-view="${view}"]`).classList.add('active');
                
                // æ˜¾ç¤º/éšè—å¯¹åº”è§†å›¾
                if (view === 'table') {
                    document.getElementById('alert-table-view').style.display = 'block';
                    document.getElementById('alert-card-view').style.display = 'none';
                } else {
                    document.getElementById('alert-table-view').style.display = 'none';
                    document.getElementById('alert-card-view').style.display = 'grid';
                }
                
                this.renderAlertList();
            }
            
            // æ”¹å˜é¢„è­¦é¡µé¢
            changeAlertPage(direction) {
                const totalPages = Math.ceil(this.getFilteredAlerts().length / this.alertsPageState.itemsPerPage);
                
                if (direction === -1 && this.alertsPageState.currentPage > 1) {
                    this.alertsPageState.currentPage--;
                } else if (direction === 1 && this.alertsPageState.currentPage < totalPages) {
                    this.alertsPageState.currentPage++;
                }
                
                this.renderAlertList();
            }

// è·å–ç­›é€‰åçš„é¢„è­¦åˆ—è¡¨
            getFilteredAlerts() {
                let filtered = this.alertConfig;
                
                // åº”ç”¨æœç´¢ç­›é€‰
                if (this.alertsPageState.searchTerm) {
                    const searchTerm = this.alertsPageState.searchTerm.toLowerCase();
                    filtered = filtered.filter(config => {
                        const searchText = `${config.brand || ''} ${config.name || ''} ${config.model || ''} ${config.orderNumber || ''}`.toLowerCase();
                        return searchText.includes(searchTerm);
                    });
                }
                
                // åº”ç”¨çŠ¶æ€ç­›é€‰
                if (this.alertsPageState.statusFilter !== 'all') {
                    filtered = filtered.filter(config => {
                        // æŸ¥æ‰¾å¯¹åº”çš„åº“å­˜æ•°æ®
                        const inventoryItems = this.inventoryData.filter(item => item.orderNumber === config.orderNumber);
                        const currentStock = inventoryItems.reduce((sum, item) => sum + (parseInt(item.stockQty) || 0), 0);
                        
                        if (this.alertsPageState.statusFilter === 'low') {
                            return currentStock < config.minStock;
                        } else if (this.alertsPageState.statusFilter === 'high') {
                            return currentStock > config.maxStock;
                        } else if (this.alertsPageState.statusFilter === 'normal') {
                            return currentStock >= config.minStock && currentStock <= config.maxStock;
                        }
                        return true;
                    });
                }
                
                return filtered;
            }



// æ‰“å¼€å¯¼å…¥é¢„è­¦é…ç½®æ¨¡æ€æ¡†
openImportAlertModal() {
    document.getElementById('import-alert-modal').style.display = 'flex';
    document.getElementById('alert-import-file').value = '';
    document.getElementById('alert-import-preview').style.display = 'none';
}

// é¢„è§ˆå¯¼å…¥çš„é¢„è­¦é…ç½®
previewAlertImport(file) {
    const previewContainer = document.getElementById('alert-import-preview');
    const previewContent = document.getElementById('alert-import-preview-content');
    
    if (!file) {
        previewContainer.style.display = 'none';
        return;
    }
    
    const fileExtension = file.name.split('.').pop().toLowerCase();
    const reader = new FileReader();
    
    reader.onload = (e) => {
        try {
            let alertData = [];
            
            if (fileExtension === 'json') {
                alertData = JSON.parse(e.target.result);
            } else if (['xlsx', 'xls'].includes(fileExtension)) {
                if (!this.excelSupported) {
                    throw new Error('ExcelåŠŸèƒ½ä¸å¯ç”¨');
                }
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                alertData = XLSX.utils.sheet_to_json(worksheet);
                
                // Excelåˆ—æ˜ å°„
                const columnMapping = {
                    'å“ç‰Œ': 'brand',
                    'äº§å“åç§°': 'name', 
                    'å‹å·': 'model',
                    'è®¢è´§å·': 'orderNumber',
                    'æœ€ä½åº“å­˜': 'minStock',
                    'æœ€é«˜åº“å­˜': 'maxStock'
                };
                
                alertData = alertData.map(item => {
                    const newItem = {};
                    for (const key in item) {
                        if (columnMapping[key]) {
                            newItem[columnMapping[key]] = item[key];
                        } else {
                            newItem[key] = item[key];
                        }
                    }
                    return newItem;
                });
            } else {
                throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼');
            }
            
            // éªŒè¯æ•°æ®æ ¼å¼
            if (!Array.isArray(alertData)) {
                throw new Error('æ•°æ®æ ¼å¼é”™è¯¯ï¼šåº”ä¸ºæ•°ç»„æ ¼å¼');
            }
            
            // æ˜¾ç¤ºé¢„è§ˆ
            previewContent.innerHTML = `
                <div>æ‰¾åˆ° ${alertData.length} æ¡é¢„è­¦é…ç½®</div>
                <div style="margin-top: 8px; max-height: 120px; overflow-y: auto;">
                    ${alertData.slice(0, 10).map(item => `
                        <div style="padding: 4px; border-bottom: 1px solid #eee; font-size: 0.75rem;">
                            ${item.brand || ''} ${item.name || ''} ${item.model || ''} 
                            (${item.orderNumber || 'æ— è®¢è´§å·'}) - åº“å­˜: ${item.minStock || 0}-${item.maxStock || 0}
                        </div>
                    `).join('')}
                    ${alertData.length > 10 ? `<div style="padding: 4px; color: #666;">... è¿˜æœ‰ ${alertData.length - 10} æ¡è®°å½•</div>` : ''}
                </div>
            `;
            
            previewContainer.style.display = 'block';
            
        } catch (error) {
            previewContent.innerHTML = `<div style="color: #e74c3c;">æ–‡ä»¶è§£æé”™è¯¯: ${error.message}</div>`;
            previewContainer.style.display = 'block';
        }
    };
    
    if (fileExtension === 'json') {
        reader.readAsText(file);
    } else {
        reader.readAsArrayBuffer(file);
    }
}

// ç¡®è®¤å¯¼å…¥é¢„è­¦é…ç½®
confirmAlertImport() {
    const fileInput = document.getElementById('alert-import-file');
    const importMode = document.querySelector('input[name="import-mode"]:checked').value;
    const statusDiv = document.getElementById('alert-import-status');
    
    if (!fileInput.files.length) {
        alert('è¯·é€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶');
        return;
    }
    
    const file = fileInput.files[0];
    const fileExtension = file.name.split('.').pop().toLowerCase();
    const reader = new FileReader();
    
    reader.onload = (e) => {
        try {
            let importedData = [];
            
            if (fileExtension === 'json') {
                importedData = JSON.parse(e.target.result);
            } else {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                importedData = XLSX.utils.sheet_to_json(worksheet);
                
                // åŒæ ·çš„Excelåˆ—æ˜ å°„é€»è¾‘
                const columnMapping = {
                    'å“ç‰Œ': 'brand',
                    'äº§å“åç§°': 'name',
                    'å‹å·': 'model', 
                    'è®¢è´§å·': 'orderNumber',
                    'æœ€ä½åº“å­˜': 'minStock',
                    'æœ€é«˜åº“å­˜': 'maxStock'
                };
                
                importedData = importedData.map(item => {
                    const newItem = {};
                    for (const key in item) {
                        if (columnMapping[key]) {
                            newItem[columnMapping[key]] = item[key];
                        } else {
                            newItem[key] = item[key];
                        }
                    }
                    return newItem;
                });
            }
            
            // æ•°æ®éªŒè¯
            const validData = importedData.filter(item => 
                item.orderNumber && 
                (item.minStock !== undefined || item.maxStock !== undefined)
            );
            
            if (validData.length === 0) {
                throw new Error('æ²¡æœ‰æœ‰æ•ˆçš„é¢„è­¦é…ç½®æ•°æ®');
            }
            
            // åº”ç”¨å¯¼å…¥æ¨¡å¼
            if (importMode === 'replace') {
                this.alertConfig = validData;
            } else {
                // åˆå¹¶æ¨¡å¼ï¼šä»¥è®¢è´§å·ä¸ºé”®ï¼Œé¿å…é‡å¤
                const existingMap = new Map();
                this.alertConfig.forEach(item => {
                    existingMap.set(item.orderNumber, item);
                });
                
                validData.forEach(item => {
                    existingMap.set(item.orderNumber, item);
                });
                
                this.alertConfig = Array.from(existingMap.values());
            }
            
            this.saveToStorage();
            this.renderAlertList();
            this.renderPurchaseSuggestions();
            
            // æ˜¾ç¤ºå¯¼å…¥çŠ¶æ€
            statusDiv.textContent = `æˆåŠŸå¯¼å…¥ ${validData.length} æ¡é¢„è­¦é…ç½®`;
            statusDiv.style.color = '#27ae60';
            statusDiv.style.display = 'block';
            
            // å…³é—­æ¨¡æ€æ¡†
            document.getElementById('import-alert-modal').style.display = 'none';
            
        } catch (error) {
            statusDiv.textContent = `å¯¼å…¥å¤±è´¥: ${error.message}`;
            statusDiv.style.color = '#e74c3c';
            statusDiv.style.display = 'block';
        }
    };
    
    if (fileExtension === 'json') {
        reader.readAsText(file);
    } else {
        reader.readAsArrayBuffer(file);
    }
}

// å¯¼å‡ºé¢„è­¦é…ç½®
exportAlertConfig() {
        // é˜²æ­¢é‡å¤ç‚¹å‡»
        const exportBtn = document.getElementById('export-alert-config');
        if (exportBtn.disabled) return;
        
        exportBtn.disabled = true;
        
        try {
            if (this.alertConfig.length === 0) {
                alert('æ²¡æœ‰é¢„è­¦é…ç½®å¯å¯¼å‡º');
                return;
            }
            
            // åˆ›å»ºå¯¼å‡ºæ•°æ®
            const exportData = this.alertConfig.map(config => ({
                'å“ç‰Œ': config.brand || '',
                'äº§å“åç§°': config.name || '', 
                'å‹å·': config.model || '',
                'è®¢è´§å·': config.orderNumber,
                'æœ€ä½åº“å­˜': config.minStock,
                'æœ€é«˜åº“å­˜': config.maxStock,
                'åˆ›å»ºæ—¶é—´': new Date().toLocaleString()
            }));
            
            // åˆ›å»ºExcelå·¥ä½œè¡¨
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'é¢„è­¦é…ç½®');
            
            // å¯¼å‡ºæ–‡ä»¶
            XLSX.writeFile(workbook, `åº“å­˜é¢„è­¦é…ç½®_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            // åŒæ—¶æä¾›JSONæ ¼å¼ä¸‹è½½
            const jsonData = JSON.stringify(this.alertConfig, null, 2);
            const jsonBlob = new Blob([jsonData], { type: 'application/json' });
            const jsonUrl = URL.createObjectURL(jsonBlob);
            const jsonLink = document.createElement('a');
            jsonLink.href = jsonUrl;
            jsonLink.download = `åº“å­˜é¢„è­¦é…ç½®_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(jsonLink);
            jsonLink.click();
            document.body.removeChild(jsonLink);
            URL.revokeObjectURL(jsonUrl);
            
            alert(`é¢„è­¦é…ç½®å¯¼å‡ºæˆåŠŸï¼Œå…± ${this.alertConfig.length} æ¡è®°å½•`);
            
        } catch (error) {
            alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
        } finally {
            // é‡æ–°å¯ç”¨æŒ‰é’®
            setTimeout(() => {
                exportBtn.disabled = false;
            }, 1000);
        }
    }
// ç”Ÿæˆé‡‡è´­å»ºè®®æ¸…å•
generatePurchaseSuggestions() {
    const suggestions = [];
    
    this.alertConfig.forEach(config => {
        // ä½¿ç”¨ä¿®æ­£åçš„æ–¹æ³•è·å–å½“å‰åº“å­˜ - ä½¿ç”¨å‹å·åŒ¹é…
        const currentStock = this.getAlertCurrentStock(config);
        const minStock = parseInt(config.minStock) || 0;
        const maxStock = parseInt(config.maxStock) || 0;
        
        console.log(`é‡‡è´­å»ºè®®è®¡ç®— - å‹å·: ${config.model}, å½“å‰åº“å­˜: ${currentStock}, æœ€ä½åº“å­˜: ${minStock}`);
        
        // åªæœ‰å½“åº“å­˜ä½äºæœ€ä½åº“å­˜æ—¶æ‰ç”Ÿæˆé‡‡è´­å»ºè®®
        if (currentStock < minStock) {
            // è®¡ç®—å»ºè®®é‡‡è´­é‡
            let suggestedQty = minStock - currentStock;
            
            // å¦‚æœè®¾ç½®äº†æœ€é«˜åº“å­˜ï¼Œè€ƒè™‘åˆç†çš„é‡‡è´­æ‰¹é‡
            if (maxStock > 0) {
                suggestedQty = Math.min(suggestedQty, maxStock - currentStock);
            }
            
            // ç¡®ä¿å»ºè®®é‡‡è´­é‡æ˜¯æ­£æ•°
            if (suggestedQty > 0) {
                // ç¡®å®šç´§æ€¥ç¨‹åº¦
                let urgency = 'normal';
                let expectedDays = '7-10å¤©';
                
                if (currentStock === 0) {
                    urgency = 'urgent';
                    expectedDays = '3-5å¤©';
                } else if (currentStock < minStock * 0.3) {
                    urgency = 'urgent';
                    expectedDays = '5-7å¤©';
                } else if (currentStock < minStock * 0.5) {
                    urgency = 'normal';
                    expectedDays = '7-10å¤©';
                }
                
                suggestions.push({
                    brand: config.brand,
                    name: config.name,
                    model: config.model,
                    orderNumber: config.orderNumber,
                    currentStock: currentStock,
                    minStock: minStock,
                    maxStock: maxStock,
                    suggestedQty: suggestedQty,
                    urgency: urgency,
                    expectedDays: expectedDays
                });
                
                console.log(`ç”Ÿæˆé‡‡è´­å»ºè®® - å‹å·: ${config.model}, å»ºè®®é‡‡è´­: ${suggestedQty}, ç´§æ€¥ç¨‹åº¦: ${urgency}`);
            }
        }
    });
    
    // æŒ‰ç´§æ€¥ç¨‹åº¦æ’åº
    const urgencyOrder = { 'urgent': 1, 'normal': 2 };
    suggestions.sort((a, b) => {
        if (a.urgency !== b.urgency) {
            return urgencyOrder[a.urgency] - urgencyOrder[b.urgency];
        }
        return a.suggestedQty - b.suggestedQty;
    });
    
    console.log('æœ€ç»ˆé‡‡è´­å»ºè®®åˆ—è¡¨:', suggestions);
    return suggestions;
}
// æ·»åŠ æ•°æ®éªŒè¯æ–¹æ³•
validateAlertData() {
    console.group('é¢„è­¦æ•°æ®éªŒè¯æŠ¥å‘Š');
    
    this.alertConfig.forEach((config, index) => {
        const currentStock = this.getAlertCurrentStock(config);
        const matchingItems = this.inventoryData.filter(item => 
            item.model && item.model.toString().trim() === config.model.toString().trim()
        );
        
        console.log(`é¢„è­¦é…ç½® ${index + 1}:`, {
            å‹å·: config.model,
            è®¢è´§å·: config.orderNumber,
            å½“å‰åº“å­˜: currentStock,
            åŒ¹é…çš„åº“å­˜è®°å½•æ•°: matchingItems.length,
            åŒ¹é…çš„åº“å­˜è®°å½•: matchingItems.map(item => ({
                å‹å·: item.model,
                åº“å­˜æ•°é‡: item.stockQty,
                å¯ç”¨æ•°é‡: item.availableQty
            }))
        });
    });
    
    console.groupEnd();
}

// æ¸²æŸ“é‡‡è´­å»ºè®®æ¸…å•
renderPurchaseSuggestions() {
    const tbody = document.getElementById('purchase-suggestions-list');
    const suggestions = this.generatePurchaseSuggestions();
    
    console.log('æ¸²æŸ“é‡‡è´­å»ºè®®åˆ—è¡¨ï¼Œé¡¹ç›®æ•°:', suggestions.length);
    
    if (suggestions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">æš‚æ— é‡‡è´­å»ºè®®</td></tr>';
        return;
    }
    
    tbody.innerHTML = suggestions.map(suggestion => {
        let urgencyClass = '';
        let urgencyText = '';
        
        switch (suggestion.urgency) {
            case 'urgent':
                urgencyClass = 'warning';
                urgencyText = 'æ€¥éœ€é‡‡è´­';
                break;
            case 'normal':
                urgencyClass = 'success';
                urgencyText = 'å¸¸è§„é‡‡è´­';
                break;
            default:
                urgencyClass = '';
                urgencyText = 'ç›‘æ§åº“å­˜';
        }
        
        // è°ƒè¯•ä¿¡æ¯ - æ£€æŸ¥æ¯ä¸ªå»ºè®®çš„åº“å­˜å€¼
        console.log(`æ¸²æŸ“é‡‡è´­å»ºè®® - å‹å·: ${suggestion.model}, å½“å‰åº“å­˜: ${suggestion.currentStock}`);
        
        return `
            <tr class="${suggestion.urgency === 'urgent' ? 'low-stock' : ''}">
                <td>${suggestion.brand || 'æœªè®¾ç½®'} ${suggestion.name || 'æœªè®¾ç½®'}</td>
                <td>${suggestion.model || 'æœªè®¾ç½®'}</td>
                <td>${suggestion.orderNumber}</td>
                <td>${suggestion.currentStock}</td> <!-- è¿™é‡Œåº”è¯¥æ˜¾ç¤ºæ­£ç¡®çš„åº“å­˜ -->
                <td>${suggestion.minStock}</td>
                <td><strong>${suggestion.suggestedQty}</strong></td>
                <td><span class="${urgencyClass}">${urgencyText}</span></td>
                <td>${suggestion.expectedDays}</td>
                <td>
                    <button class="btn-sm" onclick="inventoryManager.createPurchaseOrder('${suggestion.orderNumber}', ${suggestion.suggestedQty})">
                        åˆ›å»ºé‡‡è´­å•
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}
// å¼ºåˆ¶åˆ·æ–°é‡‡è´­å»ºè®®
forceRefreshPurchaseSuggestions() {
    console.log('å¼ºåˆ¶åˆ·æ–°é‡‡è´­å»ºè®®...');
    
    // é‡æ–°è®¡ç®—æ‰€æœ‰é¢„è­¦äº§å“çš„å½“å‰åº“å­˜
    this.alertConfig.forEach(config => {
        const currentStock = this.getAlertCurrentStock(config);
        console.log(`é‡‡è´­å»ºè®® - äº§å“ ${config.model} åº“å­˜: ${currentStock}`);
    });
    
    this.renderPurchaseSuggestions();
    alert('é‡‡è´­å»ºè®®å·²åˆ·æ–°');
}
// åˆ·æ–°é‡‡è´­å»ºè®®
refreshPurchaseSuggestions() {
    this.renderPurchaseSuggestions();
    const suggestions = this.generatePurchaseSuggestions();
    alert(`å·²åˆ·æ–°é‡‡è´­å»ºè®®ï¼Œå…± ${suggestions.length} æ¡å»ºè®®`);
}

// åº”ç”¨é‡‡è´­ç­›é€‰
applyPurchaseFilter() {
    const filterValue = document.getElementById('purchase-filter').value;
    const searchTerm = document.getElementById('purchase-search').value.toLowerCase();
    
    const rows = document.querySelectorAll('#purchase-suggestions-list tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        if (row.cells.length < 9) return; // è·³è¿‡ç©ºè¡Œ
        
        const urgencyCell = row.cells[6];
        const productText = row.cells[0].textContent.toLowerCase() + ' ' + 
                           row.cells[1].textContent.toLowerCase() + ' ' + 
                           row.cells[2].textContent.toLowerCase();
        
        let showRow = true;
        
        // åº”ç”¨ç´§æ€¥ç¨‹åº¦ç­›é€‰
        if (filterValue !== 'all') {
            const urgencyText = urgencyCell.textContent;
            if (filterValue === 'urgent' && urgencyText !== 'æ€¥éœ€é‡‡è´­') {
                showRow = false;
            } else if (filterValue === 'normal' && urgencyText !== 'å¸¸è§„é‡‡è´­') {
                showRow = false;
            } else if (filterValue === 'monitor' && urgencyText !== 'ç›‘æ§åº“å­˜') {
                showRow = false;
            }
        }
        
        // åº”ç”¨æœç´¢ç­›é€‰
        if (showRow && searchTerm && !productText.includes(searchTerm)) {
            showRow = false;
        }
        
        row.style.display = showRow ? '' : 'none';
        if (showRow) visibleCount++;
    });
    
    // å¦‚æœæ²¡æœ‰å¯è§è¡Œï¼Œæ˜¾ç¤ºæç¤º
    if (visibleCount === 0) {
        const tbody = document.getElementById('purchase-suggestions-list');
        if (!tbody.querySelector('tr[style*="display: none"]')) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">æ²¡æœ‰åŒ¹é…çš„é‡‡è´­å»ºè®®</td></tr>';
        }
    }
}

// å¯¼å‡ºé‡‡è´­å»ºè®®
 exportPurchaseSuggestions() {
        const exportBtn = document.getElementById('export-purchase-suggestions');
        if (exportBtn.disabled) return;
        
        exportBtn.disabled = true;
        
        try {
            const suggestions = this.generatePurchaseSuggestions();
            
            if (suggestions.length === 0) {
                alert('æ²¡æœ‰é‡‡è´­å»ºè®®å¯å¯¼å‡º');
                return;
            }
            
            // åˆ›å»ºå¯¼å‡ºæ•°æ®
            const exportData = suggestions.map(suggestion => ({
                'äº§å“åç§°': `${suggestion.brand || ''} ${suggestion.name || ''}`.trim(),
                'å‹å·': suggestion.model || '',
                'è®¢è´§å·': suggestion.orderNumber,
                'å½“å‰åº“å­˜': suggestion.currentStock,
                'å®‰å…¨åº“å­˜': suggestion.minStock,
                'å»ºè®®é‡‡è´­é‡': suggestion.suggestedQty,
                'ç´§æ€¥ç¨‹åº¦': suggestion.urgency === 'urgent' ? 'æ€¥éœ€é‡‡è´­' : 'å¸¸è§„é‡‡è´­',
                'å»ºè®®åˆ°è´§æ—¶é—´': suggestion.expectedDays,
                'å¯¼å‡ºæ—¶é—´': new Date().toLocaleString()
            }));
            
            // åˆ›å»ºExcelå·¥ä½œè¡¨
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'é‡‡è´­å»ºè®®');
            
            // å¯¼å‡ºæ–‡ä»¶
            XLSX.writeFile(workbook, `é‡‡è´­å»ºè®®æ¸…å•_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            alert(`é‡‡è´­å»ºè®®å¯¼å‡ºæˆåŠŸï¼Œå…± ${suggestions.length} æ¡å»ºè®®`);
            
        } catch (error) {
            alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
        } finally {
            setTimeout(() => {
                exportBtn.disabled = false;
            }, 1000);
        }
    }
// åˆ›å»ºé‡‡è´­å•ï¼ˆç¤ºä¾‹åŠŸèƒ½ï¼‰
createPurchaseOrder(orderNumber, quantity) {
    const product = this.alertConfig.find(config => config.orderNumber === orderNumber);
    if (product) {
        const message = `
åˆ›å»ºé‡‡è´­å•:
äº§å“: ${product.brand || ''} ${product.name || ''}
å‹å·: ${product.model || ''}
è®¢è´§å·: ${orderNumber}
é‡‡è´­æ•°é‡: ${quantity}
å»ºè®®åˆ°è´§: 7ä¸ªå·¥ä½œæ—¥å†…

ç¡®å®šè¦åˆ›å»ºé‡‡è´­å•å—ï¼Ÿ
        `;
        
        if (confirm(message)) {
            // è¿™é‡Œå¯ä»¥é›†æˆå®é™…çš„é‡‡è´­å•åˆ›å»ºé€»è¾‘
            alert('é‡‡è´­å•åˆ›å»ºè¯·æ±‚å·²æäº¤');
            
            // ç¤ºä¾‹ï¼šè®°å½•é‡‡è´­å†å²
            const purchaseHistory = this.getStorage('purchaseHistory') || [];
            purchaseHistory.push({
                orderNumber: orderNumber,
                quantity: quantity,
                productInfo: `${product.brand || ''} ${product.name || ''}`,
                created: new Date().toISOString(),
                status: 'pending'
            });
            this.setStorage('purchaseHistory', purchaseHistory);
        }
    }
}


// ç¼–è¾‘é¢„è­¦é…ç½®
editAlertConfig(index) {
    const config = this.alertConfig[index];
    
    // å¡«å……ç°æœ‰æ•°æ®åˆ°æ¨¡æ€æ¡†
    document.getElementById('alert-brand').value = config.brand || '';
    document.getElementById('alert-name').value = config.name || '';
    document.getElementById('alert-model').value = config.model || '';
    document.getElementById('alert-order-number').value = config.orderNumber;
    document.getElementById('alert-min-stock').value = config.minStock;
    document.getElementById('alert-max-stock').value = config.maxStock;
    
    // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
    document.getElementById('add-alert-modal').style.display = 'flex';
    
    // ä¸´æ—¶ä¿å­˜ç¼–è¾‘ç´¢å¼•
    this.editingAlertIndex = index;
}

// åˆ é™¤é¢„è­¦é…ç½®
deleteAlertConfig(index) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢„è­¦é…ç½®å—ï¼Ÿ')) {
        this.alertConfig.splice(index, 1);
        this.saveToStorage();
        this.renderAlertList();
        this.renderPurchaseSuggestions();
        alert('é¢„è­¦é…ç½®å·²åˆ é™¤');
    }
}

// ä¿®æ”¹ä¿å­˜é¢„è­¦äº§å“æ–¹æ³•ï¼Œæ”¯æŒç¼–è¾‘
saveAlertProduct() {
    const brand = document.getElementById('alert-brand').value;
    const name = document.getElementById('alert-name').value;
    const model = document.getElementById('alert-model').value;
    const orderNumber = document.getElementById('alert-order-number').value;
    const minStock = parseInt(document.getElementById('alert-min-stock').value) || 5;
    const maxStock = parseInt(document.getElementById('alert-max-stock').value) || 100;
    
    // éªŒè¯å‹å·å¿…å¡«
    if (!model) {
        alert('è¯·è¾“å…¥äº§å“å‹å·');
        return;
    }
    
    const alertProduct = {
        brand, 
        name, 
        model: model.trim(), // ç¡®ä¿å»é™¤ç©ºæ ¼
        orderNumber, 
        minStock, 
        maxStock
    };
    
    if (this.editingAlertIndex !== undefined) {
        // ç¼–è¾‘æ¨¡å¼
        this.alertConfig[this.editingAlertIndex] = alertProduct;
        delete this.editingAlertIndex;
    } else {
        // æ–°å¢æ¨¡å¼
        this.alertConfig.push(alertProduct);
    }
    
    this.saveToStorage();
    this.renderAlertList();
    this.renderPurchaseSuggestions();
    document.getElementById('add-alert-modal').style.display = 'none';
    
    // æ¸…ç©ºè¡¨å•
    ['alert-brand', 'alert-name', 'alert-model', 'alert-order-number'].forEach(id => {
        document.getElementById(id).value = '';
    });
    
    alert('é¢„è­¦äº§å“ä¿å­˜æˆåŠŸ');
}

            showAddAlertModal() {
                document.getElementById('add-alert-modal').style.display = 'flex';
            }
            
            saveAlertProduct() {
                const brand = document.getElementById('alert-brand').value;
                const name = document.getElementById('alert-name').value;
                const model = document.getElementById('alert-model').value;
                const orderNumber = document.getElementById('alert-order-number').value;
                const minStock = parseInt(document.getElementById('alert-min-stock').value) || 5;
                const maxStock = parseInt(document.getElementById('alert-max-stock').value) || 100;
                
                if (!orderNumber) {
                    alert('è¯·è¾“å…¥è®¢è´§å·');
                    return;
                }
                
                this.alertConfig.push({
                    brand, name, model, orderNumber, minStock, maxStock
                });
                
                this.saveToStorage();
                this.renderAlertList();
                document.getElementById('add-alert-modal').style.display = 'none';
                
                // æ¸…ç©ºè¡¨å•
                ['alert-brand', 'alert-name', 'alert-model', 'alert-order-number'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                
                alert('é¢„è­¦äº§å“æ·»åŠ æˆåŠŸ');
            }

            
           // æ›´æ–°é¢„è­¦åˆ—è¡¨æ¸²æŸ“ï¼Œæ·»åŠ æ“ä½œåˆ—
renderAlertList() {
    const filteredAlerts = this.getFilteredAlerts();
    const totalItems = filteredAlerts.length;
    const totalPages = Math.ceil(totalItems / this.alertsPageState.itemsPerPage);
    
    // è®¡ç®—å½“å‰é¡µçš„æ•°æ®
    const startIndex = (this.alertsPageState.currentPage - 1) * this.alertsPageState.itemsPerPage;
    const endIndex = Math.min(startIndex + this.alertsPageState.itemsPerPage, totalItems);
    const currentPageData = filteredAlerts.slice(startIndex, endIndex);
    
    // æ›´æ–°åˆ†é¡µä¿¡æ¯
    document.getElementById('alert-pagination-info').textContent = 
        `æ˜¾ç¤º ${startIndex + 1}-${endIndex} æ¡ï¼Œå…± ${totalItems} æ¡`;
    
    // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
    document.getElementById('alert-prev-page').disabled = this.alertsPageState.currentPage <= 1;
    document.getElementById('alert-next-page').disabled = this.alertsPageState.currentPage >= totalPages;
    
    // æ›´æ–°é¡µç 
    this.renderPageNumbers(totalPages);
    
    // æ ¹æ®å½“å‰è§†å›¾æ¨¡å¼æ¸²æŸ“
    if (this.alertsPageState.currentView === 'table') {
        this.renderAlertTableView(currentPageData);
    } else {
        this.renderAlertCardView(currentPageData);
    }
}
 // ä¼˜åŒ–è¡¨æ ¼è§†å›¾ä¸­çš„åº“å­˜æ˜¾ç¤º
renderAlertTableView(alerts) {
    const tbody = document.getElementById('alert-list');
    
    if (alerts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">æš‚æ— é¢„è­¦æ•°æ®</td></tr>';
        return;
    }
    
    tbody.innerHTML = alerts.map((config, index) => {
        // ä½¿ç”¨æ–°çš„æ–¹æ³•è·å–å½“å‰åº“å­˜
        const currentStock = this.getAlertCurrentStock(config);
        
        let status = 'æ­£å¸¸';
        let statusClass = 'success';
        
        if (currentStock < config.minStock) {
            status = 'ä½åº“å­˜';
            statusClass = 'warning';
        } else if (currentStock > config.maxStock) {
            status = 'é«˜åº“å­˜';
            statusClass = 'warning';
        } else if (currentStock === 0) {
            status = 'ç¼ºè´§';
            statusClass = 'warning';
        }
        
        return `
            <tr class="${status !== 'æ­£å¸¸' ? 'low-stock' : ''}">
                <td>${config.brand || 'æœªè®¾ç½®'}</td>
                <td>${config.name || 'æœªè®¾ç½®'}</td>
                <td>${config.model || 'æœªè®¾ç½®'}</td>
                <td>${config.orderNumber}</td>
                <td>${currentStock}</td>
                <td>${config.minStock}</td>
                <td>${config.maxStock}</td>
                <td><span class="${statusClass}">${status}</span></td>
                <td>
                    <button class="btn-sm" onclick="inventoryManager.editAlertConfig(${this.alertConfig.indexOf(config)})" style="margin-right: 5px;">ç¼–è¾‘</button>
                    <button class="btn-sm" onclick="inventoryManager.deleteAlertConfig(${this.alertConfig.indexOf(config)})" style="background: #e74c3c;">åˆ é™¤</button>
                </td>
            </tr>
        `;
    }).join('');
}          
// æ¸²æŸ“å¡ç‰‡è§†å›¾
            renderAlertCardView(alerts) {
    const container = document.getElementById('alert-card-view');
    
    if (alerts.length === 0) {
        container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #7f8c8d;">æš‚æ— é¢„è­¦æ•°æ®</div>';
        return;
    }
    
    container.innerHTML = alerts.map((config, index) => {
        // ä½¿ç”¨æ–°çš„æ–¹æ³•è·å–å½“å‰åº“å­˜
        const currentStock = this.getAlertCurrentStock(config);
        
        let status = 'æ­£å¸¸';
        let statusClass = 'normal';
        
        if (currentStock < config.minStock) {
            status = 'ä½åº“å­˜';
            statusClass = 'warning';
        } else if (currentStock > config.maxStock) {
            status = 'é«˜åº“å­˜';
            statusClass = 'warning';
        } else if (currentStock === 0) {
            status = 'ç¼ºè´§';
            statusClass = 'warning';
        }
        
        return `
            <div class="alert-card">
                <div class="alert-card-header">
                    <div class="alert-product-info">
                        <h4>${config.name || 'æœªå‘½åäº§å“'}</h4>
                        <p>${config.brand || 'æ— å“ç‰Œ'} | ${config.model || 'æ— å‹å·'}</p>
                        <p style="margin-top: 5px; font-size: 0.75rem; color: #95a5a6;">${config.orderNumber}</p>
                    </div>
                    <div class="alert-status ${statusClass}">${status}</div>
                </div>
                <div class="alert-stats">
                    <div class="stat-item">
                        <div class="stat-label">å½“å‰åº“å­˜</div>
                        <div class="stat-value ${status !== 'æ­£å¸¸' ? 'warning' : ''}">${currentStock}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">å®‰å…¨èŒƒå›´</div>
                        <div class="stat-value">${config.minStock}-${config.maxStock}</div>
                    </div>
                </div>
                <div class="alert-actions">
                    <button class="btn-sm" onclick="inventoryManager.editAlertConfig(${this.alertConfig.indexOf(config)})">ç¼–è¾‘</button>
                    <button class="btn-sm" onclick="inventoryManager.deleteAlertConfig(${this.alertConfig.indexOf(config)})" style="background: #e74c3c;">åˆ é™¤</button>
                </div>
            </div>
        `;
    }).join('');
}

// æ¸²æŸ“é¡µç 
            renderPageNumbers(totalPages) {
                const container = document.getElementById('alert-page-numbers');
                container.innerHTML = '';
                
                // æ˜¾ç¤ºæœ€å¤š5ä¸ªé¡µç 
                const startPage = Math.max(1, this.alertsPageState.currentPage - 2);
                const endPage = Math.min(totalPages, startPage + 4);
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `pagination-btn ${i === this.alertsPageState.currentPage ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.addEventListener('click', () => {
                        this.alertsPageState.currentPage = i;
                        this.renderAlertList();
                    });
                    container.appendChild(pageBtn);
                }
            }

            // åº“ä½ç®¡ç†åŠŸèƒ½
            setupLocationPage() {
    this.renderShelves();
    this.setupLocationSearch();
    this.updateCurrentLocationDisplay();
    
    // ç¡®ä¿è´§æ¶ç‚¹å‡»äº‹ä»¶æ­£ç¡®ç»‘å®š
    setTimeout(() => {
        this.bindSlotClickEvents();
    }, 100);
    
    console.log('åº“ä½ç®¡ç†é¡µé¢å·²åŠ è½½');
}
            
            // æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†çš„åŠŸèƒ½
            setupLocationSearch() {
                // è®¾ç½®äº§å“æœç´¢åŠŸèƒ½
                const searchInput = document.getElementById('product-search-input');
                const searchResults = document.getElementById('product-search-results');
                
                // ç¡®ä¿æœç´¢å®¹å™¨æœ‰ç›¸å¯¹å®šä½
                searchInput.parentNode.style.position = 'relative';
                
                // ç‚¹å‡»å¤–éƒ¨éšè—æœç´¢ç»“æœ
                document.addEventListener('click', (e) => {
                    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                        searchResults.style.display = 'none';
                    }
                });
                
                // æ‰‹åŠ¨å…³è”æ¨¡æ€æ¡†çš„æœç´¢å¤–éƒ¨ç‚¹å‡»å¤„ç†
                const manualProductSearch = document.getElementById('manual-product-search');
                const manualProductResults = document.getElementById('manual-product-results');
                const manualLocationSearch = document.getElementById('manual-location-search');
                const manualLocationResults = document.getElementById('manual-location-results');
                
                if (manualProductSearch && manualProductResults) {
                    document.addEventListener('click', (e) => {
                        if (!manualProductSearch.contains(e.target) && !manualProductResults.contains(e.target)) {
                            manualProductResults.style.display = 'none';
                        }
                    });
                }
                
                if (manualLocationSearch && manualLocationResults) {
                    document.addEventListener('click', (e) => {
                        if (!manualLocationSearch.contains(e.target) && !manualLocationResults.contains(e.target)) {
                            manualLocationResults.style.display = 'none';
                        }
                    });
                }
            }
            
            // ä¼˜åŒ–äº§å“æœç´¢æ–¹æ³•
            searchProducts(searchTerm) {
                const searchResults = document.getElementById('product-search-results');
                searchResults.innerHTML = '';
                searchResults.style.display = 'none';
                
                if (!searchTerm || searchTerm.length < 1) return;
                
                // æŒ‰å‹å·åˆ†ç»„å»é‡
                const productMap = new Map();
                
                this.inventoryData.forEach(product => {
                    if (!product.model) return;
                    
                    const searchText = `${product.brand || ''} ${product.name || ''} ${product.model || ''} ${product.orderNumber || ''}`.toLowerCase();
                    if (searchText.includes(searchTerm.toLowerCase())) {
                        if (!productMap.has(product.model)) {
                            // æŸ¥æ‰¾è¯¥äº§å“çš„æ‰€æœ‰åº“ä½
                            const productLocations = this.locationData.filter(location => 
                                location.productModel === product.model
                            );
                            
                            productMap.set(product.model, {
                                model: product.model,
                                brand: product.brand,
                                name: product.name,
                                orderNumber: product.orderNumber,
                                locations: productLocations,
                                displayText: `${product.brand || ''} ${product.name || ''} ${product.model || ''}`
                            });
                        }
                    }
                });
                
                const filteredProducts = Array.from(productMap.values());
                
                if (filteredProducts.length === 0) {
                    searchResults.innerHTML = '<div class="search-result-item">æœªæ‰¾åˆ°åŒ¹é…çš„äº§å“</div>';
                    searchResults.style.display = 'block';
                    return;
                }
                
                filteredProducts.forEach(product => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.dataset.model = product.model;
                    
                    // ç”Ÿæˆåº“ä½ä¿¡æ¯å­—ç¬¦ä¸²
                    let locationInfo = '';
                    if (product.locations.length > 0) {
                        const locationCodes = product.locations.map(loc => loc.locationCode).join(', ');
                        locationInfo = `<div style="font-size: 0.7rem; color: #3498db; margin-top: 2px;">åº“ä½: ${locationCodes}</div>`;
                    } else {
                        locationInfo = '<div style="font-size: 0.7rem; color: #e74c3c; margin-top: 2px;">æœªåˆ†é…åº“ä½</div>';
                    }
                    
                    const orderNumberText = product.orderNumber ? `(${product.orderNumber})` : '';
                    
                    resultItem.innerHTML = `
                        <div style="font-size: 0.8rem; font-weight: 500;">
                            ${product.displayText} ${orderNumberText}
                        </div>
                        ${locationInfo}
                    `;
                    
                    resultItem.addEventListener('click', () => {
                        // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
                        document.querySelectorAll('#product-search-results .search-result-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        resultItem.classList.add('selected');
                        
                        // æ˜¾ç¤ºå®Œæ•´äº§å“ä¿¡æ¯åˆ°æœç´¢æ¡†
                        document.getElementById('product-search-input').value = product.displayText;
                        
                        // å¦‚æœæœ‰åº“ä½ï¼Œé«˜äº®æ˜¾ç¤º
                        if (product.locations.length > 0) {
                            this.highlightProductLocation(product.model);
                        } else {
                            this.clearHighlights();
                        }
                        
                        // é€‰æ‹©åéšè—ä¸‹æ‹‰æ¡†
                        searchResults.style.display = 'none';
                    });
                    
                    searchResults.appendChild(resultItem);
                });
                
                searchResults.style.display = 'block';
            }
            
            viewProductLocation() {
                const searchInput = document.getElementById('product-search-input');
                const searchTerm = searchInput.value.trim();
                
                if (!searchTerm) {
                    alert('è¯·å…ˆæœç´¢å¹¶é€‰æ‹©äº§å“');
                    return;
                }
                
                // æŸ¥æ‰¾åŒ¹é…çš„äº§å“
                const product = this.inventoryData.find(p => 
                    p.model && p.model.includes(searchTerm) ||
                    p.name && p.name.includes(searchTerm) ||
                    p.orderNumber && p.orderNumber.includes(searchTerm)
                );
                
                if (product) {
                    this.highlightProductLocation(product.model);
                } else {
                    alert('æœªæ‰¾åˆ°å¯¹åº”çš„äº§å“');
                }
            }
            
            clearProductSearch() {
                document.getElementById('product-search-input').value = '';
                this.clearHighlights();
            }
            
            highlightProductLocation(productModel) {
                this.clearHighlights();
                
                const productLocations = this.locationData.filter(location => location.productModel === productModel);
                
                if (productLocations.length === 0) {
                    alert('è¯¥äº§å“æ²¡æœ‰å…³è”çš„åº“ä½');
                    return;
                }
                
                productLocations.forEach(location => {
                    const slotElement = document.querySelector(`.slot[data-id="${location.locationCode}"]`);
                    if (slotElement) {
                        slotElement.classList.add('highlight');
                        this.highlightedSlots.push(slotElement);
                        
                        // æ»šåŠ¨åˆ°ç¬¬ä¸€ä¸ªé«˜äº®çš„åº“ä½
                        if (this.highlightedSlots.length === 1) {
                            slotElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                });
                
                this.updateCurrentLocationDisplay();
            }
            
            clearHighlights() {
                this.highlightedSlots.forEach(slot => {
                    slot.classList.remove('highlight');
                });
                this.highlightedSlots = [];
            }
            
            updateCurrentLocationDisplay() {
                const locationDisplay = document.getElementById('current-location-display');
                const allLocations = this.generateAllLocations();
                const occupiedLocations = this.locationData.length;
                const totalLocations = allLocations.length;
                
                locationDisplay.textContent = `åº“ä½: ${occupiedLocations}/${totalLocations}`;
                locationDisplay.title = `å·²å ç”¨: ${occupiedLocations}ä¸ª, æ€»å…±: ${totalLocations}ä¸ª`;
            }
            
            // è´§æ¶æ¸²æŸ“
           renderShelves() {
    const shelvesContainer = document.getElementById('shelves-container');
    shelvesContainer.innerHTML = '';

    for (let shelf = 1; shelf <= this.shelfConfig.shelfCount; shelf++) {
        const shelfLetter = String.fromCharCode(64 + shelf);
        const shelfConfigData = this.shelfConfig.individualConfig[shelfLetter] || {
            levels: this.shelfConfig.levelsPerShelf,
            slotsPerLevel: Array(this.shelfConfig.levelsPerShelf).fill(this.shelfConfig.slotsPerLevel)
        };

        const shelfElement = document.createElement('div');
        shelfElement.className = 'shelf';

        shelfElement.innerHTML = `<div class="shelf-header">${shelfLetter}æ¶</div>`;

        const levelsContainer = document.createElement('div');
        levelsContainer.className = 'shelf-levels';

        for (let level = 1; level <= shelfConfigData.levels; level++) {
            const levelElement = document.createElement('div');
            levelElement.className = 'shelf-level';

            const slotsCount = shelfConfigData.slotsPerLevel[level-1] || this.shelfConfig.slotsPerLevel;
            const occupiedCount = this.locationData.filter(item => 
                item.locationCode.startsWith(`${shelfLetter}${level}-`)
            ).length;

            levelElement.innerHTML = `
                <div class="level-header">
                    <span>${level}å±‚</span>
                    <span>${occupiedCount}/${slotsCount}</span>
                </div>
            `;

            const slotsContainer = document.createElement('div');
            slotsContainer.className = 'slots-container';
            slotsContainer.style.gridTemplateColumns = `repeat(${Math.min(slotsCount, 10)}, 1fr)`;

            for (let slot = 1; slot <= slotsCount; slot++) {
                const slotId = `${shelfLetter}${level}-${slot}`;
                const slotElement = this.createSlotElement(slotId);
                slotsContainer.appendChild(slotElement);
            }

            levelElement.appendChild(slotsContainer);
            levelsContainer.appendChild(levelElement);
        }

        shelfElement.appendChild(levelsContainer);
        shelvesContainer.appendChild(shelfElement);
    }

    // ç»‘å®šç‚¹å‡»äº‹ä»¶
    this.bindSlotClickEvents();
}
            
            createSlotElement(slotId) {
                const slotElement = document.createElement('div');
                slotElement.className = 'slot';
                slotElement.dataset.id = slotId;
                
                const locationItem = this.locationData.find(item => item.locationCode === slotId);
                
                if (locationItem) {
                    slotElement.classList.add('occupied');
                    
                    // æŸ¥æ‰¾äº§å“ä¿¡æ¯
                    const products = this.inventoryData.filter(p => p.model === locationItem.productModel);
                    const totalStock = products.reduce((sum, p) => sum + (parseInt(p.stockQty) || 0), 0);
                    
                    let displayText = locationItem.productModel;
                    if (displayText && displayText.length > 6) {
                        displayText = displayText.substring(0, 6) + '...';
                    }
                    
                    slotElement.innerHTML = `
                        <div style="text-align: center; line-height: 1.1;">
                            <div style="font-weight: bold;">${displayText || slotId}</div>
                            <div style="font-size: 8px; color: #666;">${locationItem.quantity || 0}/${totalStock}</div>
                        </div>
                    `;
                    
                    slotElement.title = `${locationItem.productModel} - æ•°é‡: ${locationItem.quantity || 0}/${totalStock}`;
                } else {
                    const shortId = slotId.replace(/^([A-Z])(\d)-(\d+)$/, '$1$2-$3');
                    slotElement.innerHTML = shortId;
                    slotElement.title = `ç©ºé—² - ${slotId}`;
                }
                
                return slotElement;
            }
            
            bindSlotClickEvents() {
    document.querySelectorAll('.slot').forEach(slot => {
        slot.addEventListener('click', (e) => {
            e.stopPropagation();
            const slotId = slot.dataset.id;
            this.openSlotAssignmentModal(slotId); // ç›´æ¥ä¼ å…¥åº“ä½ID
        });
    });
}
            
openSlotAssignmentModal(slotId) {
    const modal = document.getElementById('manual-assignment-modal');
    modal.style.display = 'flex';
    
    // è‡ªåŠ¨è®¾ç½®åº“ä½ä¿¡æ¯
    document.getElementById('manual-location-search').value = slotId;
    this.selectedManualLocation = slotId;
    
    // æŸ¥æ‰¾è¯¥åº“ä½æ˜¯å¦å·²æœ‰äº§å“å…³è”
    const existingLocation = this.locationData.find(item => item.locationCode === slotId);
    
    if (existingLocation) {
        // å¦‚æœå·²æœ‰äº§å“å…³è”ï¼Œè‡ªåŠ¨å¡«å……äº§å“ä¿¡æ¯
        const product = this.inventoryData.find(p => p.model === existingLocation.productModel);
        if (product) {
            document.getElementById('manual-product-search').value = 
                `${product.brand || ''} ${product.name || ''} ${product.model || ''}`.trim();
            this.selectedManualProduct = {
                model: product.model,
                brand: product.brand,
                name: product.name,
                orderNumber: product.orderNumber
            };
            
            // æ›´æ–°æ•°é‡ä¿¡æ¯
            document.getElementById('manual-assignment-quantity').value = existingLocation.quantity || 1;
            this.updateQuantityInfo(product.model, existingLocation.quantity || 0);
        }
    } else {
        // æ¸…ç©ºäº§å“ä¿¡æ¯
        document.getElementById('manual-product-search').value = '';
        this.selectedManualProduct = null;
        document.getElementById('manual-assignment-quantity').value = '1';
        
        // æ¸…ç©ºæ•°é‡ä¿¡æ¯
        document.getElementById('product-total-quantity').textContent = '0';
        document.getElementById('product-allocated-quantity').textContent = '0';
        document.getElementById('product-available-quantity').textContent = '0';
    }
    
    // é‡ç½®ç»“æœå®¹å™¨
    document.getElementById('manual-product-results').innerHTML = '';
    document.getElementById('manual-product-results').style.display = 'none';
    document.getElementById('manual-location-results').innerHTML = '';
    document.getElementById('manual-location-results').style.display = 'none';
}
            
            // æ‰‹åŠ¨å…³è”åŠŸèƒ½
            openManualAssignmentModal() {
    const modal = document.getElementById('manual-assignment-modal');
    modal.style.display = 'flex';
    
    // é‡ç½®é€‰æ‹©çŠ¶æ€
    this.selectedManualProduct = null;
    this.selectedManualLocation = null;
    
    // é‡ç½®è¾“å…¥æ¡†
    document.getElementById('manual-product-search').value = '';
    document.getElementById('manual-location-search').value = '';
    document.getElementById('manual-assignment-quantity').value = '1';
    
    // æ¸…ç©ºæ•°é‡ä¿¡æ¯
    document.getElementById('product-total-quantity').textContent = '0';
    document.getElementById('product-allocated-quantity').textContent = '0';
    document.getElementById('product-available-quantity').textContent = '0';
    
    // é‡ç½®ç»“æœå®¹å™¨
    document.getElementById('manual-product-results').innerHTML = '';
    document.getElementById('manual-product-results').style.display = 'none';
    document.getElementById('manual-location-results').innerHTML = '';
    document.getElementById('manual-location-results').style.display = 'none';
}
            
            // ä¼˜åŒ–æ‰‹åŠ¨å…³è”äº§å“æœç´¢
            searchProductsForManual(searchTerm, resultsContainerId) {
                const resultsContainer = document.getElementById(resultsContainerId);
                resultsContainer.innerHTML = '';
                
                if (!searchTerm || searchTerm.length < 1) {
                    resultsContainer.style.display = 'none';
                    return;
                }
                
                // æŒ‰å‹å·åˆ†ç»„å»é‡
                const productMap = new Map();
                
                this.inventoryData.forEach(product => {
                    if (!product.model) return;
                    
                    if (!productMap.has(product.model)) {
                        productMap.set(product.model, {
                            model: product.model,
                            brand: product.brand,
                            name: product.name,
                            orderNumber: product.orderNumber
                        });
                    }
                });
                
                const filteredProducts = Array.from(productMap.values()).filter(product => {
                    const searchText = `${product.brand || ''} ${product.name || ''} ${product.model || ''}`.toLowerCase();
                    return searchText.includes(searchTerm.toLowerCase());
                });
                
                if (filteredProducts.length === 0) {
                    resultsContainer.innerHTML = '<div class="product-item">æœªæ‰¾åˆ°åŒ¹é…çš„äº§å“</div>';
                    resultsContainer.style.display = 'block';
                    return;
                }
                
                filteredProducts.forEach(product => {
                    const productItem = document.createElement('div');
                    productItem.className = 'product-item';
                    productItem.dataset.model = product.model;
                    
                    const quantities = this.calculateProductQuantity(product.model);
                    const displayText = `${product.brand || ''} ${product.name || ''} ${product.model || ''} - æ€»åº“å­˜: ${quantities.total} | å¯åˆ†é…: ${quantities.available}`;
                    productItem.textContent = displayText.length > 60 ? displayText.substring(0, 60) + '...' : displayText;
                    productItem.title = displayText;
                    
                    productItem.addEventListener('click', () => {
                        document.querySelectorAll(`#${resultsContainerId} .product-item`).forEach(item => {
                            item.classList.remove('selected');
                        });
                        productItem.classList.add('selected');
                        this.selectedManualProduct = product;
                        
                        document.getElementById('manual-product-search').value = 
                            `${product.brand || ''} ${product.name || ''} ${product.model || ''}`;
                        resultsContainer.style.display = 'none';
                        
                        this.updateQuantityInfo(product.model, 0);
                        document.getElementById('manual-assignment-quantity').value = quantities.available;
                    });
                    
                    resultsContainer.appendChild(productItem);
                });
                
                resultsContainer.style.display = 'block';
            }
            
           // ä¼˜åŒ–æ‰‹åŠ¨å…³è”åº“ä½æœç´¢
            searchLocationsForManual(searchTerm, resultsContainerId) {
                const resultsContainer = document.getElementById(resultsContainerId);
                resultsContainer.innerHTML = '';
                
                if (!searchTerm || searchTerm.length < 1) {
                    resultsContainer.style.display = 'none';
                    return;
                }
                
                const allLocations = this.generateAllLocations();
                const filteredLocations = allLocations.filter(location => 
                    location.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                if (filteredLocations.length === 0) {
                    resultsContainer.innerHTML = '<div class="location-item">æœªæ‰¾åˆ°åŒ¹é…çš„åº“ä½</div>';
                    resultsContainer.style.display = 'block';
                    return;
                }
                
                filteredLocations.forEach(location => {
                    const locationItem = document.createElement('div');
                    locationItem.className = 'location-item';
                    locationItem.dataset.locationCode = location;
                    
                    // æ£€æŸ¥åº“ä½æ˜¯å¦å·²è¢«å ç”¨
                    const isOccupied = this.locationData.some(item => item.locationCode === location);
                    
                    if (isOccupied) {
                        locationItem.classList.add('occupied');
                        locationItem.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <span style="color: #999;">${location}</span>
                                <span style="color: #e74c3c; font-size: 0.8em;">å·²å ç”¨</span>
                            </div>
                        `;
                    } else {
                        locationItem.textContent = location;
                        locationItem.addEventListener('click', () => {
                            document.querySelectorAll(`#${resultsContainerId} .location-item:not(.occupied)`).forEach(item => {
                                item.classList.remove('selected');
                            });
                            locationItem.classList.add('selected');
                            this.selectedManualLocation = location;
                            
                            document.getElementById('manual-location-search').value = location;
                            resultsContainer.style.display = 'none';
                        });
                    }
                    
                    resultsContainer.appendChild(locationItem);
                });
                
                resultsContainer.style.display = 'block';
            }
            
            calculateProductQuantity(productModel) {
                const totalQuantity = this.inventoryData
                    .filter(item => item.model === productModel)
                    .reduce((sum, item) => sum + (parseInt(item.stockQty) || 0), 0);
                
                const allocatedQuantity = this.locationData
                    .filter(loc => loc.productModel === productModel)
                    .reduce((sum, loc) => sum + (parseInt(loc.quantity) || 0), 0);
                
                const availableQuantity = Math.max(0, totalQuantity - allocatedQuantity);
                
                return {
                    total: totalQuantity,
                    allocated: allocatedQuantity,
                    available: availableQuantity
                };
            }
            
            updateQuantityInfo(productModel, currentQuantity = 0) {
                const quantities = this.calculateProductQuantity(productModel);
                
                document.getElementById('product-total-quantity').textContent = quantities.total;
                document.getElementById('product-allocated-quantity').textContent = quantities.allocated;
                document.getElementById('product-available-quantity').textContent = quantities.available;
                
                const quantityInput = document.getElementById('manual-assignment-quantity');
                const maxQuantity = quantities.available + currentQuantity;
                quantityInput.max = maxQuantity;
                quantityInput.value = Math.min(parseInt(quantityInput.value) || quantities.available, maxQuantity);
            }
            
           confirmManualAssignment() {
    if (!this.selectedManualProduct) {
        alert('è¯·é€‰æ‹©äº§å“');
        return;
    }
    
    if (!this.selectedManualLocation) {
        alert('è¯·é€‰æ‹©åº“ä½');
        return;
    }
    
    const product = this.selectedManualProduct;
    const locationCode = this.selectedManualLocation;
    const quantityInput = document.getElementById('manual-assignment-quantity');
    const quantity = parseInt(quantityInput.value) || 0;
    
    if (quantity <= 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
        return;
    }
    
    // éªŒè¯æ•°é‡
    const quantities = this.calculateProductQuantity(product.model);
    const currentLocation = this.locationData.find(loc => loc.locationCode === locationCode);
    const currentQuantity = currentLocation ? parseInt(currentLocation.quantity) || 0 : 0;
    
    const maxAllowed = quantities.available + currentQuantity;
    if (quantity > maxAllowed) {
        alert(`æ•°é‡è¶…å‡ºé™åˆ¶ï¼æœ€å¤§å¯åˆ†é…æ•°é‡ä¸º ${maxAllowed}`);
        return;
    }
    
    const action = currentLocation ? 'æ›´æ–°' : 'å…³è”';
    const message = currentLocation ? 
        `ç¡®å®šå°†åº“ä½ ${locationCode} çš„äº§å“æ•°é‡ä» ${currentQuantity} æ›´æ–°ä¸º ${quantity} å—ï¼Ÿ` :
        `ç¡®å®šå°†äº§å“ "${product.model}" çš„ ${quantity} ä¸ªå…³è”åˆ°åº“ä½ ${locationCode} å—ï¼Ÿ`;
    
    if (confirm(message)) {
        this.confirmSlotAssignmentWithQuantity(locationCode, product.model, quantity);
        document.getElementById('manual-assignment-modal').style.display = 'none';
    }
}
            
            confirmSlotAssignmentWithQuantity(slotId, productModel, quantity) {
                const locationIndex = this.locationData.findIndex(item => item.locationCode === slotId);
                
                const products = this.inventoryData.filter(p => p.model === productModel);
                if (products.length === 0) {
                    alert('æœªæ‰¾åˆ°æŒ‡å®šçš„äº§å“å‹å·');
                    return false;
                }
                
                const locationItem = {
                    locationCode: slotId,
                    productModel: productModel,
                    orderNumber: products[0].orderNumber,
                    quantity: quantity,
                    lastUpdated: new Date().toISOString()
                };
                
                if (locationIndex >= 0) {
                    this.locationData[locationIndex] = locationItem;
                } else {
                    this.locationData.push(locationItem);
                }
                
                this.saveToStorage();
                this.renderShelves();
                this.updateCurrentLocationDisplay();
                
                alert(`æˆåŠŸå°† ${quantity} ä¸ªäº§å“ "${productModel}" å…³è”åˆ°åº“ä½ ${slotId}`);
                return true;
            }
            
            clearManualAssignment() {
    if (!this.selectedManualLocation) {
        alert('è¯·é€‰æ‹©è¦æ¸…é™¤å…³è”çš„åº“ä½');
        return;
    }
    
    const locationCode = this.selectedManualLocation;
    const existingLocation = this.locationData.find(item => item.locationCode === locationCode);
    
    if (!existingLocation) {
        alert(`åº“ä½ ${locationCode} åŸæœ¬å°±æ²¡æœ‰å…³è”äº§å“`);
        return;
    }
    
    // è‡ªåŠ¨è·å–äº§å“ä¿¡æ¯ï¼Œä¸éœ€è¦ç”¨æˆ·è¾“å…¥
    const productModel = existingLocation.productModel;
    
    if (confirm(`ç¡®å®šè¦æ¸…é™¤åº“ä½ ${locationCode} ä¸äº§å“ "${productModel}" çš„å…³è”å—ï¼Ÿ`)) {
        const locationIndex = this.locationData.findIndex(item => item.locationCode === locationCode);
        if (locationIndex >= 0) {
            this.locationData.splice(locationIndex, 1);
            this.saveToStorage();
            this.renderShelves();
            this.updateCurrentLocationDisplay();
            alert(`å·²æ¸…é™¤åº“ä½ ${locationCode} çš„å…³è”`);
            document.getElementById('manual-assignment-modal').style.display = 'none';
        }
    }
}
            
            generateAllLocations() {
                const allLocations = [];
                
                for (let shelf = 1; shelf <= this.shelfConfig.shelfCount; shelf++) {
                    const shelfLetter = String.fromCharCode(64 + shelf);
                    const shelfConfigData = this.shelfConfig.individualConfig[shelfLetter] || {
                        levels: this.shelfConfig.levelsPerShelf,
                        slotsPerLevel: Array(this.shelfConfig.levelsPerShelf).fill(this.shelfConfig.slotsPerLevel)
                    };
                    
                    for (let level = 1; level <= shelfConfigData.levels; level++) {
                        const slotsCount = shelfConfigData.slotsPerLevel[level-1] || this.shelfConfig.slotsPerLevel;
                        for (let slot = 1; slot <= slotsCount; slot++) {
                            const locationCode = `${shelfLetter}${level}-${slot}`;
                            allLocations.push(locationCode);
                        }
                    }
                }
                
                return allLocations;
            }
            
            getProductLocations(productModel, orderNumber) {
                const locationsByModel = this.locationData.filter(loc => loc.productModel === productModel);
                const locationsByOrderNumber = orderNumber ? 
                    this.locationData.filter(loc => loc.orderNumber === orderNumber) : [];
                
                const allLocations = [...locationsByModel, ...locationsByOrderNumber];
                return [...new Set(allLocations.map(loc => loc.locationCode))];
            }
            
            // è´§æ¶é…ç½®åŠŸèƒ½
openShelfConfigModal() {
    const modal = document.getElementById('shelf-config-modal');
    modal.style.display = 'flex';
    
    // è®¾ç½®å…¨å±€é…ç½®å€¼
    document.getElementById('global-shelf-count').value = this.shelfConfig.shelfCount;
    document.getElementById('global-levels-per-shelf').value = this.shelfConfig.levelsPerShelf;
    document.getElementById('global-slots-per-level').value = this.shelfConfig.slotsPerLevel;
    
    // å¡«å……è´§æ¶é€‰æ‹©ä¸‹æ‹‰æ¡†
    const shelfSelect = document.getElementById('select-shelf');
    shelfSelect.innerHTML = '';
    
    for (let i = 1; i <= this.shelfConfig.shelfCount; i++) {
        const shelfLetter = String.fromCharCode(64 + i);
        const option = document.createElement('option');
        option.value = shelfLetter;
        option.textContent = `${shelfLetter}æ¶`;
        shelfSelect.appendChild(option);
    }
    
    // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªè´§æ¶
    if (shelfSelect.options.length > 0) {
        this.updateShelfSpecificConfig(shelfSelect.value);
    }
    
    // è´§æ¶é€‰æ‹©å˜åŒ–äº‹ä»¶
    shelfSelect.addEventListener('change', (e) => {
        this.updateShelfSpecificConfig(e.target.value);
        this.updateShelfPreview();
    });
    
    // åˆå§‹åŒ–é¢„è§ˆ - ç¡®ä¿è¿™ä¸€è¡Œå­˜åœ¨
    this.updateShelfPreview();
    
    // æ·»åŠ å…¨å±€é…ç½®å˜åŒ–ç›‘å¬
    const globalConfigInputs = [
        'global-shelf-count', 'global-levels-per-shelf', 'global-slots-per-level'
    ];
    
    globalConfigInputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', () => {
                this.updateShelfPreview();
            });
        }
    });
}
            
          // ä¿®æ”¹ updateShelfSpecificConfig æ–¹æ³•ï¼Œæ·»åŠ é…ç½®å˜åŒ–ç›‘å¬
// ä¿®å¤ updateShelfSpecificConfig æ–¹æ³•
updateShelfSpecificConfig(shelfLetter) {
    const configContainer = document.getElementById('shelf-specific-config');
    configContainer.innerHTML = '';
    
    // å®‰å…¨åœ°è·å–è´§æ¶é…ç½®
    let shelfConfigData = this.shelfConfig.individualConfig[shelfLetter];
    
    // ç¡®ä¿é…ç½®æ˜¯æœ‰æ•ˆçš„å¯¹è±¡
    if (!shelfConfigData || typeof shelfConfigData !== 'object') {
        shelfConfigData = {
            levels: this.shelfConfig.levelsPerShelf,
            slotsPerLevel: Array(this.shelfConfig.levelsPerShelf).fill(this.shelfConfig.slotsPerLevel)
        };
    }
    
    // ç¡®ä¿ slotsPerLevel æ˜¯æ•°ç»„
    if (!Array.isArray(shelfConfigData.slotsPerLevel)) {
        shelfConfigData.slotsPerLevel = Array(shelfConfigData.levels || this.shelfConfig.levelsPerShelf)
            .fill(this.shelfConfig.slotsPerLevel);
    }
    
    const configHtml = `
        <div class="form-group">
            <label>${shelfLetter}æ¶å±‚æ•°</label>
            <input type="number" id="shelf-${shelfLetter}-levels" min="1" value="${shelfConfigData.levels}">
        </div>
        <div class="level-config">
            <label>å„å±‚åº“ä½æ•°é‡</label>
        </div>
    `;
    
    configContainer.innerHTML = configHtml;
    
    const levelsContainer = document.createElement('div');
    levelsContainer.className = 'level-config-items';
    
    // å®‰å…¨åœ°ç”Ÿæˆå„å±‚é…ç½®è¾“å…¥
    for (let level = 1; level <= shelfConfigData.levels; level++) {
        const levelItem = document.createElement('div');
        levelItem.className = 'level-item';
        
        // å®‰å…¨åœ°è·å–æ¯å±‚çš„åº“ä½æ•°
        const slotCount = (level - 1 < shelfConfigData.slotsPerLevel.length) 
            ? shelfConfigData.slotsPerLevel[level-1] 
            : this.shelfConfig.slotsPerLevel;
            
        levelItem.innerHTML = `
            <label style="min-width: 60px;">ç¬¬${level}å±‚:</label>
            <input type="number" id="shelf-${shelfLetter}-level-${level}" 
                   min="1" value="${slotCount}">
        `;
        levelsContainer.appendChild(levelItem);
    }
    
    configContainer.appendChild(levelsContainer);
    
    // æ·»åŠ å±‚æ•°å˜åŒ–äº‹ä»¶
    const levelsInput = document.getElementById(`shelf-${shelfLetter}-levels`);
    if (levelsInput) {
        levelsInput.addEventListener('change', (e) => {
            this.updateShelfLevels(shelfLetter, parseInt(e.target.value));
            this.updateShelfPreview();
        });
    }
    
    // æ·»åŠ å„å±‚åº“ä½æ•°é‡å˜åŒ–çš„ç›‘å¬
    setTimeout(() => {
        for (let level = 1; level <= shelfConfigData.levels; level++) {
            const slotInput = document.getElementById(`shelf-${shelfLetter}-level-${level}`);
            if (slotInput) {
                slotInput.addEventListener('change', () => {
                    this.updateShelfPreview();
                });
            }
        }
    }, 100);
}

            
            // ä¿®å¤ updateShelfLevels æ–¹æ³•
updateShelfLevels(shelfLetter, newLevelCount) {
    if (!this.shelfConfig.individualConfig[shelfLetter]) {
        this.shelfConfig.individualConfig[shelfLetter] = {
            levels: newLevelCount,
            slotsPerLevel: Array(newLevelCount).fill(this.shelfConfig.slotsPerLevel)
        };
    } else {
        const currentConfig = this.shelfConfig.individualConfig[shelfLetter];
        
        // ç¡®ä¿ slotsPerLevel æ˜¯æ•°ç»„
        if (!Array.isArray(currentConfig.slotsPerLevel)) {
            currentConfig.slotsPerLevel = Array(currentConfig.levels || this.shelfConfig.levelsPerShelf)
                .fill(this.shelfConfig.slotsPerLevel);
        }
        
        const currentLevels = currentConfig.levels;
        
        if (newLevelCount > currentLevels) {
            // å¢åŠ å±‚æ•°
            for (let i = currentLevels; i < newLevelCount; i++) {
                currentConfig.slotsPerLevel.push(this.shelfConfig.slotsPerLevel);
            }
        } else if (newLevelCount < currentLevels) {
            // å‡å°‘å±‚æ•°
            currentConfig.slotsPerLevel = currentConfig.slotsPerLevel.slice(0, newLevelCount);
        }
        
        currentConfig.levels = newLevelCount;
    }
    
    // æ›´æ–°ç•Œé¢
    this.updateShelfSpecificConfig(shelfLetter);
}
            
            // ä¿®æ”¹ applyGlobalConfig æ–¹æ³•ï¼Œæ›´æ–°é¢„è§ˆ
applyGlobalConfig() {
    const newShelfCount = parseInt(document.getElementById('global-shelf-count').value);
    const newLevelsPerShelf = parseInt(document.getElementById('global-levels-per-shelf').value);
    const newSlotsPerLevel = parseInt(document.getElementById('global-slots-per-level').value);
    
    this.shelfConfig.shelfCount = newShelfCount;
    this.shelfConfig.levelsPerShelf = newLevelsPerShelf;
    this.shelfConfig.slotsPerLevel = newSlotsPerLevel;
    
    // é‡ç½®å•ä¸ªè´§æ¶é…ç½®
    this.shelfConfig.individualConfig = {};
    
    // æ›´æ–°ç•Œé¢
    this.openShelfConfigModal();
    alert('å…¨å±€é…ç½®å·²åº”ç”¨');
    // æ›´æ–°é¢„è§ˆ
    this.updateShelfPreview();
}
            
            saveShelfConfiguration() {
               // ä¿å­˜å½“å‰é€‰ä¸­çš„è´§æ¶é…ç½®
                const shelfSelect = document.getElementById('select-shelf');
                const shelfLetter = shelfSelect.value;
    
                if (!this.shelfConfig.individualConfig[shelfLetter]) {
                   this.shelfConfig.individualConfig[shelfLetter] = {
                   levels: this.shelfConfig.levelsPerShelf,
                   slotsPerLevel:               Array(this.shelfConfig.levelsPerShelf).fill(this.shelfConfig.slotsPerLevel)
           };
        }
    
              // è·å–å±‚æ•°
               const levelsInput = document.getElementById(`shelf-${shelfLetter}-levels`);
                const levels = parseInt(levelsInput.value) || this.shelfConfig.levelsPerShelf;
    
             // è·å–å„å±‚åº“ä½æ•°é‡
          const slotsPerLevel = [];
          for (let level = 1; level <= levels; level++) {
          const slotInput = document.getElementById(`shelf-${shelfLetter}-level-${level}`);
           slotsPerLevel.push(parseInt(slotInput.value) || this.shelfConfig.slotsPerLevel);
          }
    
            // æ›´æ–°é…ç½®
          this.shelfConfig.individualConfig[shelfLetter] = {
             levels: levels,
             slotsPerLevel: slotsPerLevel
           };
    
         this.saveShelfConfig();
         this.renderShelves();
          document.getElementById('shelf-config-modal').style.display = 'none';
         alert('è´§æ¶é…ç½®å·²ä¿å­˜');
          }
            // è´§æ¶é…ç½®é¢„è§ˆæ–¹æ³•
// ä¿®å¤ updateShelfPreview æ–¹æ³•
updateShelfPreview() {
    const previewContainer = document.getElementById('shelf-preview');
    if (!previewContainer) {
        console.error('é¢„è§ˆå®¹å™¨æœªæ‰¾åˆ°');
        return;
    }
    
    previewContainer.innerHTML = '';
    
    // è·å–å½“å‰é…ç½®
    const shelfSelect = document.getElementById('select-shelf');
    const currentShelf = shelfSelect ? shelfSelect.value : 'A';
    
    // è·å–å…¨å±€é…ç½®å€¼
    const globalShelfCount = parseInt(document.getElementById('global-shelf-count').value) || this.shelfConfig.shelfCount;
    const globalLevelsPerShelf = parseInt(document.getElementById('global-levels-per-shelf').value) || this.shelfConfig.levelsPerShelf;
    const globalSlotsPerLevel = parseInt(document.getElementById('global-slots-per-level').value) || this.shelfConfig.slotsPerLevel;
    
    console.log('æ›´æ–°é¢„è§ˆ:', {
        globalShelfCount,
        globalLevelsPerShelf, 
        globalSlotsPerLevel,
        currentShelf
    });
    
    // æ˜¾ç¤ºæ‰€æœ‰è´§æ¶çš„é¢„è§ˆï¼Œä½†é«˜äº®å½“å‰é€‰ä¸­çš„è´§æ¶
    for (let shelf = 1; shelf <= globalShelfCount; shelf++) {
        const shelfLetter = String.fromCharCode(64 + shelf);
        
        // å®‰å…¨åœ°è·å–å•ä¸ªè´§æ¶çš„é…ç½®
        let shelfConfigData = this.shelfConfig.individualConfig[shelfLetter];
        
        // ç¡®ä¿é…ç½®æ•°æ®æ˜¯æœ‰æ•ˆçš„å¯¹è±¡
        if (!shelfConfigData || typeof shelfConfigData !== 'object') {
            shelfConfigData = {
                levels: globalLevelsPerShelf,
                slotsPerLevel: Array(globalLevelsPerShelf).fill(globalSlotsPerLevel)
            };
        }
        
        // ç¡®ä¿ slotsPerLevel æ˜¯æ•°ç»„
        if (!Array.isArray(shelfConfigData.slotsPerLevel)) {
            shelfConfigData.slotsPerLevel = Array(shelfConfigData.levels || globalLevelsPerShelf).fill(globalSlotsPerLevel);
        }
        
        // å¦‚æœæ˜¯å½“å‰é€‰ä¸­çš„è´§æ¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å®æ—¶è¾“å…¥çš„å€¼
        if (shelfLetter === currentShelf) {
            const levelsInput = document.getElementById(`shelf-${shelfLetter}-levels`);
            if (levelsInput) {
                const newLevels = parseInt(levelsInput.value);
                if (!isNaN(newLevels)) {
                    shelfConfigData.levels = newLevels;
                    
                    // ç¡®ä¿ slotsPerLevel æ•°ç»„é•¿åº¦ä¸å±‚æ•°åŒ¹é…
                    if (shelfConfigData.slotsPerLevel.length < newLevels) {
                        // å¢åŠ æ•°ç»„é•¿åº¦
                        for (let i = shelfConfigData.slotsPerLevel.length; i < newLevels; i++) {
                            shelfConfigData.slotsPerLevel.push(globalSlotsPerLevel);
                        }
                    } else if (shelfConfigData.slotsPerLevel.length > newLevels) {
                        // å‡å°‘æ•°ç»„é•¿åº¦
                        shelfConfigData.slotsPerLevel = shelfConfigData.slotsPerLevel.slice(0, newLevels);
                    }
                }
            }
            
            // å®‰å…¨åœ°æ›´æ–°å„å±‚çš„åº“ä½æ•°é‡
            for (let level = 1; level <= shelfConfigData.levels; level++) {
                const slotInput = document.getElementById(`shelf-${shelfLetter}-level-${level}`);
                if (slotInput) {
                    const newSlotCount = parseInt(slotInput.value);
                    if (!isNaN(newSlotCount)) {
                        // ç¡®ä¿æ•°ç»„ç´¢å¼•å­˜åœ¨
                        if (level - 1 < shelfConfigData.slotsPerLevel.length) {
                            shelfConfigData.slotsPerLevel[level - 1] = newSlotCount;
                        }
                    }
                }
            }
        }
        
        const shelfElement = document.createElement('div');
        shelfElement.className = `preview-shelf ${shelfLetter === currentShelf ? 'active' : ''}`;
        
        // å®‰å…¨åœ°è®¡ç®—æ€»åº“ä½æ•°
        const totalSlots = Array.isArray(shelfConfigData.slotsPerLevel) 
            ? shelfConfigData.slotsPerLevel.reduce((sum, count) => sum + (count || 0), 0)
            : 0;
            
        const occupiedSlots = this.locationData.filter(item => 
            item.locationCode && item.locationCode.startsWith(shelfLetter)
        ).length;
        
        shelfElement.innerHTML = `
            <div class="preview-shelf-header">
                <span>${shelfLetter}æ¶</span>
                <span>${occupiedSlots}/${totalSlots}</span>
            </div>
            <div class="preview-levels">
        `;
        
        // å®‰å…¨åœ°ç”Ÿæˆå±‚æ•°é¢„è§ˆ
        const levelsToShow = Math.min(shelfConfigData.levels || 0, globalLevelsPerShelf);
        for (let level = 1; level <= levelsToShow; level++) {
            const levelElement = document.createElement('div');
            levelElement.className = 'preview-level';
            
            // å®‰å…¨åœ°è·å–æ¯å±‚çš„åº“ä½æ•°
            const slotsCount = (shelfConfigData.slotsPerLevel && shelfConfigData.slotsPerLevel[level-1]) 
                ? shelfConfigData.slotsPerLevel[level-1] 
                : globalSlotsPerLevel;
                
            const levelOccupied = this.locationData.filter(item => 
                item.locationCode && item.locationCode.startsWith(`${shelfLetter}${level}-`)
            ).length;
            
            let slotsHTML = '';
            const slotsToShow = Math.min(slotsCount, 20); // é™åˆ¶æ˜¾ç¤ºæ•°é‡é¿å…æº¢å‡º
            for (let i = 1; i <= slotsToShow; i++) {
                const slotId = `${shelfLetter}${level}-${i}`;
                const isOccupied = this.locationData.some(item => 
                    item.locationCode && item.locationCode === slotId
                );
                slotsHTML += `<div class="preview-slot ${isOccupied ? 'occupied' : ''}"></div>`;
            }
            
            // å¦‚æœåº“ä½å¤ªå¤šï¼Œæ˜¾ç¤ºçœç•¥å·
            if (slotsCount > 20) {
                slotsHTML += `<div style="font-size: 0.7rem; color: #999;">...${slotsCount - 20}æ›´å¤š</div>`;
            }
            
            levelElement.innerHTML = `
                <div>${level}å±‚: ${levelOccupied}/${slotsCount}</div>
                <div class="preview-slots">
                    ${slotsHTML}
                </div>
            `;
            
            shelfElement.querySelector('.preview-levels').appendChild(levelElement);
        }
        
        shelfElement.innerHTML += '</div>';
        previewContainer.appendChild(shelfElement);
    }
}            
            // æ™ºèƒ½åˆ†æ
            setupAnalysisPage() {
                console.log('æ™ºèƒ½åˆ†æé¡µé¢å·²åŠ è½½');
            }
            
// ä¿®å¤äº‹ä»¶ç»‘å®šæ ‡å¿—é—®é¢˜
fixEventsBoundStructure() {
    // ç¡®ä¿ eventsBound æ˜¯ä¸€ä¸ªå¯¹è±¡è€Œä¸æ˜¯å¸ƒå°”å€¼
    if (typeof this.eventsBound === 'boolean') {
        this.eventsBound = {
            main: this.eventsBound,
            alertsPage: false,
            databasePage: false
        };
    } else if (!this.eventsBound || typeof this.eventsBound !== 'object') {
        this.eventsBound = {
            main: false,
            alertsPage: false,
            databasePage: false
        };
    }
}

// ç¡®ä¿ eventsBound ç»“æ„æ­£ç¡®çš„æ–¹æ³•
    ensureEventsBoundStructure() {
        if (typeof this.eventsBound === 'boolean') {
            console.warn('ä¿®å¤ eventsBound ç»“æ„ï¼šä»å¸ƒå°”å€¼è½¬æ¢ä¸ºå¯¹è±¡');
            this.eventsBound = {
                main: this.eventsBound,
                alertsPage: false,
                databasePage: false,
                inventoryPage: false,
                locationPage: false,
                analysisPage: false,
                settingsPage: false
            };
        } else if (!this.eventsBound || typeof this.eventsBound !== 'object') {
            console.warn('ä¿®å¤ eventsBound ç»“æ„ï¼šé‡æ–°åˆå§‹åŒ–å¯¹è±¡');
            this.eventsBound = {
                main: false,
                alertsPage: false,
                databasePage: false,
                inventoryPage: false,
                locationPage: false,
                analysisPage: false,
                settingsPage: false
            };
        }
        
        // ç¡®ä¿æ‰€æœ‰å¿…è¦çš„å±æ€§éƒ½å­˜åœ¨
        const requiredProps = ['main', 'alertsPage', 'databasePage', 'inventoryPage', 'locationPage', 'analysisPage', 'settingsPage'];
        requiredProps.forEach(prop => {
            if (!(prop in this.eventsBound)) {
                this.eventsBound[prop] = false;
            }
        });
    }

// æ·»åŠ è°ƒè¯•ä¿¡æ¯
    debugEventsBound() {
        console.log('eventsBound çŠ¶æ€:', {
            type: typeof this.eventsBound,
            value: this.eventsBound,
            isObject: typeof this.eventsBound === 'object',
            isBoolean: typeof this.eventsBound === 'boolean'
        });
    }

 // ä¿®æ”¹æ•°æ®åº“ç®¡ç†é¡µé¢è®¾ç½®
 setupDatabasePage() {
    console.log('åˆå§‹åŒ–æ•°æ®åº“ç®¡ç†é¡µé¢...');
    this.setupOperationLogs();
    // ç¡®ä¿ eventsBound ç»“æ„æ­£ç¡®
    this.ensureEventsBoundStructure();
    
    // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
    this.updateConnectionStatus();
    
    // åªåœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ—¶ç»‘å®šäº‹ä»¶
    if (!this.eventsBound.databasePage) {
        console.log('ç»‘å®šæ•°æ®åº“ç®¡ç†é¡µé¢äº‹ä»¶...');
        
        // ç»‘å®šæ•°æ®åº“ç®¡ç†ç›¸å…³äº‹ä»¶
        this.addEventListener('process-inventory-import', 'click', () => this.importInventoryData());
        this.addEventListener('backup-data', 'click', () => this.createBackup());
        this.addEventListener('restore-data', 'click', () => this.showRestoreModal());
        this.addEventListener('export-location-report', 'click', () => this.exportLocationRelationshipsReport());
        this.addEventListener('manage-backups', 'click', () => this.showRestoreModal());
        this.addEventListener('clean-backups', 'click', () => this.cleanupOldBackups());
        this.addEventListener('export-all-data', 'click', () => this.exportAllData());
        
        // æµ‹è¯•è¿æ¥æŒ‰é’®
        this.addEventListener('test-connection', 'click', () => this.testSupabaseConnection());
        
        // æ ‡è®°ä¸ºå·²ç»‘å®š
        this.eventsBound.databasePage = true;
        console.log('æ•°æ®åº“ç®¡ç†é¡µé¢äº‹ä»¶ç»‘å®šå®Œæˆ');
    }
    
    // æ›´æ–°é¡µé¢æ˜¾ç¤º
    this.updateDatabaseStats();
    console.log('æ•°æ®åº“ç®¡ç†é¡µé¢åˆå§‹åŒ–å®Œæˆ');
}

// æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
updateConnectionStatus() {
    const dbStatusElement = document.getElementById('db-status');
    if (!dbStatusElement) return;
    
    if (this.supabase) {
        dbStatusElement.textContent = 'æ•°æ®åº“çŠ¶æ€: å·²è¿æ¥ (Supabase)';
        dbStatusElement.className = 'db-status online';
    } else {
        dbStatusElement.textContent = 'æ•°æ®åº“çŠ¶æ€: æœ¬åœ°æ¨¡å¼ (Supabase æœªè¿æ¥)';
        dbStatusElement.className = 'db-status offline';
    }
}

// è®¾ç½®æ•°æ®åº“é¡µé¢äº‹ä»¶ç›‘å¬
setupDatabaseEventListeners() {
    // æ•°æ®å¯¼å…¥
    this.addEventListener('process-inventory-import', 'click', () => this.importInventoryData());
    
    // å¤‡ä»½æ¢å¤
    this.addEventListener('backup-data', 'click', () => this.createManualBackup());
    this.addEventListener('restore-data', 'click', () => this.showRestoreModal());
    this.addEventListener('export-location-report', 'click', () => this.exportLocationRelationshipsReport());
    
    // é«˜çº§ç®¡ç†
    this.addEventListener('manage-backups', 'click', () => this.showBackupManagement());
    this.addEventListener('clean-backups', 'click', () => this.cleanOldBackups());
    this.addEventListener('export-all-data', 'click', () => this.exportAllData());
}

// æ›´æ–°å¤‡ä»½ç»Ÿè®¡ä¿¡æ¯
updateBackupStats() {
    try {
        const backups = this.getBackupList();
        const autoBackups = backups.filter(b => b.type === 'auto');
        const manualBackups = backups.filter(b => b.type === 'manual');
        
        const autoBackupCount = document.getElementById('auto-backup-count');
        if (autoBackupCount) {
            autoBackupCount.textContent = autoBackups.length;
        }
        
        const manualBackupCount = document.getElementById('manual-backup-count');
        if (manualBackupCount) {
            manualBackupCount.textContent = manualBackups.length;
        }
        
        const lastBackupTime = document.getElementById('last-backup-time');
        if (lastBackupTime) {
            if (backups.length > 0) {
                const latestBackup = backups[0];
                lastBackupTime.textContent = new Date(latestBackup.time).toLocaleString();
            } else {
                lastBackupTime.textContent = 'æ— ';
            }
        }
        
        const totalBackupSize = document.getElementById('total-backup-size');
        if (totalBackupSize) {
            const totalSize = backups.reduce((sum, backup) => sum + (backup.size || 0), 0);
            if (totalSize > 1024 * 1024) {
                totalBackupSize.textContent = `${(totalSize / (1024 * 1024)).toFixed(2)} MB`;
            } else if (totalSize > 1024) {
                totalBackupSize.textContent = `${(totalSize / 1024).toFixed(1)} KB`;
            } else {
                totalBackupSize.textContent = `${totalSize} B`;
            }
        }
        
    } catch (error) {
        console.error('æ›´æ–°å¤‡ä»½ç»Ÿè®¡æ—¶å‡ºé”™:', error);
    }
}
// æ–‡ä»¶å¤§å°æ ¼å¼åŒ–
formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// åˆ›å»ºæ‰‹åŠ¨å¤‡ä»½
createManualBackup() {
    try {
        const backupKey = this.createBackup('manual');
        this.updateBackupStats();
        
        // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
        this.showImportStatus('å¤‡ä»½åˆ›å»ºæˆåŠŸï¼', 'success');
        
        console.log('æ‰‹åŠ¨å¤‡ä»½å®Œæˆ:', backupKey);
    } catch (error) {
        this.showImportStatus('å¤‡ä»½å¤±è´¥: ' + error.message, 'error');
    }
}

// æ˜¾ç¤ºå¯¼å…¥çŠ¶æ€
showImportStatus(message, type = 'info') {
    const statusDiv = document.getElementById('import-status');
    statusDiv.textContent = message;
    statusDiv.className = `import-status ${type}`;
    
    // 3ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 3000);
}

// æ·»åŠ é”™è¯¯æ˜¾ç¤ºæ–¹æ³•
showImportError(message) {
    const importStatus = document.getElementById('import-status');
    if (importStatus) {
        importStatus.innerHTML = `
            <div style="color: #e74c3c;">
                <strong>å¯¼å…¥å¤±è´¥:</strong> ${message}
                <br><small>è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼åé‡è¯•</small>
            </div>
        `;
        importStatus.className = 'import-status error';
        importStatus.style.display = 'block';
    }
    
    // åŒæ—¶ç”¨alertæç¤º
    alert(`å¯¼å…¥å¤±è´¥: ${message}\n\nè¯·æ£€æŸ¥:\n1. æ–‡ä»¶æ˜¯å¦ä¸ºExcelæ ¼å¼\n2. æ–‡ä»¶æ˜¯å¦æŸå\n3. æ–‡ä»¶æ˜¯å¦åŒ…å«æœ‰æ•ˆæ•°æ®`);
}

// æ˜¾ç¤ºå¤‡ä»½ç®¡ç†ç•Œé¢
showBackupManagement() {
    this.showRestoreModal(); // å¤ç”¨æ¢å¤æ¨¡æ€æ¡†æ˜¾ç¤ºå¤‡ä»½ç®¡ç†
}

// æ¸…ç†æ—§å¤‡ä»½
cleanOldBackups() {
    const deletedCount = this.cleanupOldBackups();
    this.updateBackupStats();
    this.showImportStatus(`å·²æ¸…ç† ${deletedCount} ä¸ªæ—§å¤‡ä»½`, 'success');
    return deletedCount;
}

// å¯¼å‡ºæ‰€æœ‰æ•°æ®
exportAllData() {
    try {
        const allData = {
            metadata: {
                exportTime: new Date().toISOString(),
                version: '2.0',
                user: this.currentUser?.username || 'unknown'
            },
            inventoryData: this.inventoryData,
            alertConfig: this.alertConfig,
            locationData: this.locationData,
            shelfConfig: this.shelfConfig,
            backupStats: this.backupStats
        };
        
        const dataStr = JSON.stringify(allData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `inventory_system_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        alert('å…¨é‡æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
        
    } catch (error) {
        alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
        console.error('å¯¼å‡ºæ‰€æœ‰æ•°æ®æ—¶å‡ºé”™:', error);
    }
}


updateBackupStatus() {
    const backups = this.getBackupList();
    const statusDiv = document.getElementById('backup-status');
    if (statusDiv) {
        const autoBackups = backups.filter(b => b.type === 'auto').length;
        const manualBackups = backups.filter(b => b.type === 'manual').length;
        const lastBackup = backups[0];
        
        statusDiv.innerHTML = `
            å¤‡ä»½çŠ¶æ€: è‡ªåŠ¨å¤‡ä»½ ${autoBackups} ä¸ª, æ‰‹åŠ¨å¤‡ä»½ ${manualBackups} ä¸ª
            ${lastBackup ? `, æœ€åå¤‡ä»½: ${new Date(lastBackup.time).toLocaleString()}` : ''}
        `;
    }
}
            
            // ç³»ç»Ÿè®¾ç½®
            setupSettingsPage() {
                console.log('ç³»ç»Ÿè®¾ç½®é¡µé¢å·²åŠ è½½');
               this.setupUserManagement();
            }
            
           // æ›´æ–°æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
// æ›´æ–°æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
updateDatabaseStats() {
    try {
        // æ›´æ–°åº“å­˜è®°å½•æ•°
        const inventoryCount = document.getElementById('inventory-record-count');
        if (inventoryCount) {
            inventoryCount.textContent = this.inventoryData.length;
        }
        
        // æ›´æ–°é¢„è­¦é…ç½®æ•°
        const alertConfigCount = document.getElementById('alert-config-count');
        if (alertConfigCount) {
            alertConfigCount.textContent = this.alertConfig.length;
        }
        
        // æ›´æ–°åº“ä½å…³è”æ•°
        const locationRelationCount = document.getElementById('location-relation-count');
        if (locationRelationCount) {
            locationRelationCount.textContent = this.locationData.length;
        }
        
        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        const lastUpdate = document.getElementById('inventory-last-update');
        if (lastUpdate) {
            lastUpdate.textContent = new Date().toLocaleString();
        }
        
        // æ›´æ–°å¤‡ä»½ç»Ÿè®¡
        this.updateBackupStats();
        
    } catch (error) {
        console.error('æ›´æ–°æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯æ—¶å‡ºé”™:', error);
    }
}            

    // ä¿®å¤åçš„æ•°æ®å¯¼å…¥æ–¹æ³•
// ä¿®å¤å¯¼å…¥åº“å­˜æ•°æ®æ–¹æ³•
importInventoryData() {
    const fileInput = document.getElementById('import-inventory-excel');
    
    if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
        alert('è¯·é€‰æ‹©Excelæ–‡ä»¶');
        return;
    }
    
    const file = fileInput.files[0];
    
    // éªŒè¯æ–‡ä»¶ç±»å‹
    const validTypes = [
        'application/vnd.ms-excel',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    ];
    
    const fileExtension = file.name.split('.').pop().toLowerCase();
    const isValidType = validTypes.includes(file.type) || 
                       ['xls', 'xlsx'].includes(fileExtension);
    
    if (!isValidType) {
        alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„Excelæ–‡ä»¶ (.xls æˆ– .xlsx)');
        return;
    }
    
    // éªŒè¯æ–‡ä»¶å¤§å° (æœ€å¤§10MB)
    if (file.size > 10 * 1024 * 1024) {
        alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
        return;
    }
    
    console.log('å¼€å§‹å¯¼å…¥æ–‡ä»¶:', {
        name: file.name,
        type: file.type,
        size: file.size,
        lastModified: new Date(file.lastModified)
    });
    
    // è°ƒç”¨å¤„ç†å‡½æ•°
    this.processInventoryImport(file);
}


// å¤„ç†åº“å­˜æ•°æ®å¯¼å…¥
// ä¿®å¤ processInventoryImport æ–¹æ³•
async processInventoryImport(file) {
    try {
        const importBtn = document.getElementById('process-inventory-import');
        const originalText = importBtn.textContent;
        importBtn.textContent = 'å¯¼å…¥ä¸­...';
        importBtn.disabled = true;

        const importStatus = document.getElementById('import-status');
        if (importStatus) {
            importStatus.textContent = 'æ­£åœ¨è¯»å–Excelæ–‡ä»¶...';
            importStatus.className = 'import-status info';
            importStatus.style.display = 'block';
        }

        console.log('å¼€å§‹å¯¼å…¥åº“å­˜æ•°æ®...');
        
        // è¯»å–Excelæ–‡ä»¶
        const data = await this.readExcelFileEnhanced(file);
        console.log('ExcelåŸå§‹æ•°æ®:', data);
        
        if (importStatus) {
            importStatus.textContent = `æˆåŠŸè¯»å– ${data.length} æ¡è®°å½•ï¼Œæ­£åœ¨å¤„ç†æ•°æ®...`;
        }

        // å¤„ç†é‡å¤æ•°æ®
        const processedData = this.processDuplicateInventoryData(data);
        
        if (processedData.length === 0) {
            throw new Error('æ²¡æœ‰æœ‰æ•ˆçš„åº“å­˜æ•°æ®å¯å¯¼å…¥');
        }
        
        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        this.showDebugInfo(data, processedData);
        
        if (importStatus) {
            importStatus.textContent = `æ•°æ®å¤„ç†å®Œæˆï¼Œæ­£åœ¨æ›´æ–°åº“å­˜...`;
        }

        // æ›´æ–°åº“å­˜æ•°æ® - åˆå¹¶åˆ°ç°æœ‰æ•°æ®ï¼Œè€Œä¸æ˜¯æ›¿æ¢
        this.mergeInventoryData(processedData);
        
        if (importStatus) {
            importStatus.textContent = `åº“å­˜æ›´æ–°å®Œæˆï¼Œæ­£åœ¨ä¿å­˜...`;
        }

        // ä¿å­˜åˆ°å­˜å‚¨
        await this.saveToStorage();
        
        // æ›´æ–°UI
        this.renderInventoryList();
        this.onInventoryDataChanged();
        
        if (importStatus) {
            importStatus.textContent = `åº“å­˜æ•°æ®å¯¼å…¥æˆåŠŸï¼å…±æ›´æ–° ${processedData.length} æ¡è®°å½•`;
            importStatus.className = 'import-status success';
        }
        
        alert(`åº“å­˜æ•°æ®å¯¼å…¥æˆåŠŸï¼\nå…±å¤„ç† ${processedData.length} æ¡è®°å½•\nå½“å‰æ€»åº“å­˜è®°å½•: ${this.inventoryData.length} æ¡`);
        
    } catch (error) {
        console.error('å¤„ç†åº“å­˜å¯¼å…¥å¤±è´¥:', error);
        
        const importStatus = document.getElementById('import-status');
        if (importStatus) {
            importStatus.textContent = `å¯¼å…¥å¤±è´¥: ${error.message}`;
            importStatus.className = 'import-status error';
        }
        
        alert('å¯¼å…¥å¤±è´¥: ' + error.message);
    } finally {
        const importBtn = document.getElementById('process-inventory-import');
        if (importBtn) {
            importBtn.textContent = 'å¯¼å…¥åº“å­˜æ•°æ®';
            importBtn.disabled = false;
        }
    }
}

// æ·»åŠ é‡å¤æ•°æ®å¤„ç†æ–¹æ³•
// ä¿®å¤ processDuplicateInventoryData æ–¹æ³•
processDuplicateInventoryData(data) {
    const modelUserMap = new Map();
    const processedData = [];
    let duplicateCount = 0;
    let mergedCount = 0;
    let skippedCount = 0;
    
    console.log('å¼€å§‹å¤„ç†é‡å¤æ•°æ®ï¼ŒåŸå§‹æ•°æ®:', data);
    
    data.forEach((item, index) => {
        // è°ƒè¯•ï¼šæ‰“å°æ¯æ¡è®°å½•çš„ç»“æ„
        console.log(`å¤„ç†ç¬¬ ${index + 1} æ¡è®°å½•:`, item);
        
        // æ›´å®½æ¾çš„å‹å·æ£€æŸ¥
        let model = item.model || item.å‹å· || item['å‹å·'] || item.MODEL || item.Model;
        
        // å¦‚æœè¿˜æ²¡æœ‰æ‰¾åˆ°å‹å·ï¼Œå°è¯•ä»å…¶ä»–å¯èƒ½å­—æ®µè·å–
        if (!model) {
            // æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„å­—æ®µ
            for (const key in item) {
                if (typeof item[key] === 'string' && 
                    (key.toLowerCase().includes('model') || 
                     key.toLowerCase().includes('å‹å·'))) {
                    model = item[key];
                    break;
                }
            }
        }
        
        // å¦‚æœä»ç„¶æ²¡æœ‰å‹å·ï¼Œæ‰è·³è¿‡
        if (!model || model.toString().trim() === '') {
            console.warn(`è·³è¿‡ç¼ºå°‘å‹å·çš„è®°å½•:`, item);
            skippedCount++;
            return;
        }
        
        // æ¸…ç†å‹å·æ•°æ®
        model = model.toString().trim();
        
        const key = `${model}_${this.currentUser?.id || 'local-user'}`;
        
        if (modelUserMap.has(key)) {
            // å¤„ç†é‡å¤è®°å½• - åˆå¹¶æ•°é‡
            duplicateCount++;
            const existingItem = modelUserMap.get(key);
            
            // åˆå¹¶åº“å­˜æ•°é‡
            existingItem.stockQty = (parseInt(existingItem.stockQty) || 0) + (parseInt(item.stockQty) || 0);
            existingItem.availableQty = (parseInt(existingItem.availableQty) || 0) + (parseInt(item.availableQty) || 0);
            
            // æ›´æ–°å…¶ä»–å­—æ®µï¼ˆä½¿ç”¨æœ€æ–°çš„å€¼ï¼‰
            if (item.brand || item.å“ç‰Œ) existingItem.brand = item.brand || item.å“ç‰Œ;
            if (item.name || item.å“å) existingItem.name = item.name || item.å“å;
            if (item.orderNumber || item.è®¢è´§å·) existingItem.orderNumber = item.orderNumber || item.è®¢è´§å·;
            if (item.clientName || item.å®¢æˆ·åç§°) existingItem.clientName = item.clientName || item.å®¢æˆ·åç§°;
            
            console.log(`åˆå¹¶é‡å¤è®°å½•: ${model}, æ€»åº“å­˜: ${existingItem.stockQty}`);
            mergedCount++;
            
        } else {
            // æ–°è®°å½• - æ ‡å‡†åŒ–å­—æ®µå
            const processedItem = {
                brand: item.brand || item.å“ç‰Œ || '',
                name: item.name || item.å“å || '',
                model: model,
                orderNumber: item.orderNumber || item.è®¢è´§å· || '',
                clientName: item.clientName || item.å®¢æˆ·åç§° || '',
                stockQty: parseInt(item.stockQty || item.åº“å­˜æ•°é‡) || 0,
                availableQty: parseInt(item.availableQty || item.å¯ç”¨æ•°é‡) || 0,
                purchasePrice: parseFloat(item.purchasePrice || item.é‡‡è´­ä»·æ ¼) || 0,
                stockValue: parseFloat(item.stockValue || item.åº“å­˜é‡‘é¢) || 0,
                warehouse: item.warehouse || item.ä»“åº“ || '',
                stockType: item.stockType || item.åº“å­˜ç±»å‹ || '',
                shelf: item.shelf || item.è´§æ¶ || '',
                entryDate: item.entryDate || item.å…¥åº“æ—¥æœŸ || ''
            };
            
            modelUserMap.set(key, processedItem);
            processedData.push(processedItem);
            
            console.log(`æ·»åŠ æ–°è®°å½•: ${model}`, processedItem);
        }
    });
    
    console.log(`æ•°æ®å¤„ç†ç»Ÿè®¡: åŸå§‹ ${data.length} æ¡, å¤„ç†å ${processedData.length} æ¡, é‡å¤ ${duplicateCount} æ¡, è·³è¿‡ ${skippedCount} æ¡`);
    
    if (duplicateCount > 0 || skippedCount > 0) {
        alert(`æ•°æ®å¤„ç†å®Œæˆ:\n- åŸå§‹è®°å½•: ${data.length} æ¡\n- æœ‰æ•ˆè®°å½•: ${processedData.length} æ¡\n- åˆå¹¶é‡å¤: ${duplicateCount} æ¡\n- è·³è¿‡æ— æ•ˆ: ${skippedCount} æ¡`);
    }
    
    return processedData;
}


// æ·»åŠ å¯¼å…¥é€‰é¡¹å¤„ç†æ–¹æ³•
showImportOptions(originalData, processedData) {
    const modalHtml = `
        <div class="modal" id="import-options-modal" style="display: flex;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>å¯¼å…¥é€‰é¡¹</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div>
                    <h4>æ•°æ®ç»Ÿè®¡</h4>
                    <div style="margin: 15px 0;">
                        <p>åŸå§‹è®°å½•æ•°: ${originalData.length}</p>
                        <p>å¤„ç†åè®°å½•æ•°: ${processedData.length}</p>
                        <p>é‡å¤è®°å½•æ•°: ${originalData.length - processedData.length}</p>
                    </div>
                    
                    <h4>å¤„ç†é€‰é¡¹</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center;">
                            <input type="radio" name="import-option" value="merge" checked> 
                            <span style="margin-left: 8px;">åˆå¹¶é‡å¤è®°å½•ï¼ˆæ¨èï¼‰</span>
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="radio" name="import-option" value="skip"> 
                            <span style="margin-left: 8px;">è·³è¿‡é‡å¤è®°å½•</span>
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="radio" name="import-option" value="overwrite"> 
                            <span style="margin-left: 8px;">è¦†ç›–ç°æœ‰è®°å½•</span>
                        </label>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button id="confirm-import" class="btn-sm">ç¡®è®¤å¯¼å…¥</button>
                        <button class="btn-sm close-modal">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    document.getElementById('confirm-import').addEventListener('click', () => {
        const option = document.querySelector('input[name="import-option"]:checked').value;
        this.finalizeImport(processedData, option);
        document.getElementById('import-options-modal').style.display = 'none';
    });
}

// æœ€ç»ˆå¯¼å…¥æ–¹æ³•
finalizeImport(processedData, option) {
    if (option === 'merge') {
        this.inventoryData = processedData;
    } else if (option === 'skip') {
        // è·³è¿‡é‡å¤è®°å½•çš„é€»è¾‘
        this.handleSkipDuplicates(processedData);
    } else if (option === 'overwrite') {
        // è¦†ç›–ç°æœ‰è®°å½•çš„é€»è¾‘
        this.handleOverwrite(processedData);
    }
    
    this.saveToStorage();
    this.renderInventoryList();
    this.onInventoryDataChanged();
    
    alert(`å¯¼å…¥å®Œæˆï¼å…±å¯¼å…¥ ${processedData.length} æ¡è®°å½•`);
}

// æ·»åŠ æ–‡ä»¶éªŒè¯æ–¹æ³•
validateExcelFile(file) {
    return new Promise((resolve, reject) => {
        // åŸºæœ¬éªŒè¯
        if (!file) {
            reject(new Error('æœªé€‰æ‹©æ–‡ä»¶'));
            return;
        }
        
        if (!(file instanceof Blob) && !(file instanceof File)) {
            reject(new Error('æ— æ•ˆçš„æ–‡ä»¶å¯¹è±¡'));
            return;
        }
        
        // æ–‡ä»¶ç±»å‹éªŒè¯
        const validExtensions = ['xls', 'xlsx'];
        const validTypes = [
            'application/vnd.ms-excel',
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        ];
        
        const fileExtension = file.name.split('.').pop().toLowerCase();
        const isValidExtension = validExtensions.includes(fileExtension);
        const isValidType = validTypes.includes(file.type) || file.type === '';
        
        if (!isValidExtension && !isValidType) {
            reject(new Error('è¯·é€‰æ‹©æœ‰æ•ˆçš„Excelæ–‡ä»¶ (.xls æˆ– .xlsx)'));
            return;
        }
        
        // æ–‡ä»¶å¤§å°éªŒè¯ (10MB)
        if (file.size > 10 * 1024 * 1024) {
            reject(new Error('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB'));
            return;
        }
        
        // ç©ºæ–‡ä»¶æ£€æŸ¥
        if (file.size === 0) {
            reject(new Error('æ–‡ä»¶ä¸ºç©º'));
            return;
        }
        
        resolve(file);
    });
}

// åˆå¹¶åº“å­˜æ•°æ®æ–¹æ³•
mergeInventoryData(newData) {
    const existingMap = new Map();
    
    // å°†ç°æœ‰æ•°æ®æ·»åŠ åˆ°æ˜ å°„
    this.inventoryData.forEach(item => {
        if (item.model) {
            const key = `${item.model}_${this.currentUser?.id || 'local-user'}`;
            existingMap.set(key, item);
        }
    });
    
    // åˆå¹¶æ–°æ•°æ®
    newData.forEach(newItem => {
        if (newItem.model) {
            const key = `${newItem.model}_${this.currentUser?.id || 'local-user'}`;
            
            if (existingMap.has(key)) {
                // æ›´æ–°ç°æœ‰è®°å½•
                const existingItem = existingMap.get(key);
                Object.assign(existingItem, newItem);
            } else {
                // æ·»åŠ æ–°è®°å½•
                existingMap.set(key, newItem);
            }
        }
    });
    
    // æ›´æ–°åº“å­˜æ•°æ®
    this.inventoryData = Array.from(existingMap.values());
    
    console.log('åº“å­˜æ•°æ®åˆå¹¶å®Œæˆ:', {
        åŸæœ‰è®°å½•: this.inventoryData.length - newData.length,
        æ–°å¢è®°å½•: newData.length,
        æ€»è®°å½•: this.inventoryData.length
    });
}

// å¢å¼ºçš„Excelè¯»å–æ–¹æ³•
async readExcelFileEnhanced(file) {
    try {
        const validFile = await this.validateExcelFile(file);
        
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { 
                        type: 'array',
                        cellDates: true,
                        cellStyles: true
                    });
                    
                    if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                        reject(new Error('Excelæ–‡ä»¶ä¸­æ²¡æœ‰å·¥ä½œè¡¨'));
                        return;
                    }
                    
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        header: 1,
                        defval: '',
                        raw: false
                    });
                    
                    if (!jsonData || jsonData.length <= 1) {
                        reject(new Error('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æœ‰æ•ˆæ•°æ®'));
                        return;
                    }
                    
                    // è°ƒè¯•ï¼šæ‰“å°æ ‡é¢˜è¡Œ
                    const headers = jsonData[0];
                    console.log('Excelæ ‡é¢˜è¡Œ:', headers);
                    
                    const dataRows = jsonData.slice(1);
                    const processedData = dataRows.map((row, rowIndex) => {
                        const item = {};
                        headers.forEach((header, index) => {
                            if (header && header.toString().trim() !== '' && row[index] !== undefined) {
                                const fieldName = this.mapChineseHeaderToField(header);
                                item[fieldName] = row[index];
                                
                                // è°ƒè¯•ç‰¹å®šè¡Œ
                                if (rowIndex < 3) { // åªæ‰“å°å‰3è¡Œè°ƒè¯•ä¿¡æ¯
                                    console.log(`è¡Œ ${rowIndex + 1}: ${header} -> ${fieldName} = ${row[index]}`);
                                }
                            }
                        });
                        return item;
                    }).filter(item => Object.keys(item).length > 0);
                    
                    console.log('Excelæ•°æ®è¯»å–å®Œæˆ:', {
                        æ ‡é¢˜è¡Œ: headers,
                        æ€»è¡Œæ•°: jsonData.length,
                        æ•°æ®è¡Œæ•°: dataRows.length,
                        æœ‰æ•ˆè®°å½•: processedData.length,
                        å‰3æ¡è®°å½•: processedData.slice(0, 3)
                    });
                    
                    resolve(processedData);
                    
                } catch (error) {
                    reject(new Error('Excelæ–‡ä»¶è§£æå¤±è´¥: ' + error.message));
                }
            };
            
            reader.onerror = () => {
                reject(new Error('æ–‡ä»¶è¯»å–é”™è¯¯'));
            };
            
            reader.readAsArrayBuffer(validFile);
        });
        
    } catch (error) {
        throw error;
    }
}



// ä¸­æ–‡åˆ—ååˆ°å­—æ®µåçš„æ˜ å°„
mapChineseHeaderToField(chineseHeader) {
    const mapping = {
        // ä¸­æ–‡å­—æ®µæ˜ å°„
        'å“ç‰Œ': 'brand',
        'å“å': 'name', 
        'å‹å·': 'model',
        'è®¢è´§å·': 'orderNumber',
        'å®¢æˆ·åç§°': 'clientName',
        'åº“å­˜æ•°é‡': 'stockQty',
        'å¯ç”¨æ•°é‡': 'availableQty',
        'é‡‡è´­ä»·æ ¼': 'purchasePrice',
        'åº“å­˜é‡‘é¢': 'stockValue',
        'ä»“åº“': 'warehouse',
        'åº“å­˜ç±»å‹': 'stockType',
        'è´§æ¶': 'shelf',
        'å…¥åº“æ—¥æœŸ': 'entryDate',
        'ç³»åˆ—': 'series',
        
        // å¯èƒ½çš„å˜ä½“
        'äº§å“å‹å·': 'model',
        'äº§å“åç§°': 'name',
        'äº§å“å“ç‰Œ': 'brand',
        'å®¢æˆ·å': 'clientName',
        'å®¢æˆ·': 'clientName',
        'æ•°é‡': 'stockQty',
        'åº“å­˜': 'stockQty',
        'ä»·æ ¼': 'purchasePrice',
        'é‡‘é¢': 'stockValue',
        'åº“ä½': 'warehouse',
        'æ—¥æœŸ': 'entryDate'
    };
    
    // æ¸…ç†å­—æ®µå
    const cleanHeader = chineseHeader.toString().trim().replace(/\s+/g, '');
    return mapping[cleanHeader] || chineseHeader;
}

// æ·»åŠ æ•°æ®æ¸…ç†æ–¹æ³•
cleanInventoryData(data) {
    return data.map(item => {
        // ç¡®ä¿æ‰€æœ‰å¿…è¦å­—æ®µéƒ½æœ‰å€¼
        const cleanedItem = {
            brand: item.brand || '',
            name: item.name || '',
            model: item.model || '',
            orderNumber: item.orderNumber || '',
            clientName: item.clientName || '',
            stockQty: parseInt(item.stockQty) || 0,
            availableQty: parseInt(item.availableQty) || 0,
            purchasePrice: parseFloat(item.purchasePrice) || 0,
            stockValue: parseFloat(item.stockValue) || 0,
            warehouse: item.warehouse || '',
            stockType: item.stockType || '',
            shelf: item.shelf || '',
            entryDate: item.entryDate || ''
        };
        
        // æ¸…ç†å­—ç¬¦ä¸²å­—æ®µ
        Object.keys(cleanedItem).forEach(key => {
            if (typeof cleanedItem[key] === 'string') {
                cleanedItem[key] = cleanedItem[key].toString().trim();
            }
        });
        
        return cleanedItem;
    }).filter(item => item.model && item.model.trim() !== ''); // è¿‡æ»¤æ‰æ²¡æœ‰å‹å·çš„è®°å½•
}


// åœ¨é¡µé¢ä¸Šæ·»åŠ è°ƒè¯•ä¿¡æ¯æ˜¾ç¤º
showDebugInfo(data, processedData) {
    const debugInfo = `
        <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 0.8rem;">
            <h4>è°ƒè¯•ä¿¡æ¯</h4>
            <p>åŸå§‹æ•°æ®æ¡æ•°: ${data.length}</p>
            <p>å¤„ç†åæ¡æ•°: ${processedData.length}</p>
            <p>å­—æ®µæ˜ å°„ç¤ºä¾‹:</p>
            <pre>${JSON.stringify(processedData.slice(0, 3), null, 2)}</pre>
        </div>
    `;
    
    const importStatus = document.getElementById('import-status');
    if (importStatus) {
        importStatus.innerHTML += debugInfo;
    }
}

// Excelæ–‡ä»¶è¯»å–æ–¹æ³•
readExcelFile(file) {
    return new Promise((resolve, reject) => {
        // é¦–å…ˆæ£€æŸ¥æ–‡ä»¶å¯¹è±¡æ˜¯å¦æœ‰æ•ˆ
        if (!file || !(file instanceof Blob)) {
            reject(new Error('æ— æ•ˆçš„æ–‡ä»¶å¯¹è±¡'));
            return;
        }

        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                
                // è½¬æ¢ä¸º JSON æ•°æ®
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                resolve(jsonData);
            } catch (error) {
                reject(new Error('Excel æ–‡ä»¶è§£æå¤±è´¥: ' + error.message));
            }
        };
        
        reader.onerror = function() {
            reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
        };
        
        // ä½¿ç”¨ readAsArrayBuffer è¯»å–æ–‡ä»¶
        reader.readAsArrayBuffer(file);
    });
}

// æ—¥æœŸæ ¼å¼åŒ–æ–¹æ³•
formatDateForStorage(dateValue) {
    if (!dateValue) return '';
    
    try {
        // å¤„ç†Excelæ—¥æœŸåºåˆ—å·
        if (typeof dateValue === 'number') {
            const excelEpoch = new Date(1899, 11, 30);
            const date = new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
            return date.toISOString().split('T')[0];
        }
        
        // å¤„ç†å­—ç¬¦ä¸²æ—¥æœŸ
        const date = new Date(dateValue);
        if (!isNaN(date.getTime())) {
            return date.toISOString().split('T')[0];
        }
        
        return '';
    } catch (error) {
        console.warn('æ—¥æœŸæ ¼å¼åŒ–å¤±è´¥:', dateValue, error);
        return '';
    }
}
            
            // ä¿®æ”¹ç°æœ‰çš„ backupData æ–¹æ³•
backupData() {
    // åˆ›å»ºå®Œæ•´å¤‡ä»½
    const backupData = this.generateCompleteBackup();
    const timestamp = new Date().toISOString().split('T')[0];
    
    // ä¿å­˜åˆ°æœ¬åœ°å†å²
    const backupKey = `${this.backupConfig.backupPrefix}manual_${Date.now()}`;
    this.saveBackupToStorage(backupKey, backupData);
    
    // åŒæ—¶è§¦å‘æ–‡ä»¶ä¸‹è½½
    const dataStr = JSON.stringify(backupData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `inventory_complete_backup_${timestamp}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    // ä¸“é—¨å¯¼å‡ºåº“ä½å…³ç³»
    this.exportLocationRelationshipsReport();
    
    this.updateBackupStatus();
    alert('å®Œæ•´æ•°æ®å¤‡ä»½å®Œæˆï¼ŒåŒ…å«åº“ä½å…³ç³»æŠ¥è¡¨');
}
            
            restoreData() {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';
                
                fileInput.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            const backupData = JSON.parse(e.target.result);
                            
                            if (confirm('ç¡®å®šè¦æ¢å¤å¤‡ä»½æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ã€‚')) {
                                this.inventoryData = backupData.inventoryData || [];
                                this.alertConfig = backupData.alertConfig || [];
                                this.locationData = backupData.locationData || [];
                                this.shelfConfig = backupData.shelfConfig || this.loadShelfConfig();
                                
                                this.saveToStorage();
                                this.updateDatabaseStats();
                                
                                // æ›´æ–°æ‰€æœ‰ç›¸å…³é¡µé¢
                                this.renderInventoryList();
                                this.renderAlertList();
                                this.renderShelves();
                                this.updateDashboardStats();
                                this.renderUrgentItems();
                                
                                alert('æ•°æ®æ¢å¤æˆåŠŸ');
                            }
                        } catch (error) {
                            alert('æ¢å¤å¤±è´¥: ' + error.message);
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                fileInput.click();
            }
            // æ·»åŠ è°ƒè¯•æ–¹æ³•åˆ° InventoryManager ç±»
debugPurchaseSuggestions() {
    console.group('é‡‡è´­å»ºè®®è°ƒè¯•ä¿¡æ¯');
    
    console.log('é¢„è­¦é…ç½®æ•°é‡:', this.alertConfig.length);
    console.log('åº“å­˜æ•°æ®æ•°é‡:', this.inventoryData.length);
    
    this.alertConfig.forEach((config, index) => {
        const currentStock = this.getAlertCurrentStock(config);
        console.log(`é¢„è­¦é…ç½® ${index + 1}:`, {
            å‹å·: config.model,
            æœ€ä½åº“å­˜: config.minStock,
            å½“å‰åº“å­˜: currentStock,
            éœ€è¦é‡‡è´­: currentStock < config.minStock
        });
    });
    
    const suggestions = this.generatePurchaseSuggestions();
    console.log('ç”Ÿæˆçš„é‡‡è´­å»ºè®®:', suggestions);
    
    console.groupEnd();
}
            // FIFOæŠ¥å‘Š
            exportFIFOReport() {
                 // æ£€æŸ¥Excelæ”¯æŒ
                if (!this.excelSupported) {
                    alert('Excelå¯¼å‡ºåŠŸèƒ½å½“å‰ä¸å¯ç”¨ã€‚\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                    return;
                }
                // ç®€åŒ–çš„FIFOæŠ¥å‘Šå¯¼å‡º
                const fifoData = this.inventoryData
                    .filter(item => this.isEarliestBatch(item))
                    .map(item => ({
                        'å“ç‰Œ': item.brand,
                        'å“å': item.name,
                        'å‹å·': item.model,
                        'è®¢è´§å·': item.orderNumber,
                        'åº“å­˜æ•°é‡': item.stockQty,
                        'å…¥åº“æ—¥æœŸ': this.formatDate(item.entryDate),
                        'æ‰€åœ¨ä»“åº“': item.warehouse
                    }));
                
                if (fifoData.length === 0) {
                    alert('æ²¡æœ‰éœ€è¦FIFOç®¡ç†çš„äº§å“');
                    return;
                }
                
                // åˆ›å»ºExcelå·¥ä½œè¡¨
                const worksheet = XLSX.utils.json_to_sheet(fifoData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'FIFOç®¡ç†æŠ¥å‘Š');
                
                // å¯¼å‡ºæ–‡ä»¶
                XLSX.writeFile(workbook, `FIFOåº“å­˜ç®¡ç†æŠ¥å‘Š_${new Date().toISOString().split('T')[0]}.xlsx`);
                
                alert(`FIFOæŠ¥å‘Šå¯¼å‡ºæˆåŠŸï¼Œå…± ${fifoData.length} æ¡è®°å½•`);
            }
            
            // äº§å“è¯¦æƒ…
            showProductDetail(orderNumber) {
                const product = this.inventoryData.find(item => item.orderNumber === orderNumber);
                if (product) {
                    const message = `
äº§å“è¯¦æƒ…:
å“ç‰Œ: ${product.brand || 'æ— '}
å“å: ${product.name || 'æ— '}
å‹å·: ${product.model || 'æ— '}
è®¢è´§å·: ${product.orderNumber || 'æ— '}
åº“å­˜æ•°é‡: ${product.stockQty || 0}
å¯ç”¨æ•°é‡: ${product.availableQty || 0}
å®¢æˆ·: ${product.clientName || 'æœªçŸ¥'}
å…¥åº“æ—¥æœŸ: ${this.formatDate(product.entryDate)}
æ‰€åœ¨ä»“åº“: ${product.warehouse || 'æœªçŸ¥'}
åº“å­˜é‡‘é¢: Â¥${parseFloat(product.stockValue || 0).toLocaleString()}
                    `;
                    alert(message);
                } else {
                    alert('æœªæ‰¾åˆ°äº§å“ä¿¡æ¯');
                }
            }

            // å¤„ç†åº“å­˜æ•°æ®æ›´æ–°
            handleInventoryUpdate(payload) {
                const { eventType, new: newData, old: oldData } = payload;
                
                // è®°å½•æ“ä½œæ—¥å¿—
                this.logOperation(eventType, 'inventory_data', newData?.id || oldData?.id, oldData, newData);
                
                // é‡æ–°åŠ è½½æ•°æ®
                this.loadFromSupabase().then(() => {
                    // æ ¹æ®å½“å‰é¡µé¢æ›´æ–°UI
                    this.updateCurrentPageUI();
                });
            }

            // æ›´æ–°å½“å‰é¡µé¢UI
            updateCurrentPageUI() {
                const currentPage = document.querySelector('.page-content:not(.hidden)').id;
                
                switch(currentPage) {
                    case 'dashboard-page':
                        this.updateDashboardStats();
                        this.renderUrgentItems();
                        break;
                    case 'inventory-page':
                        this.renderInventoryList();
                        break;
                    case 'alerts-page':
                        this.renderAlertList();
                        this.renderPurchaseSuggestions();
                        break;
                    case 'location-page':
                        this.renderShelves();
                        break;
                }
            }
            
            // åœ¨ä¿å­˜æ•°æ®å‰æ£€æŸ¥é‡å¤
            validateDataBeforeSave() {
                const orderNumberUserMap = new Map();
                
                // æ£€æŸ¥åº“å­˜æ•°æ®é‡å¤
                this.inventoryData.forEach((item, index) => {
                    const key = `${item.orderNumber}_${this.currentUser?.id}`;
                    if (orderNumberUserMap.has(key)) {
                        console.warn(`å‘ç°é‡å¤æ•°æ®: è®¢è´§å· ${item.orderNumber} å¯¹ç”¨æˆ· ${this.currentUser?.id}`);
                        // å¯ä»¥é€‰æ‹©åˆå¹¶æ•°æ®æˆ–æç¤ºç”¨æˆ·
                    } else {
                        orderNumberUserMap.set(key, index);
                    }
                });
                
                // æ£€æŸ¥åº“ä½æ•°æ®é‡å¤
                const locationUserMap = new Map();
                this.locationData.forEach((location, index) => {
                    const key = `${location.locationCode}_${this.currentUser?.id}`;
                    if (locationUserMap.has(key)) {
                        console.warn(`å‘ç°é‡å¤åº“ä½: ${location.locationCode} å¯¹ç”¨æˆ· ${this.currentUser?.id}`);
                    } else {
                        locationUserMap.set(key, index);
                    }
                });
            }



        }

// ä¿®å¤çš„æµ‹è¯•è®¤è¯å‡½æ•°
async function testAuth() {
    const testEmail = 'test@inventory.com';
    const testPassword = 'test123456'; // ä½¿ç”¨æ›´å¼ºçš„å¯†ç 
    
    try {
        // åˆå§‹åŒ– Supabase
        const supabase = initializeSupabase();
        
        if (!supabase) {
            console.log('Supabase ä¸å¯ç”¨ï¼Œè·³è¿‡è®¤è¯æµ‹è¯•');
            return false;
        }
        
        console.log('å¼€å§‹è®¤è¯æµ‹è¯•...');
        
        // å…ˆå°è¯•æ³¨å†Œ
        const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
            email: testEmail,
            password: testPassword,
            options: {
                data: {
                    username: 'testuser'
                }
            }
        });
        
        if (signUpError) {
            console.log('æ³¨å†Œå¤±è´¥:', signUpError.message);
            
            // å¦‚æœç”¨æˆ·å·²å­˜åœ¨ï¼Œå°è¯•ç™»å½•
            if (signUpError.message.includes('already registered')) {
                console.log('ç”¨æˆ·å·²å­˜åœ¨ï¼Œå°è¯•ç™»å½•...');
                
                const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({
                    email: testEmail,
                    password: testPassword
                });
                
                if (signInError) {
                    console.log('ç™»å½•å¤±è´¥:', signInError.message);
                    return false;
                } else {
                    console.log('ç™»å½•æˆåŠŸ:', signInData);
                    return true;
                }
            }
            return false;
        } else {
            console.log('æ³¨å†ŒæˆåŠŸ:', signUpData);
            return true;
        }
    } catch (err) {
        console.log('è®¤è¯æµ‹è¯•å¼‚å¸¸:', err);
        return false;
    }
}

// æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
setupErrorHandling() {
    window.addEventListener('error', (event) => {
        console.error('å…¨å±€é”™è¯¯:', event.error);
        this.showErrorNotification('ç³»ç»Ÿå‘ç”Ÿé”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
    });
    
    window.addEventListener('unhandledrejection', (event) => {
        console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
        this.showErrorNotification('æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    });
}

showErrorNotification(message) {
    // ç®€å•çš„é”™è¯¯é€šçŸ¥å®ç°
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #e74c3c;
        color: white;
        padding: 15px;
        border-radius: 5px;
        z-index: 10000;
        max-width: 300px;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        document.body.removeChild(notification);
    }, 5000);
}


// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
    
    // åˆ›å»ºå•ä¾‹å®ä¾‹
    const inventoryManager = new InventoryManager();
    
    // å…¨å±€å¯¼å‡º
    window.inventoryManager = inventoryManager;

    console.log('æ™ºèƒ½åº“å­˜ç®¡ç†ç³»ç»Ÿå·²åŠ è½½å®Œæˆ');
    console.log('ç™»å½•ä¿¡æ¯: ç”¨æˆ·å admin, å¯†ç  password');
    console.log('æ‰€æœ‰åŠŸèƒ½å·²å°±ç»ªï¼ŒåŒ…æ‹¬åº“ä½ç®¡ç†å’Œè´§æ¶é…ç½®');
    
    // æœ€ç»ˆæ£€æŸ¥Excelæ”¯æŒçŠ¶æ€
    setTimeout(() => {
        if (!inventoryManager.excelSupported) {
            console.warn('æ³¨æ„ï¼šExcelå¯¼å…¥/å¯¼å‡ºåŠŸèƒ½ä¸å¯ç”¨');
        }
    }, 2000);
});

</script>
</body>
</html>